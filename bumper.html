<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      LUCKY HOUSIE BUMPER
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&amp;family=Poppins:wght@400;600;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&amp;family=Oswald:wght@400;700&amp;family=Lobster&amp;family=Montserrat:wght@400;700&amp;display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.3/gsap.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js">
    </script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 64 64&#39; width=&#39;64&#39; height=&#39;64&#39; role=&#39;img&#39; aria-label=&#39;Tambola&#39;&gt;&lt;title&gt;Tambola&lt;/title&gt;&lt;defs&gt;&lt;linearGradient id=&#39;cardGrad&#39; x1=&#39;0&#39; y1=&#39;0&#39; x2=&#39;1&#39; y2=&#39;1&#39;&gt;&lt;stop offset=&#39;0&#39; stop-color=&#39;%23fff7e6&#39;/&gt;&lt;stop offset=&#39;1&#39; stop-color=&#39;%23ffd88a&#39;/&gt;&lt;/linearGradient&gt;&lt;linearGradient id=&#39;edgeGrad&#39; x1=&#39;0&#39; y1=&#39;0&#39; x2=&#39;1&#39; y2=&#39;0&#39;&gt;&lt;stop offset=&#39;0&#39; stop-color=&#39;%23ff9f80&#39;/&gt;&lt;stop offset=&#39;1&#39; stop-color=&#39;%23ff6b6b&#39;/&gt;&lt;/radialGradient&gt;&lt;radialGradient id=&#39;ballA&#39; cx=&#39;30%&#39; cy=&#39;30%&#39; r=&#39;80%&#39;&gt;&lt;stop offset=&#39;0&#39; stop-color=&#39;%23fff&#39;/&gt;&lt;stop offset=&#39;1&#39; stop-color=&#39;%236fcf97&#39;/&gt;&lt;/radialGradient&gt;&lt;radialGradient id=&#39;ballB&#39; cx=&#39;30%&#39; cy=&#39;30%&#39; r=&#39;80%&#39;&gt;&lt;stop offset=&#39;0&#39; stop-color=&#39;%23fff&#39;/&gt;&lt;stop offset=&#39;1&#39; stop-color=&#39;%2360a5fa&#39;/&gt;&lt;/radialGradient&gt;&lt;radialGradient id=&#39;ballC&#39; cx=&#39;30%&#39; cy=&#39;30%&#39; r=&#39;80%&#39;&gt;&lt;stop offset=&#39;0&#39; stop-color=&#39;%23fff&#39;/&gt;&lt;stop offset=&#39;1&#39; stop-color=&#39;%23ffb86b&#39;/&gt;&lt;/radialGradient&gt;&lt;linearGradient id=&#39;numGrad&#39; x1=&#39;0&#39; y1=&#39;0&#39; x2=&#39;0&#39; y2=&#39;1&#39;&gt;&lt;stop offset=&#39;0&#39; stop-color=&#39;%23462f9b&#39;/&gt;&lt;stop offset=&#39;1&#39; stop-color=&#39;%232d0f6a&#39;/&gt;&lt;/linearGradient&gt;&lt;filter id=&#39;shadow&#39; x=&#39;-50%&#39; y=&#39;-50%&#39; width=&#39;200%&#39; height=&#39;200%&#39;&gt;&lt;feDropShadow dx=&#39;0&#39; dy=&#39;1&#39; stdDeviation=&#39;1&#39; flood-opacity=&#39;0.15&#39;/&gt;&lt;/filter&gt;&lt;/defs&gt;&lt;rect x=&#39;4&#39; y=&#39;8&#39; width=&#39;40&#39; height=&#39;48&#39; rx=&#39;4&#39; ry=&#39;4&#39; fill=&#39;url(%23cardGrad)&#39; stroke=&#39;%23f0c27b&#39; stroke-width=&#39;1&#39; filter=&#39;url(%23shadow)&#39;/&gt;&lt;path d=&#39;M30 8 H44 V18 L36 18 L30 12 Z&#39; fill=&#39;url(%23edgeGrad)&#39; opacity=&#39;0.95&#39;/&gt;&lt;g transform=&#39;translate(8,14)&#39; stroke=&#39;%23e2b66a&#39; stroke-width=&#39;0.8&#39; fill=&#39;none&#39;&gt;&lt;rect width=&#39;28&#39; height=&#39;28&#39; rx=&#39;2&#39; fill=&#39;none&#39;/&gt;&lt;line x1=&#39;0&#39; y1=&#39;9.333&#39; x2=&#39;28&#39; y2=&#39;9.333&#39;/&gt;&lt;line x1=&#39;0&#39; y1=&#39;18.666&#39; x2=&#39;28&#39; y2=&#39;18.666&#39;/&gt;&lt;line x1=&#39;9.333&#39; y1=&#39;0&#39; x2=&#39;9.333&#39; y2=&#39;28&#39;/&gt;&lt;line x1=&#39;18.666&#39; y1=&#39;0&#39; x2=&#39;18.666&#39; y2=&#39;28&#39;/&gt;&lt;/g&gt;&lt;g transform=&#39;translate(36,28)&#39;&gt;&lt;circle cx=&#39;0&#39; cy=&#39;-6&#39; r=&#39;9&#39; fill=&#39;url(%23ballA)&#39; stroke=&#39;%233fa86b&#39; stroke-width=&#39;0.8&#39;/&gt;&lt;text x=&#39;0&#39; y=&#39;-3.2&#39; font-family=&#39;sans-serif&#39; font-weight=&#39;700&#39; font-size=&#39;9&#39; text-anchor=&#39;middle&#39; fill=&#39;url(%23numGrad)&#39;&gt;7&lt;/text&gt;&lt;/g&gt;&lt;g transform=&#39;translate(46,36)&#39;&gt;&lt;circle cx=&#39;0&#39; cy=&#39;0&#39; r=&#39;10&#39; fill=&#39;url(%23ballB)&#39; stroke=&#39;%231f6fd6&#39; stroke-width=&#39;0.9&#39;/&gt;&lt;text x=&#39;0&#39; y=&#39;3.6&#39; font-family=&#39;sans-serif&#39; font-weight=&#39;700&#39; font-size=&#39;9&#39; text-anchor=&#39;middle&#39; fill=&#39;url(%23numGrad)&#39;&gt;25&lt;/text&gt;&lt;/g&gt;&lt;g transform=&#39;translate(30,42)&#39;&gt;&lt;circle cx=&#39;0&#39; cy=&#39;0&#39; r=&#39;7.5&#39; fill=&#39;url(%23ballC)&#39; stroke=&#39;%23e5922d&#39; stroke-width=&#39;0.9&#39;/&gt;&lt;text x=&#39;0&#39; y=&#39;3&#39; font-family=&#39;sans-serif&#39; font-weight=&#39;700&#39; font-size=&#39;7.5&#39; text-anchor=&#39;middle&#39; fill=&#39;url(%23numGrad)&#39;&gt;48&lt;/text&gt;&lt;/g&gt;&lt;text x=&#39;12&#39; y=&#39;50&#39; font-family=&#39;sans-serif&#39; font-weight=&#39;700&#39; font-size=&#39;7&#39; fill=&#39;%23bb6a1c&#39;&gt;T&lt;/text&gt;&lt;/svg&gt;" />
    <style>
      :root {
       --bg-color-gradient: linear-gradient(0deg, #ffdb00, #00fbff);
      --primary-surface: rgba(255, 255, 255, 0.6); /* Semi-transparent white */
        --secondary-surface: rgba(255, 240, 210, 0.7); /* Lighter semi-transparent orange/yellow */
        --accent-primary: #ff8c42; /* Vibrant Orange */
        --accent-secondary: #ffc857; /* Sunny Yellow */
        --called-color: #f7b267; /* Muted Orange for called numbers */
        --text-primary: #3d405b; /* Dark Slate Blue */
        --text-secondary: #5f6368; /* Dark Grey */
        --text-dark: #2c2c2c; /* Near Black for high contrast */
        
        --font-family-neon: &#39;Roboto&#39;, sans-serif;
        --transition-speed: 0.4s;
        --transition-ease: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        --primary-bg-dash: #2c3e50;
        --secondary-bg-dash: #34495e;
        --accent-color-dash: #1abc9c;
        --muted-color-dash: #7f8c8d;
        --light-text-dash: #ffffee;
    }

    @keyframes pulse-highlight {
        0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
    }
    .last-called-highlight {
        animation: pulse-highlight 1.5s infinite;
        border-color: #ff0000 !important;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; border: none; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--secondary-surface); }
    ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 4px; }

    body {
        font-family: -apple-system, BlinkMacSystemFont, &#34;Segoe UI&#34;, Roboto, Helvetica, Arial, sans-serif, var(--font-family-neon);
        color: var(--text-primary);
        background: var(--bg-color-gradient);
        overflow-x: hidden;
        transition: background-color 0.3s, color 0.3s;
        font-size: 14px;
    }

    body.dashboard-view-active {
      
        background-color: #1d2b40;
        font-family: sans-serif;
        color: var(--light-text-dash);
    }

    .view {
        display: none; 
        width: 100%;
        min-height: 100vh;
    }

    .view.active {
        display: block;
    }

    .overlay-popup, .gamePopDiv {
        position: fixed; z-index: 1000; width: 100%; height: 100%; top: 0; left: 0;
        display: none; align-items: center; justify-content: center; padding: 0.5rem;
        background: rgba(16, 12, 42, 0.85);
        backdrop-filter: blur(8px);
        opacity: 0; visibility: hidden;
        transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
        overflow-y: auto;
    }

    .overlay-popup {
        z-index: 1010; 
    }

    .overlay-popup.active, .gamePopDiv.active { opacity: 1; visibility: visible; }

    .popup-content {
        width: 100%; max-width: 500px;
        background: #00fbff;
        border: 1px solid var(--accent-primary); border-radius: 8px;
        padding: 0; position: relative; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 0 20px rgba(0, 246, 255, 0.4);
        transform: scale(0.95);
        transition: transform var(--transition-speed) var(--transition-ease);
    }
    .overlay-popup.active .popup-content { transform: scale(1); }

    .top-down-notification-popup {
    background: transparent;
    backdrop-filter: none;
    align-items: flex-start;
    padding-top: 4px;
    pointer-events: none;
    height: auto;
    justify-content: center;
    z-index: 10000;
    transform: translateY(-150%);
    transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

.top-down-notification-popup.active {
    transform: translateY(0);
}

.top-down-notification-popup .popup-content {
    max-width: 600px;
    width: 95%;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    margin: 0 auto;
    transform: none !important;
    pointer-events: auto;
    max-height: none;
    overflow-y: visible;
}

.top-down-notification-popup .notification-body {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    flex-wrap: wrap;
}

.top-down-notification-popup .notification-logo img {
    max-width: 45px !important;
    height: auto;
    flex-shrink: 0;
}

.top-down-notification-popup .notification-text-content .popup-title {
    display: none;
}

.top-down-notification-popup .notification-text-content {
    flex-grow: 1;
}

.top-down-notification-popup .notification-text-content p {
    margin: 0;
    line-height: 1.4;
    font-size: 0.85rem;
    text-align: left;
}

.top-down-notification-popup .notification-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.top-down-notification-popup .notification-actions .login-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    margin: 0;
    width: auto;
}

/* Mobile View ke liye Specific Centering Layout */
@media (max-width: 768px) {
    .top-down-notification-popup .notification-body {
        justify-content: center; /* Sabhi items ko center karega */
    }

    .top-down-notification-popup .notification-text-content p {
        text-align: center; /* Text ko center karega */
    }
    
    .top-down-notification-popup .notification-actions {
        width: 100%;
        margin-top: 0.3rem;
        justify-content: center; /* Buttons ko center karega */
    }
}



    .x-button {
        background: transparent; position: absolute; top: 0.5rem; right: 0.5rem;
        cursor: pointer; color: var(--text-secondary); font-size: 1.2rem;
        transition: color 0.3s, transform 0.3s;
        z-index: 10;
    }
    .x-button:hover { color: var(--text-primary); transform: rotate(90deg); }

    .popup-title {
        font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem;
        color: var(--accent-primary); text-shadow: 0 0 8px var(--accent-primary);
    }

    input[type=&#34;text&#34;],
    input[type=&#34;email&#34;],
    input[type=&#34;password&#34;],
    input[type=&#34;tel&#34;],
    input[type=&#34;number&#34;],
    input[type=&#34;datetime-local&#34;],
    input[type=&#34;url&#34;],
    select,
    .agent-inp,
    .searchInp,
    .tableInp {
        width: 100%;
        font-size: 0.9rem;
        padding: 0.7rem 1rem;
        border-radius: 4px;
        text-align: center;
        font-family: var(--font-family-neon);
        background: var(--secondary-surface);
        border: 1px solid var(--accent-primary);
        color: var(--text-primary);
    }
    .dashboard-view .tableInp {
         background-color: white;
         color: var(--text-dark);
         border: 1px solid var(--secondary-bg-dash);
    }


    .login-form input {
        margin-bottom: 0.8rem;
    }

    .login-btn {
        width: 100%; font-size: 0.9rem; padding: 0.7rem 1rem;
        border-radius: 4px; margin-bottom: 0.8rem; text-align: center;
        font-family: var(--font-family-neon);
        background: var(--accent-primary); color: var(--text-dark);
        cursor: pointer; font-weight: 700; transition: box-shadow 0.3s, filter 0.3s;
        letter-spacing: 0.5px;
    }
    .login-btn:hover { box-shadow: 0 0 10px var(--accent-primary); filter: brightness(1.1); }
    .login-btn.secondary { background: var(--accent-secondary); }
    .login-btn.admin { background: #e67e22; }
    .login-btn.agent { background: #3498db; }

    .forgot-password-link {
        display: block;
        text-align: center;
        color: var(--accent-primary);
        margin: 1rem 0 0.5rem 0;
        font-size: 0.85rem;
        text-decoration: none;
        transition: color 0.3s;
    }
    .forgot-password-link:hover {
        color: var(--text-primary);
        text-decoration: underline;
    }

    .agent-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .agent-list a {
        display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem;
        border-radius: 4px; color: var(--text-primary); text-decoration: none;
        font-size: 1rem; font-weight: 600; background: var(--secondary-surface);
        transition: background-color 0.3s, transform 0.3s;
    }
    .agent-list a:hover { background-color: var(--primary-surface); transform: translateX(3px); }
    .agent-list .fab.fa-whatsapp { color: #25D366; font-size: 1.2rem; margin-left: auto; }

    #notification-container {
        position: fixed; top: 10px; right: 2.5%; width: 95%;
        z-index: 9999; display: flex; flex-direction: column; gap: 8px;
    }
    .notification {
        padding: 12px 15px; border-radius: 6px; color: white;
        font-family: sans-serif; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        opacity: 0; transform: translateX(100%);
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .notification.show { opacity: 1; transform: translateX(0); }
    .notification.success { background-color: #2ecc71; }
    .notification.error { background-color: #e74c3c; }
    .notification.info { background-color: #3498db; }

    .neon-view {
    }
    
    .page-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
        width: 95%;
        padding-top: 60px;
        padding-bottom: 120px; /* Increased padding to avoid overlap with new footer */
    }
    .panel {
        background: var(--primary-surface); 
        border: 1px solid var(--accent-primary);
        border-radius: 8px; 
        margin-bottom: 0.1rem;
        
        box-shadow: 0 0 15px rgba(0, 246, 255, 0.2), inset 0 0 8px rgba(0, 246, 255, 0.1);
        opacity: 0; 
        transform: translateY(20px);
        padding: 1rem;
    }
    
    .top-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 998;
        background: #00fbff;
        border-bottom: 2px solid var(--accent-primary);
        box-shadow: 0 5px 15px rgba(0, 246, 255, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0.2rem 1rem;
        opacity: 0;
        transform: translateY(-100%);
        font-family: &#39;Cinzel Decorative&#39;, cursive;
      
    }

    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 999;
        background: #00fbff;
        border-top: 2px solid var(--accent-primary);
        box-shadow: 0 -5px 15px rgba(0, 246, 255, 0.2);
        opacity: 0; 
        transform: translateY(100%);
        padding: 0.3rem 0;
    }

    .game-layout { display: grid; grid-template-columns: 1fr; gap: 0.8rem; }

    @media (min-width: 992px) {
        .game-layout {
            grid-template-columns: 2fr 1fr;
        }
    }

    .panel-title {
        font-size: 1.2rem; font-weight: 700; margin-bottom: 0.8rem;
        color: var(--accent-primary); text-align: center;
        text-shadow: 0 0 1px var(--accent-primary), 0 0 1px var(--accent-primary);
          
    }
    .title-container { display: flex; align-items: center; gap: 0.2rem; justify-content: center; }
    .logo-container { font-size: 1.8rem; color: var(--accent-primary); text-shadow: 0 0 10px var(--accent-primary); animation: pulse-glow 3s infinite ease-in-out; }
    @keyframes pulse-glow { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    .webTitle { font-size: 1.2rem; font-weight: 700; }
    
    .icon-bar { 
        display: flex; 
        gap: 0.2rem;
        justify-content: space-around; 
        flex-wrap: nowrap; 
        width: 100%;
    }
    
  .icon-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.2rem;
    background: rgba(50, 155, 96, 0.6); /* Halki Orange background */
    border: none;
    color: #000000;
    border-radius: 10px; /* Thoda zyada curve */
    padding: 0.4rem 0.2rem;
    font-size: 0.50rem;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    transition: background-color var(--transition-speed) ease, color 0.3s, transform 0.3s;
    flex-grow: 1;
    flex-basis: 0;
    text-align: center;
    margin: 0 4px; /* Buttons ke beech thodi jagah */
}
    .icon-btn:hover {
        background: rgba(210, 96, 255, 0.1);
        color: var(--text-primary);
        transform: translateY(-2px);
    }
    
    .icon-btn i {
        font-size: 1rem;
    }
    
    .timer-status-bar { width: 100%; padding: 0.2rem; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 0.5rem 0.5rem; }
    .info-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.70rem; font-weight: 600; color: var(--text-secondary); }
    .info-item i { font-size: 1rem; color: var(--accent-primary); }
    .info-separator { display: none; }
    .number-board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.4rem; }
    .num-cell {
        aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center;
        background: var(--secondary-surface); border-radius: 4px;
        font-weight: 700; font-size: clamp(1rem, 3.5vw, 1.2rem);
        color: var(--text-secondary); text-shadow: 0 0 3px rgba(176, 168, 224, 0.5);
        transition: background-color 0.5s ease, color 0.5s ease, text-shadow 0.5s ease, transform 0.5s ease;
    }
    .num-cell.called { background: var(--called-color); color: var(--text-dark); text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); transform: scale(1.05); }
    .info-column { display: flex; flex-direction: column; gap: 0.8rem; }
    .called-numbers-list { display: flex; gap: 0.4rem; flex-wrap: wrap; justify-content: center; max-height: 120px; overflow-y: auto; padding: 0.4rem; background: var(--secondary-surface); border-radius: 4px; }
    .called-num-chip { background: green; color: #ffffff; padding: 0.2rem 0.6rem; border-radius: 15px; font-weight: 700; font-size: 0.85rem; }
    
    .search-container { display: flex; margin-bottom: 1rem; gap: 4px; }
    .searchInp {
        flex-grow: 1;
        border-radius: 4px;
        margin: 0;
    }
    .searchInp:focus { box-shadow: 0 0 10px var(--accent-primary); }
    .search-btn { padding: 0 1rem; background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: var(--text-dark); cursor: pointer; border-radius: 4px; font-size: 1rem; font-weight: 700; transition: filter var(--transition-speed) ease; }
    .search-btn:hover { filter: brightness(1.2); }
    
    .ticketDisplayArea { display: flex; flex-direction: column; gap: 1rem; }
    .search-result-group {
        border: 1px solid var(--accent-secondary);
        border-radius: 6px;
        padding: 0.8rem;
        background-color: rgba(255, 0, 160, 0.05);
        position: relative;
    }
    .clear-search-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--accent-secondary);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid white;
        transition: transform 0.2s, background-color 0.2s;
        z-index: 5;
    }
    .clear-search-btn:hover {
        transform: scale(1.1);
        background-color: red;
    }
    .search-result-group .ticket-view {
        margin-bottom: 0.5rem;
    }
    .search-result-group .ticket-view:last-child {
        margin-bottom: 0;
    }


    .panel:has(#bookedTicketsDisplay), .panel:has(#bookingGridContainer) { background: transparent; border: none; box-shadow: none; padding: 0; }
    .panel:has(#bookedTicketsDisplay) .panel-title, .panel:has(#bookingGridContainer) .panel-title { color: #01579b; text-shadow: none; }
    .sheet-view { background-color: #ffffff; border: 1px solid #0277bd; border-radius: 6px; padding: 0.8rem; margin-bottom: 1rem; }
    .sheet-header { color: #01579b; border-bottom: 1px solid #b3e5fc; font-size: 1rem; margin-bottom: 0.8rem; background: none; display: flex; justify-content: space-between; align-items: center; font-weight: 700; padding-bottom: 0.5rem; }
    .sheet-content { display: grid; gap: 0.8rem; grid-template-columns: 1fr !important; }
    .ticket-view { border: 2px solid #0288d1; border-radius: 6px; padding: 0; background-color: #f0faff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
    .ticket-header { padding: 0.4rem 0.6rem; background-color: #b3e5fc; color: #01579b; font-family: sans-serif; font-weight: bold; font-size: 0.8rem; text-shadow: none; margin-bottom: 0; display: flex; justify-content: space-between; align-items: center; }
    .ticket-header span, .ticket-header div { color: #01579b !important; }
    .ticket-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 0; padding: 0.4rem; }
    .ticket-num { background-color: white; border: 1px solid black; color: #212121; aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; font-family: sans-serif; font-weight: bold; font-size: clamp(1rem, 2.2vw, 0.9rem); padding: 0; border-radius: 0; transition: background-color 0.4s ease, color 0.4s ease, transform 0.4s ease; }
    .ticket-num.empty { background-color: #f0faff; border: 1px solid black; }
    .ticket-num.ticked { background-color: #00ffff !important; color: #000000 !important; transform: scale(1.05); text-shadow: none; border: 1px solid #000000; }
    #bookingGridContainer .ticket-view.selected { border-color: #ffeb3b; box-shadow: 0 0 10px #ffeb3b; }
    .ticket-num.winning-strike {
        background-color: var(--called-color) !important;
        color: var(--text-dark) !important;
        transform: scale(1.2) rotate(3deg);
        box-shadow: 0 0 15px 3px var(--called-color);
        border: 2px solid black;
        z-index: 2;
        position: relative;
    }

    .download-pdf-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background-color: var(--accent-color-dash);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        border: 2px solid white;
        transition: transform 0.2s;
    }
    .download-pdf-btn:hover {
        transform: scale(1.1);
    }

    .dividend-table { width: 100%; border-collapse: collapse; }
    .dividend-table th, .dividend-table td { padding: 0.8rem; text-align: left; border-top: 1px solid rgba(255, 0, 160, 0.4); font-size: 0.9rem; vertical-align: top; }
    .dividend-table th { font-weight: 700; color: var(--accent-secondary); font-size: 0.95rem; }
    .dividend-table tbody tr { transition: background-color var(--transition-speed) ease; }
    .dividend-table tbody tr:hover { background-color: rgba(255, 0, 160, 0.1); }
    .dividend-table .winner-info { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
    .dividend-table .winner-details { flex-grow: 1; }
    .dividend-table .winner-details ul { list-style: none; padding: 0; margin: 0; }
    .dividend-table .winner-details li { margin-bottom: 4px; }
    .dividend-table .winner-name { font-weight: 700; color: var(--called-color); }
    .dividend-table .prize-share { font-size: 0.8em; color: var(--text-secondary); font-style: italic; display: block; margin-top: 2px;}
    .dividend-table .winner-info .fa-eye { flex-shrink: 0; margin-left: 10px; cursor: pointer; color: var(--accent-primary); font-size: 1.1rem; transition: transform 0.2s; padding-top: 4px; }
    .dividend-table .winner-info .fa-eye:hover { transform: scale(1.2); }

    /* --- Professional Announcement Styles --- */
    #number-announcement-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        pointer-events: none;
        
        /* Initial state: Hidden and transparent */
        opacity: 0;
        visibility: hidden;
    }

    #number-announcement-overlay::before {
        content: &#39;&#39;;
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 40px;
        
        
    }
    
    #announced-number-display {
        /* This is the ball */
        position: relative;
        width: 60px;
        height: 60px;
        background-color: var(--called-color);
        background-image: radial-gradient(circle at 30% 30%, #ffffff, var(--called-color) 80%);
        color: var(--text-dark);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: &#39;Rajdhani&#39;, sans-serif;
        font-weight: 700;
        font-size: 3rem;
        line-height: 1;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 -3px 5px rgba(0,0,0,0.2);
        border: 3px solid #b3a500;
        pointer-events: auto;
        
        /* Reset any old properties */
        padding: 0;
        text-shadow: none;
    }

    
    #bookingGridContainer { display: flex; flex-direction: column; gap: 1rem; padding: 8px; max-height: 75vh; overflow-y: auto; border-radius: 6px; background-color: #e0f7fa; border: 1px solid #b3e5fc; }
    
    #bookingGridContainer .ticket-view.sold {
        cursor: not-allowed;
        opacity: 1;
        background-color: #ffebee;
        border-color: #ef9a9a;
    }
    #bookingGridContainer .ticket-view.sold .ticket-header {
        background-color: #ffcdd2;
        color: #c62828;
    }
    #bookingGridContainer .ticket-view.sold .ticket-header span,
    #bookingGridContainer .ticket-view.sold .ticket-header div {
        color: #c62828 !important;
    }
    #bookingGridContainer .ticket-view.sold .ticket-num.empty {
        background-color: #ffebee;
    }

    #bookingGridContainer .ticket-view:not(.sold) {
        background-color: #e3f2fd;
        border-color: #90caf9;
    }
    #bookingGridContainer .ticket-view:not(.sold) .ticket-header {
        background-color: #bbdefb;
        color: #1565c0;
    }
     #bookingGridContainer .ticket-view:not(.sold) .ticket-header span,
     #bookingGridContainer .ticket-view:not(.sold) .ticket-header div {
        color: #1565c0 !important;
     }
    #bookingGridContainer .ticket-view:not(.sold) .ticket-num.empty {
        background-color: #e3f2fd;
    }

    .selection-indicator {
        text-align: center;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--called-color);
        padding: 0.5rem 0.8rem;
        margin-top: 1rem;
        border-radius: 4px;
        background: rgba(255, 242, 0, 0.1);
        border: 2px dashed var(--called-color);
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border-color 0.3s ease;
    }
    #bookedTicketsDisplay { max-height: 80vh; overflow-y: auto; padding: 8px; border-radius: 6px; display: flex; flex-direction: column; gap: 1rem; background-color: #e0f7fa; border: 1px solid #b3e5fc; }
    .full-sheet-selector { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; font-weight: 500; cursor: pointer; }
    .full-sheet-selector input { width: 14px; height: 14px; cursor: pointer; }
    .book-now-btn-small { background: var(--accent-primary); color: var(--text-dark); border: none; border-radius: 3px; padding: 2px 6px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: filter 0.2s; }
    .book-now-btn-small:hover { filter: brightness(1.2); }
    .dashboard-view .gameSettingDiv { background: var(--primary-bg-dash); padding: 1px 0 8px 0; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); width: 95%; margin-left: 2.5%; margin-top: 0.2rem; }
    .dashboard-view .gameSettingDiv:first-child { margin-top: 1rem; }
    .dashboard-view .titleBtn { width: 100%; border: 0; padding: 10px; color: var(--light-text-dash); background: rgba(255, 255, 255, 0.05); border-radius: 6px 6px 0 0; font-weight: bold; text-align: center; font-size: 1rem; }
    .dashboard-view .clickBtn { padding: 8px; color: var(--light-text-dash); border-radius: 6px; border: 0; margin: 2px; cursor: pointer; transition: background-color 0.2s ease; font-size: 0.85rem; }
    .dashboard-view .runBtn { width: 80%; font-weight: bold; border-radius: 6px; background: var(--accent-color-dash); color: var(--light-text-dash); margin: 10px auto; border: 0; display: block; cursor: pointer; font-size: 1.2rem; height: 50px; }
    .dashboard-view .bookFloatBtn { width: 110px; padding: 8px; border-radius: 8px; position: fixed; bottom: 10px; right: 10px; border: 0; background: var(--accent-color-dash); color: var(--light-text-dash); z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.4); cursor: pointer; font-size: 0.85rem; }
    .dashboard-view .actionBtn { margin: 4px; background: var(--accent-color-dash); color: var(--light-text-dash); font-weight: bold; border-radius: 4px; border: 0; cursor: pointer; transition: background-color 0.2s ease; font-size: 0.8rem; height: auto; padding: 8px 4px; flex-grow: 1; }
    .dashboard-view .actionBtn:hover { background: #16a085; }
    .dashboard-view .gameSettingTable { display: block; width: 95%; margin-left: 2.5%; border-collapse: collapse; margin-top: 8px;}
    .dashboard-view .gameSettingTable thead { display: none; }
    .dashboard-view .gameSettingTable tbody, .dashboard-view .gameSettingTable tr { display: block; text-align: left; }
    .dashboard-view .gameSettingTable tr { border-bottom: 2px solid var(--secondary-bg-dash); margin-bottom: 1px; padding-bottom: 1px; display: grid; grid-template-columns: 2fr 1fr; gap: 0px; align-items: center;}
    .dashboard-view .gameSettingTable1 tr { border-bottom: 2px solid var(--secondary-bg-dash); margin-bottom: 1px; padding-bottom: 1px; display: grid; grid-template-columns: 11fr 2fr; gap: 0px; align-items: center;}

    .dashboard-view .gameSettingTable td { padding: 4px 0px; position: relative; border: none; font-size: 0.9rem; vertical-align: middle; }
    .dashboard-view .gameSettingTable td:first-child { font-weight: bold; color: var(--muted-color-dash); }
    .dashboard-view .gameSettingTable td::before { content: &#39;&#39; !important; }
    .dashboard-view .tableInp {
        margin: 0;
        box-sizing: border-box;
    }
    .dashboard-view .tableCheckbox { width: 20px; height: 20px; vertical-align: middle; accent-color: var(--accent-color-dash); cursor: pointer;}
    #adminDashboardView .searchInp, #agentDashboardView .searchInp {
        margin: 15px auto 0 auto;
        display: block;
        width: 90%;
    }
    .dashboard-view .toggleDiv { display: grid; grid-template-columns: 1fr 1fr; width: 90%; margin: 0 auto; }
    .dashboard-view #showTicketBtn { background: var(--accent-color-dash); }
    .dashboard-view #showAgentBtn { background: var(--secondary-bg-dash); }
    .dashboard-view .actionBtnDiv { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 4px; padding: 8px; }
    .dashboard-view .numBlockDiv { width: 90%; margin: 1rem auto; border: 8px solid silver; display: grid; grid-template-columns: repeat(10, 1fr); }
    .dashboard-view .numBlockDiv .num-cell { font-size: 1rem; color: var(--text-dark); background: #fff;}
    .dashboard-view .numBlockDiv .num-cell.called { background: var(--accent-color-dash); color: white; }
    
    .ticketBlockBtn {
        font-size: 0.9rem; padding: 4px;
        background: white;
        font-weight: bold;
        border: 2px solid silver;
        color: #000;
        cursor: pointer; aspect-ratio: 1/1;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    }
    .ticketBlockBtn:disabled {
        background: #fff200;
        color: #333;
        cursor: not-allowed;
        text-decoration: line-through;
        border-color: #fbc02d;
    }
    .ticketBlockBtn.selected {
        background: var(--accent-color-dash) !important;
        color: var(--light-text-dash) !important;
        border-color: var(--light-text-dash) !important;
    }

    .dashboard-view .bookBtn, .bookBtn { 
        width: 100%; font-size: 1rem; padding: 0.8rem; border: 0; font-weight: bold; 
        display: block; background: var(--accent-color-dash); color: var(--light-text-dash); 
        border-radius: 6px; cursor: pointer;
        transition: filter 0.2s;
    }
    .dashboard-view .bookBtn:hover, .bookBtn:hover {
        filter: brightness(1.1);
    }

    .dashboard-view .runGameTable, .dashboard-view .dividentConDiv { width: 95%; margin: 1rem auto; }
    .dashboard-view .dividentConDiv table { width: 100%; color: var(--light-text-dash); border-collapse: collapse; }
    .dashboard-view .dividentConDiv th, .dashboard-view .dividentConDiv td { padding: 6px; border: 1px solid var(--muted-color-dash); font-size: 0.85rem;}
    
    .gamePopDiv { background: rgba(0, 0, 0, 0.8); }
    .gameDiv {
        position: relative;
        height: 95vh;
        width: 95%;
        background: var(--primary-bg-dash);
        margin: 2.5% auto;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .gamePopDiv .x-button { position: absolute; top: 8px; right: 12px; font-size: 1.5rem; color: white; }
    #agentDashboardView .runBtn { font-size: 1.5rem; }
    #adminGameSettingTable td, #agentSoldTicketsTable td { padding-left: 8px; text-align: left; }
    #adminGameSettingTable td::before, #agentSoldTicketsTable td::before { content: &#39;&#39; !important; }

    .booking-popup-header {
        flex-shrink: 0;
        z-index: 5;
        padding: 0.8rem;
        position: relative;
        border-bottom: 1px solid var(--secondary-bg-dash);
    }
    
    .gamePopDiv .ticketBlockDiv {
        flex-grow: 1;
        overflow-y: auto;
        margin: 0;
        width: 100%;
        max-height: none;
        padding: 8px;
    }

    .bookInpDiv {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
    
    #adminGameSettingTable .booked-ticket-line-1 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        font-size: 1rem;
    }
    #adminGameSettingTable .booked-ticket-line-1 .fa-edit,
    #adminGameSettingTable .booked-ticket-line-1 .fa-trash-alt {
        color: var(--accent-color-dash);
        cursor: pointer;
        transition: transform 0.2s;
    }
    #adminGameSettingTable .booked-ticket-line-1 .fa-trash-alt {
        color: #e74c3c;
        margin-left: 10px;
    }
     #adminGameSettingTable .booked-ticket-line-1 .fa-edit:hover,
     #adminGameSettingTable .booked-ticket-line-1 .fa-trash-alt:hover {
        transform: scale(1.2);
    }
    #adminGameSettingTable .booked-ticket-line-2 {
        font-size: 0.8rem;
        color: var(--muted-color-dash);
        margin-top: 4px;
    }
    #adminGameSettingTable .admin-ticket-row td {
        display: block;
        width: 100%;
        padding: 0;
    }
     #adminGameSettingTable .admin-ticket-row.available-ticket td {
        display: table-cell;
    }
    
    #dividendSettingsTable tr {
        grid-template-columns: 1fr; 
    }
    #dividendSettingsTable td {
        display: flex; 
        align-items: center;
        gap: 10px;
    }
    .dividend-name-text {
        flex-grow: 1; 
        font-weight: 500;
        color: var(--light-text-dash);
    }
    .dividend-amount {
        width: 90px !important; 
        flex-shrink: 0;
        text-align: right !important;
    }

    #genericInfoPopupContent ul {
        list-style-type: none;
        padding-left: 0;
    }
    #genericInfoPopupContent li {
        padding: 8px;
        border-bottom: 1px solid var(--secondary-surface);
    }
    #genericInfoPopupContent li:last-child {
        border-bottom: none;
    }
    #genericInfoPopupContent .winner-dividend {
        font-weight: 700;
        color: var(--accent-primary);
    }
    #genericInfoPopupContent .winner-details {
        font-size: 0.9em;
        color: var(--text-primary);
    }

    #posterContent {
        font-family: &#39;Oswald&#39;, sans-serif;
        color: #ffffff;
        padding: 2rem;
        background-size: cover;
        background-position: center;
        text-align: center;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        transition: background-image 0.5s ease-in-out;
    }
    
    #posterContent [contenteditable=&#34;true&#34;]:hover {
        outline: 2px dashed var(--accent-primary);
        background-color: rgba(0, 246, 255, 0.1);
    }

    #posterContent::before {
        content: &#39;&#39;;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1;
    }

    #posterContent &gt; * {
        position: relative;
        z-index: 2;
    }

   .poster-title {
        font-size: 2em;
        text-transform: uppercase;
        font-weight: 700;
        text-shadow: 3px 3px 5px rgba(0,0,0,0.5);
        margin: 0;
    }

    .poster-datetime {
        font-size: 1.1em;
        font-weight: bold;
        margin-top: -0.1rem;
        color: #ffeb3b;
    }

    .poster-tagline {
        font-size: 1em;
        margin: -0.1rem 0;
    }

    .prize-section {
        margin: 0rem auto;
        padding: 0rem;
        border-radius: 8px;
        max-width: 100%;
    }

    .prize-section h3 {
        text-transform: uppercase;
        letter-spacing: 2px;
        border-bottom: 2px solid #ffeb3b;
        display: inline-block;
        padding-bottom: 5px;
        margin-bottom: 1rem;
    }

    .prize-list {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        text-align: left;
    }

    .prize-column p {
        margin: 0.5rem 0;
        font-size: 1.2em;
    }

    #prize-amounts {
        text-align: right;
        font-weight: bold;
    }

    .ticket-details {
        font-size: 0.9em;
        font-weight: bold;
        background: #ffeb3b;
        color: #000;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        display: inline-block;
        margin: 0;
    }

    .contact-section {
        margin-top: 0.5rem;
        border-top: 1px solid rgba(255,255,255,0.3);
        padding-top: 0;
        display: flex;
        justify-content: space-around;
        align-items: center;
        flex-wrap: wrap;
        gap: 0;
    }

    .contact-section p {
        font-size: 1.1em;
        margin: 0;
    }

    .contact-section a {
        color: #ffffff;
        text-decoration: none;
    }
    .contact-section a:hover {
        text-decoration: underline;
    }

    .gamePopDiv .tableInp, .gamePopDiv .tableInp1 {
        width: 100%;
        font-size: 0.9rem;
        padding: 0.7rem 1rem;
        border-radius: 10px;
        text-align: center;
        font-family: var(--font-family-neon);
        background: var(--secondary-bg-dash);
        border: 1px solid var(--accent-color-dash);
        color: var(--light-text-dash);
        box-sizing: border-box;
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .gamePopDiv .tableInp:focus {
        border-color: var(--accent-color-dash);
        box-shadow: 0 0 8px var(--accent-color-dash);
        outline: none;
    }

    .gamePopDiv select.tableInp {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url(&#34;data:image/svg+xml;charset=UTF-8,%3csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 24 24&#39; fill=&#39;none&#39; stroke=&#39;%231abc9c&#39; stroke-width=&#39;2&#39; stroke-linecap=&#39;round&#39; stroke-linejoin=&#39;round&#39;%3e%3cpolyline points=&#39;6 9 12 15 18 9&#39;%3e%3c/polyline%3e%3c/svg%3e&#34;);
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1em;
        padding-right: 2.5rem;
    }

    .runGameTable button.actionBtn {
        margin: 0 !important;
        height: auto;
        font-size: 1rem;
	    border-radius: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;
    }

    .runGameTable button.actionBtn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
        box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }
    
    .gamePopDiv .ticketBlockDiv {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .compact-sheet-row {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px;
        border-radius: 4px;
        background-color: var(--secondary-bg-dash);
    }

    .compact-sheet-row .sheet-tick-box {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--accent-color-dash);
        flex-shrink: 0;
    }

    .compact-sheet-row .ticket-buttons-group {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 4px;
        flex-grow: 1;
    }

    .gamePopDiv .ticketBlockBtn {
        font-size: 0.8rem;
        padding: 0;
        height: 35px;
        width: 100%;
        aspect-ratio: unset;
        min-width: 35px;
        border-width: 1px;
        line-height: 35px;
    }
    
    /* --- Poster Maker Styles --- */
    #poster-bg-controls {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 8px;
        padding: 8px;
        margin-bottom: 1rem;
        background-color: rgba(0, 0, 0, 0.25);
        border-radius: 8px;
        -webkit-overflow-scrolling: touch;
        border: 1px solid var(--secondary-bg-dash);
    }

    #poster-bg-controls::-webkit-scrollbar {
        height: 5px;
    }
    #poster-bg-controls::-webkit-scrollbar-track {
        background: transparent;
    }
    #poster-bg-controls::-webkit-scrollbar-thumb {
        background: var(--accent-color-dash);
        border-radius: 5px;
    }
    #poster-bg-controls::-webkit-scrollbar-thumb:hover {
        background: #1fe0b8;
    }

    #poster-bg-controls &gt; .actionBtn,
    #poster-bg-controls &gt; span,
    #poster-bg-controls &gt; label.actionBtn {
        flex-shrink: 0;
        margin: 0 !important;
        transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        padding: 6px 12px;
        font-size: 0.85em;
        height: auto;
    }

    #poster-bg-controls &gt; span {
        align-self: center;
        font-weight: 600;
        color: var(--light-text-dash);
    }

    #poster-bg-controls &gt; .actionBtn:hover,
    #poster-bg-controls &gt; label.actionBtn:hover {
        transform: translateY(-2px);
        filter: brightness(1.2);
        box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }

    #poster-bg-controls &gt; .actionBtn.active {
        background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        color: var(--text-dark);
        font-weight: 700;
        transform: scale(1.05) translateY(-2px);
        box-shadow: 0 0 12px var(--accent-primary);
        border-color: var(--light-text-dash);
    }
    
    #poster-bg-controls label.actionBtn {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .poster-actions {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid var(--muted-color-dash);
        margin-top: 15px;
    }

    .poster-actions .actionBtn {
        flex-grow: 1;
        font-size: 1rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .poster-actions .actionBtn:hover {
        transform: translateY(-2px);
        filter: brightness(1.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    /* --- NEW STYLES FOR BOOKING PAGE --- */
    #publicBookingActionFooter {
        position: fixed;
        bottom: 55px; /* Adjust if bottom-nav height changes */
        left: 0;
        width: 100%;
        background: #00fbff;
        padding: 0.8rem;
        box-shadow: 0 -5px 15px rgba(255, 0, 160, 0.2);
        border-top: 2px solid var(--accent-secondary);
        z-index: 998;
        transform: translateY(200%);
        transition: transform 0.4s var(--transition-ease);
    }

    #publicBookingActionFooter.visible {
        transform: translateY(0);
    }

    .booking-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    #publicBookingActionFooter .login-btn {
        margin-bottom: 0;
        padding: 0.7rem;
    }
    #publicBookingActionFooter #publicSelectionIndicator {
        margin: 0;
        padding: 0.5rem;
        min-height: auto;
        font-size: 0.8rem;
        border-width: 1px;
		color: #000000;
    }
    @media (max-width: 600px) {
        .booking-form-row {
            grid-template-columns: 1fr;
            gap: 0.4rem;
            margin-bottom: 0.8rem;
        }
    }
.success-animation {
    margin: 0 auto 1rem auto;
    width: 100px;
    height: 100px;
}

.checkmark {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #ffffff;
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px #2ecc71;
    margin: 0 auto;
    animation: fill_anim 0.4s ease-in-out 0.4s forwards, scale_anim 0.3s ease-in-out 0.9s both;
}

.checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #2ecc71;
    fill: none;
    animation: stroke_anim 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke_anim 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke_anim {
    100% {
        stroke-dashoffset: 0;
    }
}

@keyframes scale_anim {
    0% {
        transform: none;
    }
    20% {
        transform: scale3d(1.1, 1.1, 1);
    }
    40% {
        transform: scale3d(0.9, 0.9, 1);
    }
    60% {
        transform: scale3d(1.03, 1.03, 1);
    }
    80% {
        transform: scale3d(0.97, 0.97, 1);
    }
    100% {
        transform: none;
    }
}

@keyframes fill_anim {
    100% {
        box-shadow: inset 0px 0px 0px 50px #2ecc71;
    }
}

/* --- NEW AGENT LIST CARD STYLES --- */
#adminGameSettingTable.agent-list-view {
    display: block;
}
#adminGameSettingTable.agent-list-view thead {
    display: none;
}
#adminGameSettingTable.agent-list-view tbody,
#adminGameSettingTable.agent-list-view tr.agent-row-card {
    display: block;
    width: 100%;
}
tr.agent-row-card {
    margin-bottom: 0.5rem !important;
    padding: 0 !important;
    border: 1px solid transparent !important;
    border-radius: 6px;
    background-color: var(--secondary-bg-dash);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}
tr.agent-row-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    border-color: var(--accent-color-dash) !important;
}
tr.agent-row-card td {
    display: block;
    padding: 0.8rem !important;
    border: none !important;
}
.agent-card-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    width: 100%;
}
.agent-card-info {
    flex-grow: 1;
    min-width: 0;
}
.agent-card-name {
    font-weight: 700;
    font-size: 1rem;
    color: var(--light-text-dash);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.agent-card-name small {
    font-weight: 400;
    font-size: 0.8em;
    color: var(--muted-color-dash);
    text-transform: capitalize;
}
.agent-card-phone {
    font-size: 0.85rem;
    color: var(--muted-color-dash);
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}
.agent-card-stats {
    display: flex;
    gap: 1rem;
    text-align: center;
    flex-shrink: 0;
}
.agent-stat-item {
    display: flex;
    flex-direction: column;
    min-width: 80px;
}
.agent-stat-item span {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent-color-dash);
}
.agent-stat-item label {
    font-size: 0.7rem;
    color: var(--muted-color-dash);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.agent-card-actions {
    flex-shrink: 0;
    padding-left: 0.5rem;
}
.agent-card-actions .fa-trash-alt {
    color: #e74c3c;
    cursor: pointer;
    font-size: 1.2rem;
    transition: transform 0.2s, color 0.2s;
}
.agent-card-actions .fa-trash-alt:hover {
    transform: scale(1.2);
    color: #ff7675;
}
.agent-card-actions span {
    color: var(--muted-color-dash);
    font-size: 1.2rem;
}

/* NEW AUDIO STYLES */
@keyframes mic-live-glow {
    0% { box-shadow: 0 0 5px #ff4d4d, 0 0 10px #ff4d4d; }
    50% { box-shadow: 0 0 15px #ff7979, 0 0 20px #ff7979; }
    100% { box-shadow: 0 0 5px #ff4d4d, 0 0 10px #ff4d4d; }
}

#micToggleBtn.live {
    background-color: #e74c3c;
    color: white;
    animation: mic-live-glow 1.5s infinite;
}

.music-control-wrapper {
    display: flex;
    gap: 5px;
}
.music-control-wrapper .tableInp {
    flex-grow: 1;
}
.music-control-wrapper .actionBtn {
    width: auto !important;
    flex-grow: 0;
    padding: 0 1rem;
}

#musicPlaylist, #popupMusicPlaylist {
    max-height: 250px;
    overflow-y: auto;
    background: var(--secondary-bg-dash);
    border-radius: 4px;
    padding: 0.5rem;
}
#musicPlaylist {
    margin: 1rem 2.5% 0 2.5%;
    width: 95%;
}
#popupMusicPlaylist {
    padding: 0 0.5rem 0.5rem 0.5rem;
}

.playlist-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-bottom: 1px solid var(--primary-bg-dash);
    color: var(--light-text-dash);
    transition: background-color 0.3s;
}
.playlist-item:last-child {
    border-bottom: none;
}
.playlist-item-name {
    flex-grow: 1;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.playlist-item-actions button {
    background: transparent;
    border: none;
    color: var(--light-text-dash);
    cursor: pointer;
    font-size: 1rem;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    transition: background-color 0.2s, transform 0.2s;
    position: relative; /* For gradient */
    z-index: 1;
}
.playlist-item-actions button:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: scale(1.1);
}
.playlist-item-actions .fa-play-circle { color: var(--accent-color-dash); }
.playlist-item-actions .fa-trash-alt { color: #e74c3c; }

/* NEW Playlist Animation Styles */
@keyframes glowing-gradient-border {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes pulse-icon {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.playlist-item.playing .playlist-item-actions button:first-child::before {
    content: &#39;&#39;;
    position: absolute;
    top: -3px; left: -3px;
    right: -3px; bottom: -3px;
    background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary), #fff200, var(--accent-primary));
    background-size: 400% 400%;
    border-radius: 50%;
    z-index: -1;
    animation: glowing-gradient-border 4s linear infinite;
    filter: blur(4px);
}
.playlist-item.playing .playlist-item-actions button:first-child {
    background-color: var(--primary-bg-dash) !important;
    transform: scale(1.1);
}
.playlist-item.playing .playlist-item-actions .fa-play-circle {
    color: var(--accent-primary);
    animation: pulse-icon 1.5s infinite ease-in-out;
}
    </style>
  </head>
  <body>
    <div id="notification-container">
    </div>
    <div id="publicView" class="view neon-view active">
      <header class="top-header">
        <div class="title-container">
          <div class="logo-container">
            <img src="https://raw.githubusercontent.com/Anandkhuman/Manipurhousietambola2.0/main/lucky.png" alt="Logo" style="height: 40px;" />
          </div>
          <h1 class="webTitle">
            LUCKY HOUSIE BUMPER
          </h1>
        </div>
      </header>
      <div class="page-wrapper">
        <div class="panel">
          <div class="timer-status-bar" id="public-timer-bar" style="border-top: none; padding: 0.5rem; margin: 0;">
          </div>
        </div>
        <main class="game-layout">
          <section class="panel">
            <h2 class="panel-title">
              GAME BOARD
            </h2>
            <div class="number-board" id="numberBoard">
            </div>
          </section>
          <aside class="info-column">
            <section class="panel">
              <h2 class="panel-title">
                CALLED NUMBERS
              </h2>
              <div class="called-numbers-list" id="calledNumbersList">
                <span>                Game has not started...
</span>
              </div>
            </section>
            <section class="panel">
              <h2 class="panel-title">
                MY TICKETS
              </h2>
              <div class="search-container">
                <input type="text" class="searchInp" id="ticketSearchInp" placeholder="Enter name, phone, or ticket ID" />
                <button class="search-btn" id="searchBtn">
                  <i class="fas fa-search"></i>
                </button>
                <button class="search-btn" id="clearAllSearchBtn" title="Clear All Search Results" style="padding: 0 0.8rem;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="ticketDisplayArea" id="ticketDisplayArea">
              </div>
            </section>
            <section class="panel">
              <h2 class="panel-title">
                DIVIDENDS &amp; WINNERS
              </h2>
              <table class="dividend-table" id="dividendListTable">
                <thead>
                  <tr>
                    <th>
                      Dividend Name
                    </th>
                    <th>
                      Winner
                    </th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </section>
            <section class="panel">
              <h2 class="panel-title">
                ALL TICKETS STATUS
              </h2>
              <div id="bookedTicketsDisplay">
              </div>
            </section>
          </aside>
        </main>
      </div>
      <nav class="bottom-nav">
        <div class="icon-bar" id="public-icon-bar">
          <a href="#" id="whatsappGroupLink" target="_blank" class="icon-btn">          <i class="fab fa-whatsapp"></i>
          <span>          Join Group
</span>
</a>
          <a href="#book" id="navigateToBooking" class="icon-btn">          <i class="fas fa-ticket-alt"></i>
          <span>          Book
</span>
</a>
          <button class="icon-btn" id="showAgentsBtn">
            <i class="fas fa-users"></i>
            <span>            Agents
</span>
          </button>
          <button class="icon-btn" id="publicLoginBtn">
            <i class="fas fa-sign-in-alt"></i>
            <span>            Login
</span>
          </button>
          <button class="icon-btn" id="publicLogoutBtn" style="display:none;">
            <i class="fas fa-sign-out-alt"></i>
            <span>            Logout
</span>
          </button>
        </div>
      </nav>
    </div>
    <div id="ticketBookingView" class="view neon-view">
      <header class="top-header">
        <div class="title-container">
          <div class="logo-container">
            <img src="https://raw.githubusercontent.com/Anandkhuman/Manipurhousietambola2.0/main/lucky.png" alt="Logo" style="height: 40px;" />
          </div>
          <h1 class="webTitle">
            LUCKY HOUSIE BUMPER
          </h1>
        </div>
      </header>
      <div class="page-wrapper">
        <div class="panel">
          <div class="timer-status-bar" id="booking-timer-bar" style="border-top: none; padding: 0.5rem; margin: 0;">
          </div>
        </div>
        <section class="panel">
          <h2 class="panel-title">
          </h2>
          <div id="bookingGridContainer">
          </div>
        </section>
      </div>
      <!-- NEW CONDITIONAL BOOKING FOOTER -->
      <div id="publicBookingActionFooter">
        <div class="booking-form-row">
          <input type="text" id="bookerName" placeholder="Your Name" />
          <input type="tel" id="bookerPhone" placeholder="Your Mobile Number" />
          <button class="login-btn" id="requestBookingBtn">
            Request
          </button>
        </div>
        <div id="publicSelectionIndicator" class="selection-indicator">
          Select tickets to see booking options
        </div>
      </div>
      <nav class="bottom-nav">
        <div class="icon-bar" id="booking-icon-bar">
          <a href="#game" id="navigateToGame" class="icon-btn">          <i class="fas fa-gamepad"></i>
          <span>          Game
</span>
</a>
          <button class="icon-btn" id="checkAvailabilityBtn">
            <i class="fas fa-bolt"></i>
            <span>            Check Available
</span>
          </button>
          <button class="icon-btn" id="showAgentListBtn-booking">
            <i class="fas fa-users"></i>
            <span>            Agents
</span>
          </button>
          <button class="icon-btn" id="bookingLoginBtn">
            <i class="fas fa-sign-in-alt"></i>
            <span>            Login
</span>
          </button>
          <button class="icon-btn" id="bookingLogoutBtn" style="display:none;">
            <i class="fas fa-sign-out-alt"></i>
            <span>            Logout
</span>
          </button>
        </div>
      </nav>
    </div>
    <div id="adminDashboardView" class="view dashboard-view">
      <div class="gameSettingDiv">
        <div class="titleBtn">
          ADMIN DASHBOARD
        </div>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          GAME SETTINGS
        </button>
        <table class="gameSettingTable" id="settingsTable">
          <tbody>
            <tr>
              <td>
                Game date-time
              </td>
              <td>
                <input class="tableInp" id="dateTimeInp" type="datetime-local" />
              </td>
            </tr>
            <tr>
              <td>
                Total ticket limit
              </td>
              <td>
                <input class="tableInp" id="totalTicketInp" type="number" value="600" />
              </td>
            </tr>
            <tr>
              <td>
                Ticket price
              </td>
              <td>
                <input class="tableInp" id="ticketPriceInp" type="number" value="300" />
              </td>
            </tr>
            <tr>
              <td>
                Agent commission
              </td>
              <td>
                <input class="tableInp" id="agentCommissionInp" type="number" value="50" />
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <input class="tableInp" id="saveGameBtn" type="button" onclick="saveGameSetting()" value="SAVE SETTINGS" style="background-color: var(--accent-color-dash); color: var(--light-text-dash); cursor: pointer;" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          ACTION BUTTONS
        </button>
        <div class="actionBtnDiv">
          <button class="actionBtn" onclick="resetCallNum()">
            RESET CALL
          </button>
          <button class="actionBtn" onclick="resetTicket()">
            RESET TICKET
          </button>
          <button class="actionBtn" onclick="resetAgent()">
            RESET AGENT
          </button>
          <button class="actionBtn" onclick="showLastSoldTicket()">
            LAST SOLD TICKET
          </button>
          <button class="actionBtn" onclick="showPreviousGameWinners()">
            PREV. GAME WINNERS
          </button>
          <button class="actionBtn" onclick="downloadPreviousGameTicketList()">
            PREV. GAME TICKETS
          </button>
          <button class="actionBtn" onclick="downloadCurrentSoldTickets()">
            DOWNLOAD CURRENT TICKETS
          </button>
          <button class="actionBtn" onclick="downloadWinnersPDF()">
            DOWNLOAD WINNERS PDF
          </button>
        </div>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          START GAME CALLING
        </button>
        <button class="runBtn" onclick="showPopup(&#39;runGameWindowDiv&#39;)" id="runGameBtn">
          RUN GAME
        </button>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          DIVIDEND SETTINGS
        </button>
        <table class="gameSettingTable" id="dividendSettingsTable">
        </table>
        <div style="width: 80%; margin: 10px auto; display:flex; gap: 10px;">
          <button class="actionBtn" style="flex-grow: 1;" id="saveDividentBtn" onclick="saveDividendSettings()">
            SAVE DEVIDENDS
          </button>
          <button class="actionBtn" style="flex-grow: 1;" id="makePosterBtn" onclick="showPosterModal()">
            MAKE POSTER
          </button>
        </div>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          AUDIO CONTROLS
        </button>
        <table class="gameSettingTable" id="audioControlsTable">
          <tbody>
            <tr>
              <td>
                Background Music
              </td>
              <td>
                <select class="tableInp" id="bgMusicState" onchange="toggleBgMusic()">
                  <option value="off">
                    OFF
                  </option>
                  <option value="on">
                    ON
                  </option>
                </select>
              </td>
            </tr>
            <tr>
              <td>
                Playlist Mode
              </td>
              <td>
                <select class="tableInp" id="playlistModeState" onchange="togglePlaylistMode()">
                  <option value="off">
                    OFF (Loop Current)
                  </option>
                  <option value="on">
                    ON (Play All)
                  </option>
                </select>
              </td>
            </tr>
            <tr>
              <td>
                Upload MP3
              </td>
              <td>
                <div class="music-control-wrapper">
                  <input class="tableInp" type="file" id="bgMusicUpload" accept=".mp3" style="text-align: left; padding: 0.7rem 0.5rem;" />
                  <button class="actionBtn" id="musicUploadBtn">
                    Upload
                  </button>
                </div>
              </td>
            </tr>
            <tr>
              <td>
                Streaming URL
              </td>
              <td>
                <div class="music-control-wrapper">
                  <input class="tableInp" type="url" id="streamingUrlInp" placeholder="https://.../stream.mp3" style="text-align: left;" />
                  <button class="actionBtn" id="setStreamingUrlBtn">
                    Add
                  </button>
                </div>
              </td>
            </tr>
            <tr>
              <td>
                Live Announcement
              </td>
              <td>
                <button class="actionBtn" id="micToggleBtn" style="width:100%; font-size: 1rem;">
                  <i class="fas fa-microphone-slash"></i>
                  Toggle Mic
                </button>
              </td>
            </tr>
            <tr>
              <td>
                Manage Playlist
              </td>
              <td>
                <button class="actionBtn" id="viewPlaylistBtn" style="width:100%; font-size: 1rem;">
                  <i class="fas fa-list-ul"></i>
                  View Playlist
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          BUSINESS INFO
        </button>
        <table class="gameSettingTable" id="businessInfoTable">
        </table>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          ADMIN INFO
        </button>
        <table class="gameSettingTable" id="adminInfoTable">
          <tbody>
            <tr>
              <td>
                Admin name
              </td>
              <td>
                <input class="tableInp" id="adminNameInp" />
              </td>
            </tr>
            <tr>
              <td>
                Admin phone
              </td>
              <td>
                <input class="tableInp" id="adminPhoneInp" type="number" />
              </td>
            </tr>
            <tr>
              <td>
                Whatsapp group link
              </td>
              <td>
                <input class="tableInp" id="adminWpLinkInp" />
              </td>
            </tr>
            <tr>
              <td>
                Admin password
              </td>
              <td>
                <input class="tableInp" id="adminPassInp" placeholder="Enter new password to change" />
              </td>
            </tr>
            <tr>
              <td>
                <input class="tableInp" onclick="logout()" type="button" value="LOG OUT" style="background-color: var(--muted-color-dash); color: var(--light-text-dash); cursor: pointer;" />
              </td>
              <td>
                <input class="tableInp" id="saveAdminInfoBtn" type="button" onclick="saveAdminInfo()" value="SAVE INFO" style="background-color: var(--accent-color-dash); color: var(--light-text-dash); cursor: pointer;" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="gameSettingDiv">
        <button class="titleBtn">
          CREATE NEW AGENT
        </button>
        <div style="padding: 1.2rem; background-color: var(--secondary-bg-dash); display: flex; flex-direction: column; gap: 0.8rem; width:80%; margin:auto;">
          <input id="createAgentNameInp" class="tableInp" type="text" placeholder="Agent&#39;s Full Name" style="text-align:left;" />
          <input id="createAgentEmailInp" class="tableInp" type="email" placeholder="Agent&#39;s Email Address" style="text-align:left;" />
          <input id="createAgentPhoneInp" class="tableInp" type="tel" placeholder="Agent&#39;s Phone Number" style="text-align:left;" />
          <input id="createAgentPassInp" class="tableInp" type="password" placeholder="Set Temporary Password" style="text-align:left;" />
          <button class="actionBtn" style="width:100%; height: auto; padding: 10px;" onclick="createAgentByAdmin()">
            CREATE AGENT ACCOUNT
          </button>
        </div>
      </div>
      <div class="gameSettingDiv" style="margin-bottom: 80px;">
        <button class="titleBtn">
          TICKET/AGENT LIST
        </button>
        <div class="toggleDiv">
          <button class="clickBtn" id="showTicketBtn" onclick="toggleAdminList(&#39;tickets&#39;)">
            TICKET LIST
          </button>
          <button class="clickBtn" id="showAgentBtn" onclick="toggleAdminList(&#39;agents&#39;)">
            AGENT LIST
          </button>
        </div>
        <input class="searchInp" placeholder="Enter keyword" id="adminSearchKeyInp" onkeyup="updateAdminList()" />
        <table class="gameSettingTable1" id="adminGameSettingTable">
        </table>
      </div>
      <button class="bookFloatBtn" id="bookFloatBtn" onclick="showPopup(&#39;dashboardBookingPopup&#39;)">
        BOOK TICKET
      </button>
    </div>
    <div id="agentDashboardView" class="view dashboard-view">
      <div class="gameSettingDiv">
        <div class="titleBtn">
          AGENT DASHBOARD
        </div>
      </div>
      <div class="gameSettingDiv">
        <div class="titleBtn">
          TOTAL EARNING
        </div>
        <button class="runBtn" id="earningBtn">
           0
        </button>
      </div>
      <div class="gameSettingDiv">
        <div class="titleBtn">
          GAME &amp; SALES INFO
        </div>
        <table class="gameSettingTable" id="agentBusinessInfoTable">
        </table>
      </div>
      <div class="gameSettingDiv">
        <div class="titleBtn">
          AGENT INFO
        </div>
        <table class="gameSettingTable">
          <tbody>
            <tr>
              <td>
                Agent name
              </td>
              <td>
                <input class="tableInp" id="agentNameInp" readonly="" />
              </td>
            </tr>
            <tr>
              <td>
                Agent phone
              </td>
              <td>
                <input class="tableInp" id="agentPhoneInp" readonly="" />
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <button class="actionBtn" style="width:100%;" onclick="logout()">
                  LOG OUT
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="gameSettingDiv" style="margin-bottom: 80px;">
        <div class="titleBtn">
          MY SOLD TICKETS
        </div>
        <input class="searchInp" placeholder="Enter keyword" id="agentSearchKeyInp" onkeyup="showAgentSoldTickets()" />
        <table class="gameSettingTable" id="agentSoldTicketsTable">
        </table>
      </div>
      <button class="bookFloatBtn" onclick="showPopup(&#39;dashboardBookingPopup&#39;)">
        BOOK TICKET
      </button>
    </div>
    <div class="overlay-popup" id="loginPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <div id="loginForm">
          <h3 class="popup-title">
            Login
          </h3>
          <div class="login-form">
            <input id="loginEmailInp" type="email" placeholder="Email" />
            <input id="loginPassInp" type="password" placeholder="Password" />
            <input type="button" class="login-btn agent" value="AGENT LOGIN" id="agentLoginBtn" />
            <input type="button" class="login-btn admin" value="ADMIN LOGIN" id="adminLoginBtn" />
            <a href="#" class="forgot-password-link" id="forgotPasswordLink">            Forgot Password?
</a>
            <input type="button" class="login-btn secondary" value="Good Luck" id="showSignupFormBtn" />
          </div>
        </div>
        <div id="signupForm" style="display:none;">
          <h3 class="popup-title">
            Admin Sign Up
          </h3>
          <div class="login-form">
            <input id="signupNameInp" type="text" placeholder="Your Name" />
            <input id="signupEmailInp" type="email" placeholder="Email Address" />
            <input id="signupPhoneInp" type="tel" placeholder="Phone Number" />
            <input id="signupPassInp" type="password" placeholder="Create Password" />
            <input type="button" class="login-btn" value="CREATE ADMIN ACCOUNT" id="signupActionBtn" />
            <p style="text-align:center; margin: 8px 0; font-size: 0.85rem;">
              Already have an account?
            </p>
            <input type="button" class="login-btn secondary" value="LOGIN INSTEAD" id="showLoginFormBtn" />
          </div>
        </div>
      </div>
    </div>
    <div class="overlay-popup" id="agentListPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title">
          Agent List
        </h3>
        <div class="agent-list" id="agentListContainer">
        </div>
      </div>
    </div>
    <div id="number-announcement-overlay">
      <div id="announced-number-display">
        --
      </div>
    </div>
    <div class="overlay-popup" id="agentSelectionPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title">
          Select an Agent to Book
        </h3>
        <div class="agent-list" id="bookingAgentListContainer">
        </div>
      </div>
    </div>
    <div class="overlay-popup" id="editOwnerPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title">
          Edit Ticket Owner
        </h3>
        <p id="editOwnerInfoText" style="text-align: center; margin-bottom: 1.5rem; color: var(--text-secondary);">
        </p>
        <div class="login-form">
          <input id="editOwnerNameInp" type="text" class="agent-inp" placeholder="Owner Name" />
          <input id="editOwnerPhoneInp" type="tel" class="agent-inp" placeholder="Owner Phone" />
          <button id="saveOwnerChangesBtn" class="login-btn agent">
            Save Changes
          </button>
        </div>
      </div>
    </div>
    <div class="overlay-popup" id="winningTicketViewerPopup">
      <div class="popup-content" style="background-color: #e0f7fa; border-color: #0288d1;">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title" id="winningTicketPopupTitle" style="color: #01579b; text-shadow: none;">
          Winning Ticket
        </h3>
        <div id="winningTicketDisplayArea" style="padding-top: 1rem;">
        </div>
      </div>
    </div>
    <div class="overlay-popup" id="applyToAllConfirmPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title">
          Confirm Update
        </h3>
        <p id="applyToAllConfirmText" style="text-align: center; margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.5;">
        </p>
        <div class="login-form" style="display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem;">
          <button id="confirmApplyToAllBtn" class="login-btn agent">
            Yes, Apply to All
          </button>
          <button id="confirmApplyToSingleBtn" class="login-btn secondary">
            No, Just This Ticket
          </button>
          <button onclick="closePopups()" class="login-btn" style="background-color: var(--muted-color-dash);">
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div class="overlay-popup" id="deleteConfirmPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title">
          Confirm Deletion
        </h3>
        <p id="deleteConfirmText" style="text-align: center; margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.5;">
        </p>
        <div class="login-form" style="display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem;">
          <button id="confirmDeleteAllBtn" class="login-btn admin">
            Delete All Tickets
          </button>
          <button id="confirmDeleteSingleBtn" class="login-btn secondary">
            Delete Just This One
          </button>
          <button onclick="closePopups()" class="login-btn" style="background-color: var(--muted-color-dash);">
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div class="overlay-popup" id="ticketResetConfirmPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title">
          Confirm Ticket Change
        </h3>
        <p id="ticketResetConfirmText" style="text-align: center; margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.5;">
        </p>
        <div class="login-form" style="display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem;">
          <button id="confirmNoResetBtn" class="login-btn secondary">
            Keep Bookings &amp; Adjust Count
          </button>
          <button id="confirmResetBtn" class="login-btn admin">
            Reset All Tickets &amp; Bookings
          </button>
          <button onclick="closePopups()" class="login-btn" style="background-color: var(--muted-color-dash);">
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div class="gamePopDiv" id="dashboardBookingPopup">
      <div class="gameDiv">
        <div class="booking-popup-header">
          <button class="x-button" onclick="closePopups()">
            <i class="fas fa-times"></i>
          </button>
          <div class="titleBtn" style="margin-bottom: 0.5rem;">
          </div>
          <div class="bookInpDiv">
            <input class="tableInp" id="dashBookerNameInp" placeholder="Name" />
            <input class="tableInp" id="dashBookerPhoneInp" placeholder="Phone" />
          </div>
          <div id="dashboardSelectionIndicator" class="selection-indicator" style="width: 100%; margin: 0.8rem 0; color: var(--light-text-dash); border-color: var(--accent-color-dash); background: rgba(26, 188, 156, 0.1);">
          </div>
          <input class="bookBtn" type="button" id="dashBookBtn" onclick="handleDashboardBooking()" value="BOOK NOW" />
        </div>
        <div class="ticketBlockDiv" id="dashTicketBlockDiv">
        </div>
      </div>
    </div>
    <div class="gamePopDiv" id="publicBookingPopup">
      <div class="gameDiv">
        <div class="booking-popup-header">
          <button class="x-button" onclick="closePopups()">
            <i class="fas fa-times"></i>
          </button>
          <div class="titleBtn" style="margin-bottom: 0.5rem;">
          </div>
          <div class="bookInpDiv">
            <input class="tableInp" id="publicBookerNameInp" placeholder="Your Name" />
            <input class="tableInp" id="publicBookerPhoneInp" placeholder="Your Phone" />
          </div>
          <div id="publicBookingIndicator" class="selection-indicator" style="width: 100%; margin: 0.8rem 0; color: var(--light-text-dash); border-color: var(--accent-color-dash); background: rgba(26, 188, 156, 0.1);">
          </div>
          <input class="bookBtn" type="button" id="publicRequestBookingBtn" value="REQUEST BOOKING" />
        </div>
        <div class="ticketBlockDiv" id="publicBookingGrid">
        </div>
      </div>
    </div>
    <div class="gamePopDiv" id="runGameWindowDiv">
      <div class="gameDiv" style="overflow-y: auto;">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <div class="panel" style="background: transparent; border: none; box-shadow: none; padding: 0; width: 95%; margin: 0.5rem auto;">
          <div class="timer-status-bar" id="runGame-timer-bar" style="border-top: none; padding-top: 0; margin-bottom: 1rem;">
          </div>
        </div>
        <table class="runGameTable gameSettingTable">
          <tbody>
            <tr>
              <td>
                AUTO CALLING
              </td>
              <td>
                <select class="tableInp" id="callStatusInp" onchange="toggleGameRunner()">
                  <option value="off">
                    OFF
                  </option>
                  <option value="on">
                    ON
                  </option>
                </select>
              </td>
            </tr>
            <tr>
              <td>
                INTERVAL (sec)
              </td>
              <td>
                <input type="number" class="tableInp" id="callIntervalInp" value="10" />
              </td>
            </tr>
          </tbody>
        </table>
        <section class="panel" style="background: var(--secondary-bg-dash); width: 95%; margin: 1rem auto; border-color: var(--accent-color-dash);">
          <h2 class="panel-title" style="color: var(--light-text-dash); text-shadow: none; font-size: 1.2rem;">
            VIEW TICKET
          </h2>
          <div class="search-container" style="padding: 0 1rem 1rem 1rem;">
            <input type="text" class="searchInp" id="adminTicketSearchInp" placeholder="Enter name, phone, or ticket ID" style="background: var(--primary-bg-dash); color: var(--light-text-dash); border-color: var(--accent-color-dash);" />
            <button class="search-btn" id="adminSearchTicketBtn" style="background: var(--accent-color-dash);">
              <i class="fas fa-search"></i>
            </button>
            <button class="search-btn" id="adminClearSearchBtn" title="Clear All Search Results" style="padding: 0 0.8rem; background: var(--muted-color-dash);">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="ticketDisplayArea" id="adminTicketDisplayArea" style="padding: 0 1rem 1rem 1rem; max-height: 400px; overflow-y: auto;">
          </div>
        </section>
        <section class="panel" style="background: var(--secondary-bg-dash); width: 95%; margin: 1rem auto; border-color: var(--accent-color-dash);">
          <h2 class="panel-title" style="color: var(--light-text-dash); text-shadow: none; font-size: 1.2rem;">
            GAME BOARD
          </h2>
          <div class="number-board" id="runGamePopupBoard">
          </div>
        </section>
        <section class="panel" style="background: var(--secondary-bg-dash); width: 95%; margin: 1rem auto; border-color: var(--accent-color-dash);">
          <h2 class="panel-title" style="color: var(--light-text-dash); text-shadow: none; font-size: 1.2rem;">
            DIVIDENDS &amp; WINNERS
          </h2>
          <table class="dividend-table" id="runGameDividendTable" style="color: var(--light-text-dash);">
            <thead>
              <tr>
                <th style="color: var(--accent-color-dash);">
                  Dividend
                </th>
                <th style="color: var(--accent-color-dash);">
                  Winner
                </th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>
        <div style="font-weight:bold;font-size:10px;display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:6px;background:#ff4d4d;color:#fff;box-shadow:0 0 12px rgba(255,77,77,0.8);animation:blink 2s infinite; margin: 1rem auto;">
          <i class="fas fa-exclamation-triangle"></i>
          DO NOT CLOSE THIS PAGE WHILE GAME IS RUNNING
        </div>
        <style>
          @keyframes blink{50%{background:#fff;color:#ff4d4d;box-shadow:0 0 12px rgba(255,0,0,0.8);}}
        </style>
      </div>
    </div>
    <div class="overlay-popup" id="genericInfoPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title" id="genericInfoPopupTitle">
          Info
        </h3>
        <div id="genericInfoPopupContent" style="text-align: left; color: var(--text-secondary); line-height: 1.6;">
        </div>
      </div>
    </div>
    <div class="overlay-popup" id="posterMakerPopup">
      <div class="popup-content" style="max-width: 650px; background: var(--primary-bg-dash);">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title" style="color: var(--light-text-dash);">
          Game Poster Generator
        </h3>
        <div id="poster-bg-controls">
          <span>          Change BG:
</span>
          <label for="bg-upload" class="actionBtn">
            <i class="fas fa-upload"></i>
            Upload
          </label>
          <input type="file" id="bg-upload" accept="image/*" style="display: none;" />
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg1.jpeg&#39;)">
            BG 1
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg2.jpeg&#39;)">
            BG 2
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg3.jpeg&#39;)">
            BG 3
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg4.jpeg&#39;)">
            BG 4
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg5.jpeg&#39;)">
            BG 5
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg6.jpeg&#39;)">
            BG 6
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg7.jpeg&#39;)">
            BG 7
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg8.jpeg&#39;)">
            BG 8
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg9.jpeg&#39;)">
            BG 9
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg10.jpeg&#39;)">
            BG 10
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg11.jpg&#39;)">
            BG 11
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg12.jpg&#39;)">
            BG 12
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg13.jpg&#39;)">
            BG 13
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg14.jpg&#39;)">
            BG 14
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg15.jpg&#39;)">
            BG 15
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg16.jpg&#39;)">
            BG 16
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg17.jpg&#39;)">
            BG 17
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg18.jpg&#39;)">
            BG 18
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg19.jpg&#39;)">
            BG 19
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg20.jpg&#39;)">
            BG 20
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg21.jpg&#39;)">
            BG 21
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg22.jpg&#39;)">
            BG 22
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg23.jpg&#39;)">
            BG 23
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg24.jpg&#39;)">
            BG 24
          </button>
          <button class="actionBtn" onclick="changePosterBackground(this, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg25.jpg&#39;)">
            BG 25
          </button>
        </div>
        <div id="posterContent">
        </div>
        <div class="poster-actions">
          <button class="actionBtn" id="savePosterBtn" onclick="savePosterAsImage()">
            <i class="fas fa-download"></i>
            Save as File
          </button>
          <button class="actionBtn" id="sharePosterBtn" onclick="sharePoster()">
            <i class="fas fa-share-alt"></i>
            Share
          </button>
        </div>
      </div>
    </div>
    <div class="overlay-popup top-down-notification-popup" id="firstVisitPopup">
      <div class="popup-content">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <div class="notification-body">
          <div class="notification-logo">
            <img src="https://raw.githubusercontent.com/Anandkhuman/Photo/main/logo1.png" alt="Sintha Team Logo" />
          </div>
          <div class="notification-text-content">
            <h3 class="popup-title">
              Welcome to Sintha Team!
            </h3>
            <p>
              <b>              Sintha Team
</b>
              offers fully developed Tambola or Housie games and Jandi Munda or Lagao websites.
                    If you would like to organize games and purchase a custom website, please contact us for more information.
            </p>
          </div>
          <div class="notification-actions">
            <a href="https://sinthahousie.in/contact" target="_blank" class="login-btn" style="text-decoration: none;">            Contact Us
</a>
            <button class="login-btn secondary" id="closeFirstVisitPopupBtn">
              Not Now
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- NEW: Booking Success Popup -->
    <div class="overlay-popup" id="bookingSuccessPopup">
      <div class="popup-content" style="background: var(--primary-surface); border-color: #2ecc71; box-shadow: 0 0 20px rgba(46, 204, 113, 0.5); padding: 2rem;">
        <div class="success-animation">
          <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none">
            </circle>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8">
            </path>
          </svg>
        </div>
        <h3 class="popup-title" id="bookingSuccessTitle" style="color: #2ecc71; text-shadow: 0 0 8px #2ecc71; margin-top: 1rem;">
          Booking Successful!
        </h3>
        <p id="bookingSuccessMessage" style="text-align: center; color: var(--text-secondary); line-height: 1.5;">
        </p>
      </div>
    </div>
    <!-- NEW: Playlist Popup -->
    <div class="overlay-popup" id="playlistPopup">
      <div class="popup-content" style="max-width: 600px; background: var(--primary-bg-dash);">
        <button class="x-button" onclick="closePopups()">
          <i class="fas fa-times"></i>
        </button>
        <h3 class="popup-title" style="color: var(--light-text-dash);">
          Music Playlist
        </h3>
        <div id="popupMusicPlaylist" style="max-height: 70vh; overflow-y: auto;">
          <!-- Playlist will be rendered here -->
        </div>
      </div>
    </div>
    <!-- Global Audio Players -->
    <audio id="backgroundMusicPlayer" loop="">
    </audio>
    <audio id="liveAudioPlayer">
    </audio>
    <script>
      // --- START OF FIXED SCRIPT ---

const firebaseConfig = {
  apiKey: "AIzaSyAK3MWSr3lVqIhk94kyHxDQBNy5aGB10J4",
  authDomain: "lucky-housie-bumper.firebaseapp.com",
  databaseURL: "https://lucky-housie-bumper-default-rtdb.firebaseio.com",
  projectId: "lucky-housie-bumper",
  storageBucket: "lucky-housie-bumper.firebasestorage.app",
  messagingSenderId: "290501134452",
  appId: "1:290501134452:web:c4e7fd8a42435ae1326921",
  measurementId: "G-FTTRXM93EP"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// --- NEW: For music synchronization ---
let serverTimeOffset = 0;
db.ref(&#39;.info/serverTimeOffset&#39;).on(&#39;value&#39;, (snap) =&gt; {
    serverTimeOffset = snap.val();
});

function getEstimatedServerTime() {
    return Date.now() + serverTimeOffset;
}
// --- END NEW ---


// State Variables
const audioBaseUrl = &#34;https://raw.githubusercontent.com/Anandkhuman/housie/main/audio/&#34;;
let currentView = &#39;publicView&#39;;
let currentUser = null;
let currentUserRole = null;
let authInitialized = false;
let gameSettingsData = {};
let allTicketsData = [];
let allUsersData = [];
let currentCalledNumbers = [];
let lastAnnouncedNumber = null;
let isAnnouncing = false;
let countdownInterval = null;
let gameRunnerInterval = null;
let gameLiveSoundPlayed = false;
let knownWinners = {};
let isInitialWinnerLoad = true;
let ticketIdToEdit = null;
let originalOwnerInfo = { name: &#39;&#39;, phone: &#39;&#39; };
let ticketToDeleteInfo = {};
let publicSelectedTickets = [];
let publicPopupSelectedTickets = [];
let adminListState = &#39;tickets&#39;;
let lastNotification = { message: &#39;&#39;, type: &#39;&#39;, timestamp: 0 };
let displayedSearchPhones = new Set();
let adminDisplayedSearchPhones = new Set();
const popupCloseTimeouts = new Map();
const listeners = {}; // To keep track of Firebase listeners

// --- AUDIO FIX: Variables for Media Source Streaming ---
let backgroundMusicPlayer;
let liveAudioPlayer;
let mediaSource;
let sourceBuffer;
let audioQueue = [];
let isAppending = false;
let isMediaSourceOpen = false;
let lastProcessedTimestamp = 0;
// --- End Audio Fix Variables ---

let localStream;
let mediaRecorder;
let isMicOn = false;
let audioLibrary = {};
let currentTrackId = null;


const dividendSoundMap = {
    &#34;First Full House&#34;: &#34;FirstFullHouse.mp3&#34;, &#34;Second Full House&#34;: &#34;SecondFullHouse.mp3&#34;, &#34;Third Full House&#34;: &#34;ThirdFullHouse.mp3&#34;,
    &#34;Top Line&#34;: &#34;TopLine.mp3&#34;, &#34;Middle Line&#34;: &#34;MiddleLine.mp3&#34;, &#34;Bottom Line&#34;: &#34;BottomLine.mp3&#34;,
    &#34;Corners (4)&#34;: &#34;Corner.mp3&#34;, &#34;Quick 7&#34;: &#34;Quick7.mp3&#34;, &#34;Full Sheet Bonus&#34;: &#34;FullSheetBonus.mp3&#34;,
    &#34;Half Sheet Bonus&#34;: &#34;HalfSheetBonus.mp3&#34;, &#34;Star&#34;: &#34;Star.mp3&#34;, &#34;Early 5&#34;: &#34;Early5.mp3&#34;,
};
const allPossibleDividends = [
    &#34;First Full House&#34;, &#34;Second Full House&#34;, &#34;Third Full House&#34;, &#34;Full Sheet Bonus&#34;, &#34;Half Sheet Bonus&#34;, &#34;Top Line&#34;, &#34;Middle Line&#34;, &#34;Bottom Line&#34;,
    &#34;Early 5&#34;, &#34;Quick 7&#34;, &#34;Corners (4)&#34;, &#34;Star&#34;
];

// --- Core App Logic ---

function playSound(src) {
    const sound = new Audio(src);
    sound.play().catch(error =&gt; {});
}

function showView(viewId) {
    document.querySelectorAll(&#39;.view&#39;).forEach(v =&gt; v.classList.remove(&#39;active&#39;));
    const newView = document.getElementById(viewId);
    if (newView) {
        newView.classList.add(&#39;active&#39;);
        currentView = viewId;
        document.body.scrollTop = document.documentElement.scrollTop = 0;
        const isDashboard = viewId === &#39;adminDashboardView&#39; || viewId === &#39;agentDashboardView&#39;;
        document.body.classList.toggle(&#39;dashboard-view-active&#39;, isDashboard);
        // After changing view, re-render dashboards if necessary
        renderDashboards();
    }
}

function handleRouting() {
    const hash = window.location.hash.replace(&#39;#&#39;, &#39;&#39;);
    if (hash === &#39;admin&#39; &amp;&amp; currentUserRole === &#39;admin&#39;) {
        showView(&#39;adminDashboardView&#39;);
    } else if (hash === &#39;agent&#39; &amp;&amp; currentUserRole === &#39;agent&#39;) {
        showView(&#39;agentDashboardView&#39;);
    } else if (hash === &#39;book&#39;) {
        showView(&#39;ticketBookingView&#39;);
    } else {
        showView(&#39;publicView&#39;);
    }
}
window.addEventListener(&#39;hashchange&#39;, handleRouting);

function showNotification(message, type = &#39;info&#39;, duration = 4000) {
    const now = Date.now();
    if (message === lastNotification.message &amp;&amp; type === lastNotification.type &amp;&amp; (now - lastNotification.timestamp) &lt; 5000) return;
    const container = document.getElementById(&#39;notification-container&#39;);
    if (Array.from(container.querySelectorAll(&#39;.notification&#39;)).some(n =&gt; n.textContent === message)) return;
    lastNotification = { message, type, timestamp: now };
    const notification = document.createElement(&#39;div&#39;);
    notification.className = `notification ${type}`;
    notification.textContent = message;
    container.appendChild(notification);
    setTimeout(() =&gt; notification.classList.add(&#39;show&#39;), 10);
    setTimeout(() =&gt; {
        notification.classList.remove(&#39;show&#39;);
        notification.addEventListener(&#39;transitionend&#39;, () =&gt; notification.remove());
    }, duration);
}

async function triggerGlobalNotification(message, type = &#39;info&#39;) {
    try {
        await db.ref(&#39;gameState/lastAction&#39;).set({
            message: message, type: type, timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    } catch (e) { console.error(&#39;Error triggering global notification:&#39;, e); }
}

// --- Authentication ---

auth.onAuthStateChanged(async (user) =&gt; {
    currentUser = user;
    if (user) {
        try {
            const userSnapshot = await db.ref(&#39;users/&#39; + user.uid).once(&#39;value&#39;);
            const userData = userSnapshot.val();
            currentUserRole = userData ? userData.role : null;
            if (!currentUserRole) throw new Error(&#34;User role not found.&#34;);
            updateUIAfterLogin();
        } catch (error) {
            console.error(&#34;Auth state error:&#34;, error.message, &#34;Logging out.&#34;);
            showNotification(`Auth Error: ${error.message}`, &#39;error&#39;);
            logout();
        }
    } else {
        currentUserRole = null;
        updateUIAfterLogout();
    }
    if (!authInitialized) {
        authInitialized = true;
        setupRealtimeListeners();
        processBookingLink();
    }
    handleRouting();
});

async function loginUser(expectedRole) {
    const emailEl = document.getElementById(&#39;loginEmailInp&#39;);
    const passEl = document.getElementById(&#39;loginPassInp&#39;);
    if (!emailEl.value || !passEl.value) return showNotification(&#39;Please fill all fields.&#39;, &#39;error&#39;);
    try {
        const userCredential = await auth.signInWithEmailAndPassword(emailEl.value, passEl.value);
        const userSnapshot = await db.ref(&#39;users/&#39; + userCredential.user.uid).once(&#39;value&#39;);
        const userData = userSnapshot.val();
        if (userData &amp;&amp; userData.role === expectedRole) {
            showNotification(`Login successful as ${expectedRole}!`, &#39;success&#39;);
            closePopups();
        } else {
            await auth.signOut();
            showNotification(`Login failed: This is not a valid ${expectedRole} account.`, &#39;error&#39;);
        }
    } catch (error) { showNotification(`Login Error: ${error.message}`, &#39;error&#39;); }
}

async function signupUser() {
    const name = document.getElementById(&#39;signupNameInp&#39;).value.trim();
    const email = document.getElementById(&#39;signupEmailInp&#39;).value.trim();
    const phone = document.getElementById(&#39;signupPhoneInp&#39;).value.trim();
    const pass = document.getElementById(&#39;signupPassInp&#39;).value;
    if (!name || !email || !phone || !pass) return showNotification(&#39;Please fill all fields.&#39;, &#39;error&#39;);
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
        await userCredential.user.updateProfile({ displayName: name });
        await db.ref(&#39;users/&#39; + userCredential.user.uid).set({
            name, email, phone, role: &#39;admin&#39;, createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        showNotification(`Admin account created. Please log in.`, &#39;success&#39;);
        await auth.signOut();
        showLoginForm();
    } catch (error) { showNotification(`Signup Error: ${error.message}`, &#39;error&#39;); }
}

function logout() {
    auth.signOut().then(() =&gt; showNotification(&#34;You have been logged out.&#34;, &#34;info&#34;));
}

async function handleForgotPassword(e) {
    e.preventDefault();
    const email = document.getElementById(&#39;loginEmailInp&#39;).value.trim();
    if (!email) return showNotification(&#39;Please enter your email address first.&#39;, &#39;error&#39;);
    try {
        await auth.sendPasswordResetEmail(email);
        showNotification(`Password reset link sent to ${email}.`, &#39;success&#39;);
        closePopups();
    } catch (error) { showNotification(`Error: ${error.message}`, &#39;error&#39;); }
}


// --- Popups and UI Helpers ---

function bindEventListeners() {
    document.querySelectorAll(&#39;.x-button&#39;).forEach(btn =&gt; btn.addEventListener(&#39;click&#39;, closePopups));
    //document.getElementById(&#39;showSignupFormBtn&#39;).addEventListener(&#39;click&#39;, showSignupForm);
    document.getElementById(&#39;showLoginFormBtn&#39;).addEventListener(&#39;click&#39;, showLoginForm);
    document.getElementById(&#39;adminLoginBtn&#39;).addEventListener(&#39;click&#39;, () =&gt; loginUser(&#39;admin&#39;));
    document.getElementById(&#39;agentLoginBtn&#39;).addEventListener(&#39;click&#39;, () =&gt; loginUser(&#39;agent&#39;));
    document.getElementById(&#39;signupActionBtn&#39;).addEventListener(&#39;click&#39;, signupUser);
    document.getElementById(&#39;forgotPasswordLink&#39;).addEventListener(&#39;click&#39;, handleForgotPassword);
    document.querySelectorAll(&#39;#publicLogoutBtn, #bookingLogoutBtn&#39;).forEach(btn =&gt; btn.addEventListener(&#39;click&#39;, logout));
    document.getElementById(&#39;showAgentsBtn&#39;).addEventListener(&#39;click&#39;, showAgentListPopup);
    document.getElementById(&#39;showAgentListBtn-booking&#39;).addEventListener(&#39;click&#39;, showAgentListPopup);
    document.querySelectorAll(&#39;#publicLoginBtn, #bookingLoginBtn&#39;).forEach(btn =&gt; btn.addEventListener(&#39;click&#39;, () =&gt; showPopup(&#39;loginPopup&#39;)));
    document.getElementById(&#39;searchBtn&#39;).addEventListener(&#39;click&#39;, () =&gt; searchTicketPublic());
    document.getElementById(&#39;ticketSearchInp&#39;).addEventListener(&#39;keyup&#39;, e =&gt; { if (e.key === &#34;Enter&#34;) searchTicketPublic(); });
    document.getElementById(&#39;clearAllSearchBtn&#39;).addEventListener(&#39;click&#39;, () =&gt; {
        document.getElementById(&#39;ticketDisplayArea&#39;).innerHTML = &#39;&#39;;
        displayedSearchPhones.clear();
    });
    document.getElementById(&#39;navigateToBooking&#39;).addEventListener(&#39;click&#39;, (e) =&gt; { e.preventDefault(); window.location.hash = &#39;book&#39;; });
    document.getElementById(&#39;navigateToGame&#39;).addEventListener(&#39;click&#39;, (e) =&gt; { e.preventDefault(); window.location.hash = &#39;game&#39;; });
    document.getElementById(&#39;requestBookingBtn&#39;).addEventListener(&#39;click&#39;, handlePublicBookingRequest);
    document.getElementById(&#39;checkAvailabilityBtn&#39;).addEventListener(&#39;click&#39;, () =&gt; {
        renderPublicBookingGrid();
        showPopup(&#39;publicBookingPopup&#39;);
    });
    document.getElementById(&#39;publicRequestBookingBtn&#39;).addEventListener(&#39;click&#39;, handlePublicPopupBookingRequest);
    document.getElementById(&#39;saveOwnerChangesBtn&#39;).addEventListener(&#39;click&#39;, saveTicketOwnerChanges);
    document.getElementById(&#39;closeFirstVisitPopupBtn&#39;).addEventListener(&#39;click&#39;, closePopups);
    document.getElementById(&#39;adminSearchTicketBtn&#39;).addEventListener(&#39;click&#39;, searchTicketAdmin);
    document.getElementById(&#39;adminTicketSearchInp&#39;).addEventListener(&#39;keyup&#39;, e =&gt; { if (e.key === &#34;Enter&#34;) searchTicketAdmin(); });
    document.getElementById(&#39;adminClearSearchBtn&#39;).addEventListener(&#39;click&#39;, () =&gt; {
        document.getElementById(&#39;adminTicketDisplayArea&#39;).innerHTML = &#39;&#39;;
        adminDisplayedSearchPhones.clear();
    });
    document.getElementById(&#39;bg-upload&#39;).addEventListener(&#39;change&#39;, handlePosterBgUpload);
    document.getElementById(&#39;viewPlaylistBtn&#39;).addEventListener(&#39;click&#39;, () =&gt; showPopup(&#39;playlistPopup&#39;));
}

function showPopup(id) {
    const popup = document.getElementById(id);
    if (popup) {
        if (popupCloseTimeouts.has(id)) {
            clearTimeout(popupCloseTimeouts.get(id));
            popupCloseTimeouts.delete(id);
        }
        popup.style.pointerEvents = &#39;auto&#39;;
        popup.style.display = popup.classList.contains(&#39;overlay-popup&#39;) ? &#39;flex&#39; : &#39;block&#39;;
        setTimeout(() =&gt; popup.classList.add(&#39;active&#39;), 10);
    }
}

function closePopups() {
    document.querySelectorAll(&#39;.overlay-popup.active, .gamePopDiv.active&#39;).forEach(p =&gt; {
        p.style.pointerEvents = &#39;none&#39;;
        p.classList.remove(&#39;active&#39;);
        if (popupCloseTimeouts.has(p.id)) {
            clearTimeout(popupCloseTimeouts.get(p.id));
        }
        const timeoutId = setTimeout(() =&gt; {
            p.style.display = &#39;none&#39;;
            p.style.pointerEvents = &#39;auto&#39;;
            popupCloseTimeouts.delete(p.id);
        }, 450);
        popupCloseTimeouts.set(p.id, timeoutId);
    });
}

function showLoginForm() { document.getElementById(&#39;loginForm&#39;).style.display = &#39;block&#39;; document.getElementById(&#39;signupForm&#39;).style.display = &#39;none&#39;; }
function showSignupForm() { document.getElementById(&#39;loginForm&#39;).style.display = &#39;none&#39;; document.getElementById(&#39;signupForm&#39;).style.display = &#39;block&#39;; }

function showAgentListPopup() {
    const container = document.getElementById(&#39;agentListContainer&#39;);
    container.innerHTML = &#39;&#39;;
    const agents = allUsersData.filter(u =&gt; u.role === &#39;admin&#39; || u.role === &#39;agent&#39;).sort((a, b) =&gt; {
        if (a.role === &#39;admin&#39; &amp;&amp; b.role !== &#39;admin&#39;) return -1;
        if (a.role !== &#39;admin&#39; &amp;&amp; b.role === &#39;admin&#39;) return 1;
        return (a.name || &#39;&#39;).localeCompare(b.name || &#39;&#39;);
    });
    if (agents.length &gt; 0) {
        agents.forEach(agent =&gt; {
            const link = document.createElement(&#39;a&#39;);
            link.href = `https://wa.me/${agent.phone.replace(/\D/g, &#39;&#39;)}`;
            link.target = &#39;_blank&#39;;
            link.innerHTML = `${agent.name}&lt;i class=&#34;fab fa-whatsapp&#34;&gt;&lt;/i&gt;`;
            container.appendChild(link);
        });
    } else { container.innerHTML = &#39;&lt;p&gt;No agents available.&lt;/p&gt;&#39;; }
    showPopup(&#39;agentListPopup&#39;);
}

// --- Data Listeners &amp; UI Updaters ---

function setupRealtimeListeners() {
    Object.values(listeners).forEach(ref =&gt; ref.off());

    listeners.settings = db.ref(&#39;settings/gameConfig&#39;);
    listeners.settings.on(&#39;value&#39;, snapshot =&gt; {
        gameSettingsData = snapshot.val() || {};
        updateAllUIsWithSettings(gameSettingsData);
        renderDashboards();
    }, err =&gt; { console.error(&#34;Settings listener error:&#34;, err); });

    listeners.gameState = db.ref(&#39;gameState/currentState&#39;);
    listeners.gameState.on(&#39;value&#39;, snapshot =&gt; {
        const data = snapshot.val() || {};
        const newNumbers = data.calledNumbers || [];
        if (newNumbers.length &gt; currentCalledNumbers.length) {
            const newNum = newNumbers[newNumbers.length - 1];
            if (newNum !== lastAnnouncedNumber &amp;&amp; !isAnnouncing) {
                announceNumber(newNum);
            }
        }
        currentCalledNumbers = newNumbers;
        const newWinners = data.winners || {};
        if (!isInitialWinnerLoad) {
            for (const dividendName in newWinners) {
                const newWinnerArray = newWinners[dividendName] || [];
                const oldWinnerArray = knownWinners[dividendName] || [];
                const oldWinnerTicketIds = new Set(oldWinnerArray.map(w =&gt; w.ticketId));
                const justAnnouncedWinners = newWinnerArray.filter(w =&gt; !oldWinnerTicketIds.has(w.ticketId));
                if (justAnnouncedWinners.length &gt; 0) {
                    const winnerNames = justAnnouncedWinners.map(w =&gt; `${w.name} (Tkt: ${w.ticketId})`).join(&#39;, &#39;);
                    const msg = `${winnerNames} has won ${dividendName}!`;
                    triggerGlobalNotification(msg, &#39;success&#39;);
                    if (dividendSoundMap[dividendName]) playSound(audioBaseUrl + dividendSoundMap[dividendName]);
                }
            }
        }
        knownWinners = newWinners;
        isInitialWinnerLoad = false;
        updateGameRelatedUIs(data);
    }, err =&gt; { console.error(&#34;GameState listener error:&#34;, err); });

    listeners.tickets = db.ref(&#39;tickets&#39;);
    listeners.tickets.on(&#39;value&#39;, snapshot =&gt; {
        const ticketsObject = snapshot.val();
        allTicketsData = ticketsObject ? Object.values(ticketsObject) : [];
        updatePublicTicketUIs();
        renderDashboards();
    }, err =&gt; { console.error(&#34;Tickets listener error:&#34;, err); });

    listeners.users = db.ref(&#39;users&#39;);
    listeners.users.on(&#39;value&#39;, snapshot =&gt; {
        const usersObject = snapshot.val();
        allUsersData = usersObject ? Object.entries(usersObject).map(([uid, data]) =&gt; ({ uid, ...data })) : [];
        updatePublicUserUIs();
        renderDashboards();
    }, err =&gt; { console.error(&#34;Users listener error:&#34;, err); });

    let isFirstNotificationRead = true;
    listeners.globalNotifications = db.ref(&#39;gameState/lastAction&#39;);
    listeners.globalNotifications.on(&#39;value&#39;, snapshot =&gt; {
        if (isFirstNotificationRead || !snapshot.exists()) { isFirstNotificationRead = false; return; }
        const data = snapshot.val();
        if ((Date.now() - data.timestamp) &lt; 15000) showNotification(data.message, data.type);
    }, err =&gt; console.error(&#34;Global notification listener error:&#34;, err));

    listeners.audio = db.ref(&#39;settings/audio&#39;);
    listeners.audio.on(&#39;value&#39;, snapshot =&gt; {
        const audioData = snapshot.val() || {};
        audioLibrary = audioData.musicLibrary || {};
        currentTrackId = audioData.currentTrackId || null;
        
        handleBackgroundMusicState(audioData);
        if (currentUserRole !== &#39;admin&#39;) {
            handleLiveAudioStream(audioData);
        } else {
             renderMusicPlaylist();
        }
    }, err =&gt; console.error(&#34;Audio listener error:&#34;, err));
}

function renderDashboards() {
    if (!currentUserRole || (currentView !== &#39;adminDashboardView&#39; &amp;&amp; currentView !== &#39;agentDashboardView&#39;)) {
        return;
    }
    if (Object.keys(gameSettingsData).length === 0 || allUsersData.length === 0) {
        return;
    }

    if (currentUserRole === &#39;admin&#39;) {
        updateAdminSettingsUI(gameSettingsData);
        updateAdminInfoUI();
        updateBusinessInfo();
        updateAdminList();
    } else if (currentUserRole === &#39;agent&#39;) {
        updateAgentInfoUI();
        showAgentSoldTickets();
    }
}


function updateAllUIsWithSettings(data) {
    document.getElementById(&#39;whatsappGroupLink&#39;).href = data.whatsappLink || &#39;#&#39;;
    updateCountdownTimers(data.gameDateTime);
    populateDividendList(data.dividends || []);
}

function updateGameRelatedUIs(gameState) {
    updateNumberBoard(gameState.calledNumbers || []);
    updateCalledNumbersList(gameState.calledNumbers || []);
    updateWinners(gameState.winners || {});
    updateDisplayedTicketPublic();
    if (currentUserRole === &#39;admin&#39;) {
        updateRunGameUI(gameState);
        updateAdminDisplayedTickets();
    }
}
function updatePublicTicketUIs() {
    renderVisualTicketBookingPage();
    renderSheetWiseBookedList();
    if (document.getElementById(&#39;ticketDisplayArea&#39;).innerHTML) {
        const currentPhones = Array.from(displayedSearchPhones);
        document.getElementById(&#39;ticketDisplayArea&#39;).innerHTML = &#39;&#39;;
        displayedSearchPhones.clear();
        currentPhones.forEach(phone =&gt; searchTicketPublic(phone, true));
    }
    updateDashboardBookingPopup();
    if (document.getElementById(&#39;publicBookingPopup&#39;).classList.contains(&#39;active&#39;)) {
        renderPublicBookingGrid();
    }
}
function updatePublicUserUIs() { }


function updateUIAfterLogin() {
    document.querySelectorAll(&#39;#publicLoginBtn, #bookingLoginBtn&#39;).forEach(btn =&gt; btn.style.display = &#39;none&#39;);
    document.querySelectorAll(&#39;#publicLogoutBtn, #bookingLogoutBtn&#39;).forEach(btn =&gt; btn.style.display = &#39;flex&#39;);
    const addDashLink = (bar, role) =&gt; {
        bar.querySelector(&#39;.dashboard-link&#39;)?.remove();
        const link = document.createElement(&#39;a&#39;);
        link.href = `#${role}`;
        link.className = &#39;icon-btn dashboard-link&#39;;
        link.innerHTML = `&lt;i class=&#34;fas fa-user-shield&#34;&gt;&lt;/i&gt;&lt;span&gt;Dashboard&lt;/span&gt;`;
        bar.appendChild(link);
    };
    if (currentUserRole) {
        addDashLink(document.getElementById(&#39;public-icon-bar&#39;), currentUserRole);
        addDashLink(document.getElementById(&#39;booking-icon-bar&#39;), currentUserRole);
    }
}

function updateUIAfterLogout() {
    document.querySelectorAll(&#39;#publicLoginBtn, #bookingLoginBtn&#39;).forEach(btn =&gt; btn.style.display = &#39;flex&#39;);
    document.querySelectorAll(&#39;#publicLogoutBtn, #bookingLogoutBtn&#39;).forEach(btn =&gt; btn.style.display = &#39;none&#39;);
    document.querySelectorAll(&#39;.dashboard-link&#39;).forEach(link =&gt; link.remove());
}

function checkSheetSelection(selectedIds) {
    const count = selectedIds.length;
    if (count === 0) {
        return { valid: false, message: &#34;&#34; };
    }

    const sheets = {};
    for (const id of selectedIds) {
        const sheetNum = Math.floor((id - 1) / 6);
        if (!sheets[sheetNum]) {
            sheets[sheetNum] = [];
        }
        sheets[sheetNum].push(id);
    }

    let fullSheetCount = 0;
    let halfSheetCount = 0;
    let randomCount = 0;

    for (const sheetNum in sheets) {
        const ticketsInSheet = sheets[sheetNum].sort((a, b) =&gt; a - b);
        const len = ticketsInSheet.length;
        const sheetStartId = parseInt(sheetNum) * 6 + 1;

        if (len === 6) {
            fullSheetCount++;
        } else if (len === 3) {
            const firstId = ticketsInSheet[0];
            const isFirstHalf = (firstId === sheetStartId) &amp;&amp;
                (ticketsInSheet[1] === sheetStartId + 1) &amp;&amp;
                (ticketsInSheet[2] === sheetStartId + 2);
            const isLastHalf = (firstId === sheetStartId + 3) &amp;&amp;
                (ticketsInSheet[1] === sheetStartId + 4) &amp;&amp;
                (ticketsInSheet[2] === sheetStartId + 5);

            if (isFirstHalf || isLastHalf) {
                halfSheetCount++;
            } else {
                randomCount += 3;
            }
        } else {
            randomCount += len;
        }
    }

    const parts = [];
    if (fullSheetCount &gt; 0) {
        parts.push(`${fullSheetCount} Full Sheet${fullSheetCount &gt; 1 ? &#39;s&#39; : &#39;&#39;}`);
    }
    if (halfSheetCount &gt; 0) {
        parts.push(`${halfSheetCount} Half Sheet${halfSheetCount &gt; 1 ? &#39;s&#39; : &#39;&#39;}`);
    }
    if (randomCount &gt; 0) {
        parts.push(`${randomCount} Random Ticket${randomCount &gt; 1 ? &#39;s&#39; : &#39;&#39;}`);
    }

    if (parts.length === 0) {
        return { valid: false, message: &#34;Select your tickets.&#34; };
    }

    const message = parts.join(&#39; &amp; &#39;) + &#39; Selected&#39;;
    return { valid: true, message: message };
}
function generateNumberBoard() {
    const publicBoard = document.getElementById(&#39;numberBoard&#39;);
    const adminPopupBoard = document.getElementById(&#39;runGamePopupBoard&#39;);

    let boardHtml = &#39;&#39;;
    for(let i = 1; i &lt;= 90; i++) {
        boardHtml += `&lt;div class=&#34;num-cell&#34; id=&#34;num-${i}&#34;&gt;${i}&lt;/div&gt;`;
    }

    let adminPopupBoardHtml = &#39;&#39;;
    for(let i = 1; i &lt;= 90; i++) {
        adminPopupBoardHtml += `&lt;div class=&#34;num-cell&#34; id=&#34;run-game-popup-num-${i}&#34;&gt;${i}&lt;/div&gt;`;
    }

    if(publicBoard) publicBoard.innerHTML = boardHtml;
    if(adminPopupBoard) adminPopupBoard.innerHTML = adminPopupBoardHtml;
}

// --- Professional announceNumber function ---
function announceNumber(number) {
    isAnnouncing = true;
    lastAnnouncedNumber = number;
    
    playSound(audioBaseUrl + number + &#39;.mp3&#39;);

    const overlay = document.getElementById(&#39;number-announcement-overlay&#39;);
    const numberDisplay = document.getElementById(&#39;announced-number-display&#39;);
    if (!overlay || !numberDisplay) { isAnnouncing = false; return; }
    
    numberDisplay.textContent = number;

    // Kill any previous animation to prevent overlap
    gsap.killTweensOf([overlay, numberDisplay]);

    gsap.timeline({ onComplete: () =&gt; { isAnnouncing = false; } })
      .set(numberDisplay, { y: &#39;-100px&#39; }) // Start ball hidden &#39;inside&#39; dispenser
      .to(overlay, { autoAlpha: 1, duration: 0.2 }) // Show dispenser
      .to(numberDisplay, { 
          y: 0, // Drop ball down to its final position
          duration: 1.2, 
          ease: &#39;elastic.out(1, 0.7)&#39; // Bouncy effect
      })
      .to(overlay, { 
          autoAlpha: 0, // Fade out the whole thing
          duration: 0.5, 
          ease: &#39;power2.in&#39; 
      }, &#34;+=2.5&#34;); // Wait 2.5 seconds before fading out
}

function updateCountdownTimers(targetDateString) {
    if (countdownInterval) clearInterval(countdownInterval);
    const targetDate = new Date(targetDateString).getTime();
    
    const timerBars = [
        document.getElementById(&#39;public-timer-bar&#39;),
        document.getElementById(&#39;booking-timer-bar&#39;),
        document.getElementById(&#39;runGame-timer-bar&#39;)
    ];

    if (!targetDateString || isNaN(targetDate)) {
        gameLiveSoundPlayed = false;
        const waitingHTML = `&lt;div class=&#34;info-item&#34;&gt;&lt;i class=&#34;fas fa-hourglass-half&#34;&gt;&lt;/i&gt;&lt;span&gt;Awaiting Game Schedule&lt;/span&gt;&lt;/div&gt;`;
        timerBars.forEach(bar =&gt; { if(bar) bar.innerHTML = waitingHTML; });
        return;
    }

    const date = new Date(targetDate);
    const dateText = date.toLocaleDateString(undefined, { year: &#39;numeric&#39;, month: &#39;short&#39;, day: &#39;numeric&#39; });
    const timeText = date.toLocaleTimeString(undefined, { hour: &#39;2-digit&#39;, minute: &#39;2-digit&#39; });

    const update = () =&gt; {
        const distance = targetDate - new Date().getTime();
        let countdownText;
        if (distance &lt; 0) {
            clearInterval(countdownInterval);
            countdownText = &#39;Game is in Progress!&#39;;
            if (!gameLiveSoundPlayed) {
                playSound(audioBaseUrl + &#34;GAMEISLIVE.mp3&#34;);
                gameLiveSoundPlayed = true;
            }
        } else {
            const d = Math.floor(distance / 86400000).toString().padStart(2, &#39;0&#39;);
            const h = Math.floor((distance % 86400000) / 3600000).toString().padStart(2, &#39;0&#39;);
            const m = Math.floor((distance % 3600000) / 60000).toString().padStart(2, &#39;0&#39;);
            const s = Math.floor((distance % 60000) / 1000).toString().padStart(2, &#39;0&#39;);
            countdownText = `${d}d ${h}h ${m}m ${s}s`;
        }
        const timerHTML = `
            &lt;div class=&#34;info-item&#34;&gt;&lt;i class=&#34;fas fa-calendar-alt&#34;&gt;&lt;/i&gt;&lt;span&gt;${dateText}&lt;/span&gt;&lt;/div&gt;
            &lt;div class=&#34;info-item&#34;&gt;&lt;i class=&#34;fas fa-clock&#34;&gt;&lt;/i&gt;&lt;span&gt;${timeText}&lt;/span&gt;&lt;/div&gt;
            &lt;div class=&#34;info-item&#34;&gt;&lt;i class=&#34;fas fa-hourglass-start&#34;&gt;&lt;/i&gt;&lt;span&gt;${countdownText}&lt;/span&gt;&lt;/div&gt;`;
        timerBars.forEach(bar =&gt; { if(bar) bar.innerHTML = timerHTML; });
    };
    update();
    countdownInterval = setInterval(update, 1000);
}

function renderVisualTicketBookingPage() {
    const gridContainer = document.getElementById(&#39;bookingGridContainer&#39;);
    if (!gridContainer) return;
    gridContainer.innerHTML = &#39;&#39;;

    if (currentView === &#39;ticketBookingView&#39;) {
        publicSelectedTickets = [];
        updatePublicSelectionIndicator();
    }

    const totalTickets = gameSettingsData.totalTickets || 0;
    if (allTicketsData.length === 0 || totalTickets === 0) {
        gridContainer.innerHTML = &#39;&lt;p style=&#34;text-align: center;&#34;&gt;Tickets have not been generated by the admin yet.&lt;/p&gt;&#39;;
        return;
    }

    const ticketsMap = new Map(allTicketsData.map(t =&gt; [t.id, t]));
    const numSheets = Math.ceil(totalTickets / 6);

    for (let i = 0; i &lt; numSheets; i++) {
        const startTicketId = i * 6 + 1;
        const endTicketId = startTicketId + 5;
        const sheetWrapper = document.createElement(&#39;div&#39;);
        sheetWrapper.className = &#39;sheet-view&#39;;

        const sheetHeader = document.createElement(&#39;div&#39;);
        sheetHeader.className = &#39;sheet-header&#39;;
        sheetHeader.innerHTML = `
            &lt;span&gt;Sheet ${i + 1} (Tkt ${startTicketId}-${endTicketId})&lt;/span&gt;
            &lt;label class=&#34;full-sheet-selector&#34;&gt;
                &lt;input type=&#34;checkbox&#34; onchange=&#34;selectFullSheet(this, ${startTicketId}, ${endTicketId})&#34;&gt; Select Full
            &lt;/label&gt;`;
        sheetWrapper.appendChild(sheetHeader);

        const sheetContent = document.createElement(&#39;div&#39;);
        sheetContent.className = &#39;sheet-content&#39;;
        sheetWrapper.appendChild(sheetContent);

        for (let j = startTicketId; j &lt;= endTicketId; j++) {
            const ticket = ticketsMap.get(j);
            const ticketView = document.createElement(&#39;div&#39;);
            ticketView.id = `booking-ticket-${j}`;
            ticketView.className = &#39;ticket-view&#39;;
            if (ticket &amp;&amp; ticket.is_sold) {
                ticketView.classList.add(&#39;sold&#39;);
            } else {
                ticketView.onclick = () =&gt; togglePublicTicketSelection(j);
            }

            let headerHTML = `&lt;div class=&#34;ticket-header&#34;&gt;Ticket ${j}&lt;/div&gt;`;
            let gridHTML = &#39;&#39;;

            if (ticket) {
                if (Array.isArray(ticket.numbers) &amp;&amp; ticket.numbers.length &gt; 0) {
                    gridHTML = ticket.numbers.flat().map(n =&gt;
                        `&lt;div class=&#34;ticket-num ${n &gt; 0 ? &#39;&#39; : &#39;empty&#39;}&#34; data-num=&#34;${n}&#34;&gt;${n &gt; 0 ? n : &#39;&#39;}&lt;/div&gt;`
                    ).join(&#39;&#39;);
                } else {
                    gridHTML = &#39;&lt;p style=&#34;text-align:center; padding: 1rem; color: red;&#34;&gt;Visual ticket data missing.&lt;/p&gt;&#39;;
                }
            } else {
                gridHTML = &#39;&lt;p style=&#34;text-align:center; padding: 1rem;&#34;&gt;Data missing&lt;/p&gt;&#39;;
            }

            ticketView.innerHTML = `${headerHTML}&lt;div class=&#34;ticket-grid&#34;&gt;${gridHTML}&lt;/div&gt;`;
            sheetContent.appendChild(ticketView);
        }
        gridContainer.appendChild(sheetWrapper);
    }
}

function selectFullSheet(checkbox, startId, endId) {
    for (let id = startId; id &lt;= endId; id++) {
        const ticketView = document.getElementById(`booking-ticket-${id}`);
        if (ticketView &amp;&amp; !ticketView.classList.contains(&#39;sold&#39;)) {
            const isSelected = publicSelectedTickets.includes(id);
            if (checkbox.checked &amp;&amp; !isSelected) {
                togglePublicTicketSelection(id);
            } else if (!checkbox.checked &amp;&amp; isSelected) {
                togglePublicTicketSelection(id);
            }
        }
    }
}

function togglePublicTicketSelection(ticketId) {
    const ticketView = document.getElementById(`booking-ticket-${ticketId}`);
    if (!ticketView || ticketView.classList.contains(&#39;sold&#39;)) return;

    const index = publicSelectedTickets.indexOf(ticketId);
    if (index &gt; -1) {
        publicSelectedTickets.splice(index, 1);
        ticketView.classList.remove(&#39;selected&#39;);
    } else {
        publicSelectedTickets.push(ticketId);
        ticketView.classList.add(&#39;selected&#39;);
    }
    updatePublicSelectionIndicator();
    
    const footer = document.getElementById(&#39;publicBookingActionFooter&#39;);
    if (footer) {
        if (publicSelectedTickets.length &gt; 0) {
            footer.classList.add(&#39;visible&#39;);
        } else {
            footer.classList.remove(&#39;visible&#39;);
        }
    }
}


function updatePublicSelectionIndicator() {
    const indicator = document.getElementById(&#39;publicSelectionIndicator&#39;);
    if (!indicator) return;
    const result = checkSheetSelection(publicSelectedTickets);
    indicator.textContent = result.message || &#39;Select tickets to see booking options&#39;;
    indicator.style.borderColor = result.valid ? &#39;var(--accent-primary)&#39; : &#39;var(--accent-secondary)&#39;;
}


function handlePublicBookingRequest() {
    const name = document.getElementById(&#39;bookerName&#39;).value.trim();
    const phone = document.getElementById(&#39;bookerPhone&#39;).value.trim();
    if (!name || !phone) return showNotification(&#39;Please enter your name and mobile number.&#39;, &#39;error&#39;);
    if (publicSelectedTickets.length === 0) return showNotification(&#39;Please select at least one ticket.&#39;, &#39;error&#39;);

    openAgentSelectorForWhatsApp(name, phone, publicSelectedTickets);
}

async function openAgentSelectorForWhatsApp(userName, userPhone, selectedTickets) {
    const container = document.getElementById(&#39;bookingAgentListContainer&#39;);
    container.innerHTML = &#39;&#39;;
    const agents = allUsersData.filter(u =&gt; u.role === &#39;admin&#39; || u.role === &#39;agent&#39;).sort((a, b) =&gt; {
        if (a.role === &#39;admin&#39; &amp;&amp; b.role !== &#39;admin&#39;) return -1;
        if (a.role !== &#39;admin&#39; &amp;&amp; b.role === &#39;admin&#39;) return 1;
        return (a.name || &#39;&#39;).localeCompare(b.name || &#39;&#39;);
    });
    if (agents.length &gt; 0) {
        agents.forEach(agent =&gt; {
            const link = document.createElement(&#39;a&#39;);
            link.href = &#39;#&#39;;
            link.onclick = async (e) =&gt; { e.preventDefault(); await redirectToWhatsApp(agent.phone, userName, userPhone, selectedTickets); };
            link.innerHTML = `${agent.name}&lt;i class=&#34;fab fa-whatsapp&#34;&gt;&lt;/i&gt;`;
            container.appendChild(link);
        });
        showPopup(&#39;agentSelectionPopup&#39;);
    } else {
        showNotification(&#39;No agents are available to handle bookings.&#39;, &#39;info&#39;);
    }
}

function generateUniqueCode() {
    const chars = &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;
    let result = &#39;&#39;;
    for (let i = 0; i &lt; 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

async function redirectToWhatsApp(agentPhone, userName, userPhone, ticketIds) {
    const code = generateUniqueCode();
    const bookingRequest = {
        name: userName,
        phone: userPhone,
        tickets: ticketIds,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        requestedBy: &#34;public_user&#34;
    };

    try {
        const snapshot = await db.ref(`bookingRequests/${code}`).once(&#39;value&#39;);
        if (snapshot.exists()) {
            return redirectToWhatsApp(agentPhone, userName, userPhone, ticketIds); // Recurse on collision
        }

        await db.ref(`bookingRequests/${code}`).set(bookingRequest);

        const baseURL = window.location.origin + window.location.pathname;
        const bookingLink = `${baseURL}?book=${code}`;

        const ticketNumbers = ticketIds.sort((a, b) =&gt; a - b).join(&#39;, &#39;);
        
        const message = `Hello, I would like to book tickets.\n\n*Name*: ${userName}\n*Phone*: ${userPhone}\n*Selected Tickets*: ${ticketNumbers}\n\n*Click this link to confirm (Admin/Agent Only):*\n${bookingLink}`;
        
        const cleanPhone = agentPhone.replace(/\D/g, &#39;&#39;);
        window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`, &#39;_blank&#39;);
        closePopups();

    } catch (error) {
        console.error(&#34;Error creating booking link:&#34;, error);
        showNotification(&#34;Could not create booking link. Please try again.&#34;, &#34;error&#34;);
    }
}

async function processBookingLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const bookingCode = urlParams.get(&#39;book&#39;);
    
    if (!bookingCode) return;

    document.querySelectorAll(&#39;.view&#39;).forEach(v =&gt; v.classList.remove(&#39;active&#39;));
    
    const popup = document.getElementById(&#39;bookingSuccessPopup&#39;);
    const titleEl = document.getElementById(&#39;bookingSuccessTitle&#39;);
    const messageEl = document.getElementById(&#39;bookingSuccessMessage&#39;);
    const checkmarkSVG = popup.querySelector(&#39;.checkmark&#39;);

    titleEl.textContent = &#39;Processing Booking...&#39;;
    messageEl.innerHTML = &#39;&lt;i class=&#34;fas fa-spinner fa-spin fa-2x&#34;&gt;&lt;/i&gt;&lt;p style=&#34;margin-top: 1rem;&#34;&gt;Please wait while we confirm the booking.&lt;/p&gt;&#39;;
    if (checkmarkSVG) checkmarkSVG.style.display = &#39;none&#39;;
    
    showPopup(&#39;bookingSuccessPopup&#39;);

    window.history.replaceState({}, document.title, window.location.pathname);

    const handleErrorAndCleanup = (msg) =&gt; {
        closePopups();
        showNotification(msg, &#39;error&#39;);
        handleRouting();
    };

    const startTime = Date.now();
    while (!authInitialized &amp;&amp; Date.now() - startTime &lt; 8000) {
        await new Promise(resolve =&gt; setTimeout(resolve, 100));
    }
    
    if (!currentUserRole || (currentUserRole !== &#39;admin&#39; &amp;&amp; currentUserRole !== &#39;agent&#39;)) {
        handleErrorAndCleanup(&#39;You must be logged in as an Admin or Agent to confirm a booking.&#39;);
        showPopup(&#39;loginPopup&#39;);
        return;
    }

    while (allTicketsData.length === 0 &amp;&amp; Date.now() - startTime &lt; 15000) {
        await new Promise(resolve =&gt; setTimeout(resolve, 100));
    }
    if (allTicketsData.length === 0) {
        handleErrorAndCleanup(&#39;Could not load ticket data. Please refresh and try again.&#39;);
        return;
    }
    
    const requestRef = db.ref(`bookingRequests/${bookingCode}`);
    try {
        const snapshot = await requestRef.once(&#39;value&#39;);
        if (!snapshot.exists()) {
            handleErrorAndCleanup(&#39;This booking link is invalid or has already been used.&#39;);
            return;
        }

        const requestData = snapshot.val();
        const { name, phone, tickets: ticketIdsToBook } = requestData;

        if (!name || !phone || !Array.isArray(ticketIdsToBook) || ticketIdsToBook.length === 0) {
            handleErrorAndCleanup(&#39;Invalid data in booking link.&#39;);
            await requestRef.remove();
            return;
        }

        const alreadySold = [];
        for (const id of ticketIdsToBook) {
            const ticketData = allTicketsData.find(t =&gt; t.id === id);
            if (ticketData &amp;&amp; ticketData.is_sold) {
                alreadySold.push(id);
            }
        }
        
        if (alreadySold.length &gt; 0) {
             handleErrorAndCleanup(`Cannot book. Ticket(s) ${alreadySold.join(&#39;, &#39;)} are already sold.`);
             await requestRef.remove();
             return;
        }

        const updates = {};
        const timestamp = firebase.database.ServerValue.TIMESTAMP;
        ticketIdsToBook.forEach(id =&gt; {
            updates[`/tickets/${id}/is_sold`] = true;
            updates[`/tickets/${id}/owner_name`] = name;
            updates[`/tickets/${id}/owner_name_lower`] = name.toLowerCase();
            updates[`/tickets/${id}/owner_phone`] = phone;
            updates[`/tickets/${id}/agent_uid`] = currentUser.uid;
            updates[`/tickets/${id}/sold_at`] = timestamp;
        });

        await db.ref().update(updates);
        await requestRef.remove();

        const successMsg = `${ticketIdsToBook.length} ticket(s) successfully booked for ${name}. Redirecting to dashboard...`;
        
        titleEl.textContent = &#39;Booking Successful!&#39;;
        messageEl.textContent = successMsg;
        
        if (checkmarkSVG) {
            checkmarkSVG.style.display = &#39;block&#39;;
            const circle = popup.querySelector(&#39;.checkmark__circle&#39;);
            const check = popup.querySelector(&#39;.checkmark__check&#39;);
            checkmarkSVG.style.animation = &#39;none&#39;;
            circle.style.animation = &#39;none&#39;;
            check.style.animation = &#39;none&#39;;
            void checkmarkSVG.offsetWidth; 
            checkmarkSVG.style.animation = &#39;fill_anim 0.4s ease-in-out 0.4s forwards, scale_anim 0.3s ease-in-out 0.9s both&#39;;
            circle.style.animation = &#39;stroke_anim 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards&#39;;
            check.style.animation = &#39;stroke_anim 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards&#39;;
        }

        triggerGlobalNotification(`${ticketIdsToBook.length} ticket(s) just booked for ${name}.`, &#39;info&#39;);

        setTimeout(() =&gt; {
            if (currentUserRole) {
                window.location.hash = currentUserRole;
            } else {
                handleRouting();
            }
        }, 4000);

    } catch(e) {
        handleErrorAndCleanup(&#39;Error processing booking: &#39; + e.message);
        await requestRef.remove().catch(err =&gt; console.error(&#34;Failed to cleanup requestRef on error&#34;, err));
    }
}

function searchTicketPublic(searchTermOverride = null, isRerender = false) {
    const searchTerm = searchTermOverride || document.getElementById(&#39;ticketSearchInp&#39;).value.trim();
    if (!searchTerm) return;
    
    let ticketsToDisplay = [];
    const searchNumber = parseInt(searchTerm, 10);

    if (!isNaN(searchNumber) &amp;&amp; searchTerm.toString().match(/^\d+$/)) {
        const initialTicket = allTicketsData.find(t =&gt; t.id === searchNumber &amp;&amp; t.is_sold);
        if (initialTicket) {
            ticketsToDisplay = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp; t.owner_phone === initialTicket.owner_phone);
        }
    } else {
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        ticketsToDisplay = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp;
            ((t.owner_name_lower || &#39;&#39;).includes(lowerCaseSearchTerm) || (t.owner_phone || &#39;&#39;).includes(lowerCaseSearchTerm))
        );
    }
    
    if (ticketsToDisplay.length &gt; 0) {
        const ownerPhone = ticketsToDisplay[0].owner_phone;
        const ownerName = ticketsToDisplay[0].owner_name;

        if (displayedSearchPhones.has(ownerPhone) &amp;&amp; !isRerender) {
            showNotification(`${ownerName}&#39;s tickets are already displayed.`, &#39;info&#39;);
            return;
        }
        
        displayedSearchPhones.add(ownerPhone);

        const groupWrapper = document.createElement(&#39;div&#39;);
        groupWrapper.className = &#39;search-result-group&#39;;
        groupWrapper.dataset.phone = ownerPhone;
        
        let ticketsHTML = &#39;&#39;;
        ticketsToDisplay.sort((a, b) =&gt; a.id - b.id).forEach(ticket =&gt; {
            let gridHTML;
            if (ticket &amp;&amp; Array.isArray(ticket.numbers) &amp;&amp; ticket.numbers.length &gt; 0) {
                 gridHTML = ticket.numbers.flat().map(n =&gt;
                    `&lt;div class=&#34;ticket-num ${n &gt; 0 ? &#39;&#39; : &#39;empty&#39;}&#34; data-num=&#34;${n}&#34;&gt;${n &gt; 0 ? n : &#39;&#39;}&lt;/div&gt;`
                ).join(&#39;&#39;);
            } else {
                gridHTML = &#39;&lt;p style=&#34;text-align:center; padding: 1rem; color: red;&#34;&gt;Visual ticket data missing.&lt;/p&gt;&#39;;
            }
            
            ticketsHTML += `&lt;div class=&#34;ticket-view&#34; data-ticket-id=&#34;${ticket.id}&#34;&gt;
                        &lt;div class=&#34;ticket-header&#34;&gt;Ticket ${ticket.id}: ${ticket.owner_name}&lt;/div&gt;
                        &lt;div class=&#34;ticket-grid&#34;&gt;${gridHTML}&lt;/div&gt;
                    &lt;/div&gt;`;
        });

        groupWrapper.innerHTML = `&lt;button class=&#34;clear-search-btn&#34; onclick=&#34;clearSearchResult(&#39;${ownerPhone}&#39;)&#34; title=&#34;Clear this result&#34;&gt;&amp;times;&lt;/button&gt;${ticketsHTML}`;
        document.getElementById(&#39;ticketDisplayArea&#39;).appendChild(groupWrapper);
        updateDisplayedTicketPublic();
    } else if (!isRerender) {
        showNotification(&#39;No tickets found for that search term.&#39;, &#39;error&#39;);
    }
}

function clearSearchResult(phone) {
    const group = document.querySelector(`.search-result-group[data-phone=&#34;${phone}&#34;]`);
    if (group) group.remove();
    displayedSearchPhones.delete(phone);
}

function updateDisplayedTicketPublic() {
    document.querySelectorAll(&#39;#ticketDisplayArea .ticket-view, #bookedTicketsDisplay .ticket-view&#39;).forEach(ticketView =&gt; {
        ticketView.querySelectorAll(&#39;.ticket-num[data-num]&#39;).forEach(cell =&gt; {
            const num = parseInt(cell.dataset.num, 10);
            if (num &gt; 0) {
                 const isCalled = currentCalledNumbers.includes(num);
                 cell.classList.toggle(&#39;ticked&#39;, isCalled);
                cell.classList.remove(&#39;last-called-highlight&#39;);
                if (num === lastAnnouncedNumber) {
                     cell.classList.add(&#39;last-called-highlight&#39;);
                }
            }
        });
    });
}

function populateDividendList(dividends) {
    const tbodies = document.querySelectorAll(&#39;#dividendListTable tbody, #runGameDividendTable tbody&#39;);
    if(tbodies.length === 0) return;
    
    const rowsHTML = (dividends || [])
        .map(d =&gt; `&lt;tr data-dividend-name=&#34;${d.name.replace(/\s+/g, &#39;-&#39;)}&#34;&gt;
                      &lt;td&gt;${d.name} &lt;span style=&#34;font-size:0.8em; color: var(--text-secondary);&#34;&gt;(${d.amount || 0})&lt;/span&gt;&lt;/td&gt;
                      &lt;td class=&#34;winner-info&#34;&gt;&lt;span class=&#34;winner-name&#34;&gt;Pending...&lt;/span&gt;&lt;/td&gt;
                  &lt;/tr&gt;`)
        .join(&#39;&#39;);

    tbodies.forEach(tbody =&gt; tbody.innerHTML = rowsHTML);
}

function updateWinners(winners) {
    const tables = document.querySelectorAll(&#39;#dividendListTable, #runGameDividendTable&#39;);
    
    tables.forEach(table =&gt; {
        table.querySelectorAll(&#39;.winner-info&#39;).forEach(el =&gt; {
            el.innerHTML = `&lt;span class=&#34;winner-name&#34;&gt;Pending...&lt;/span&gt;`;
        });
    });

    for (const name in winners) {
        const winnerArray = winners[name];
        if (!Array.isArray(winnerArray) || winnerArray.length === 0) continue;

        const dividendData = (gameSettingsData.dividends || []).find(d =&gt; d.name === name);
        const totalAmount = dividendData ? dividendData.amount : 0;
        const shareText = winnerArray.length &gt; 1 ? `&lt;span class=&#34;prize-share&#34;&gt;(${(totalAmount / winnerArray.length).toFixed(2)} each)&lt;/span&gt;` : &#39;&#39;;
        
        const winnerListHTML = `&lt;ul&gt;` + winnerArray.map(w =&gt; 
            `&lt;li&gt;&lt;span class=&#34;winner-name&#34;&gt;${w.name}&lt;/span&gt; (Tkt: ${w.ticketId})&lt;/li&gt;`
        ).join(&#39;&#39;) + `&lt;/ul&gt;`;

        let eyeIcon = &#39;&#39;;
        if (winnerArray.length &gt; 0) {
            const safeName = name.replace(/&#39;/g, &#34;\\&#39;&#34;);
            eyeIcon = `&lt;i class=&#34;fas fa-eye&#34; onclick=&#34;showAllWinningTicketsForDividend(&#39;${safeName}&#39;)&#34;&gt;&lt;/i&gt;`;
        }
        
        const finalHTML = `&lt;div class=&#34;winner-details&#34;&gt;${winnerListHTML} ${shareText}&lt;/div&gt; ${eyeIcon}`;

        tables.forEach(table =&gt; {
            const row = table.querySelector(`tr[data-dividend-name=&#34;${name.replace(/\s+/g, &#39;-&#39;)}&#34;]`);
            if (row) {
                const winnerCell = row.querySelector(&#39;.winner-info&#39;);
                if (winnerCell) winnerCell.innerHTML = finalHTML;
            }
        });
    }
}


function updateNumberBoard(called) {
    const lastCalled = called.length &gt; 0 ? called[called.length - 1] : null;
    for (let i = 1; i &lt;= 90; i++) {
        const isCalled = called.includes(i);
        const publicCell = document.getElementById(`num-${i}`);
        if(publicCell){
            publicCell.classList.toggle(&#39;called&#39;, isCalled);
            publicCell.classList.toggle(&#39;last-called-highlight&#39;, i === lastCalled);
        }

        const adminCell = document.getElementById(`run-game-popup-num-${i}`);
        if(adminCell){
            adminCell.classList.toggle(&#39;called&#39;, isCalled);
            adminCell.classList.toggle(&#39;last-called-highlight&#39;, i === lastCalled);
        }
    }
}

function updateCalledNumbersList(called) {
    const listEl = document.getElementById(&#39;calledNumbersList&#39;);
    if(listEl) {
        listEl.innerHTML = (called.length &gt; 0)
            ? called.slice().reverse().map(n =&gt; `&lt;div class=&#34;called-num-chip&#34;&gt;${n}&lt;/div&gt;`).join(&#39;&#39;)
            : &#39;&lt;span&gt;Game has not started...&lt;/span&gt;&#39;;
    }
}

function goToBooking(ticketId) {
    window.location.hash = &#39;book&#39;;
    setTimeout(() =&gt; {
        const ticketView = document.getElementById(`booking-ticket-${ticketId}`);
        if(ticketView &amp;&amp; !ticketView.classList.contains(&#39;sold&#39;)) {
           togglePublicTicketSelection(ticketId);
           ticketView.scrollIntoView({ behavior: &#39;smooth&#39;, block: &#39;center&#39; });
        }
    }, 200);
}

function renderSheetWiseBookedList() {
    const container = document.getElementById(&#39;bookedTicketsDisplay&#39;);
    if (!container) return;

    if (!gameSettingsData || !gameSettingsData.totalTickets) {
        container.innerHTML = &#39;&lt;p style=&#34;text-align:center;&#34;&gt;Ticket data is currently unavailable.&lt;/p&gt;&#39;;
        return;
    }

    const totalTickets = gameSettingsData.totalTickets;
    const allTicketsMap = new Map(allTicketsData.map(t =&gt; [t.id, t]));
    container.innerHTML = &#39;&#39;;

    if (allTicketsMap.size === 0) {
        container.innerHTML = &#39;&lt;p style=&#34;text-align:center; font-style: italic; color: #01579b;&#34;&gt;No tickets have been generated by the admin.&lt;/p&gt;&#39;;
        return;
    }

    const numSheets = Math.ceil(totalTickets / 6);

    for (let i = 0; i &lt; numSheets; i++) {
        const startTicket = i * 6 + 1;
        const endTicket = startTicket + 5;

        const sheetWrapper = document.createElement(&#39;div&#39;);
        sheetWrapper.className = &#39;sheet-view&#39;;

        const sheetHeader = document.createElement(&#39;div&#39;);
        sheetHeader.className = &#39;sheet-header&#39;;
        sheetHeader.textContent = `Sheet ${i + 1} (Tickets ${startTicket}-${endTicket})`;
        sheetWrapper.appendChild(sheetHeader);

        const sheetContent = document.createElement(&#39;div&#39;);
        sheetContent.className = &#39;sheet-content&#39;;
        sheetWrapper.appendChild(sheetContent);

        for (let j = startTicket; j &lt;= endTicket; j++) {
            const ticket = allTicketsMap.get(j);
            const ticketViewWrapper = document.createElement(&#39;div&#39;);
            const ticketView = document.createElement(&#39;div&#39;);
            ticketView.className = &#39;ticket-view&#39;;
            ticketView.setAttribute(&#39;data-ticket-id&#39;, j);

            if (!ticket) {
                ticketView.innerHTML = `&lt;div class=&#34;ticket-header&#34;&gt;Ticket ${j} Data Missing&lt;/div&gt;`;
            } else {
                 let headerHTML;
                if (ticket.is_sold) {
                    headerHTML = `&lt;div class=&#34;ticket-header&#34;&gt;&lt;div&gt;${ticket.owner_name}&lt;/div&gt;&lt;span style=&#34;font-weight:normal;&#34;&gt;Ticket ${j}&lt;/span&gt;&lt;/div&gt;`;
                } else {
                    headerHTML = `
                        &lt;div class=&#34;ticket-header&#34;&gt;
                            &lt;span&gt;Ticket ${j}&lt;/span&gt;
                            &lt;button class=&#34;book-now-btn-small&#34; onclick=&#34;goToBooking(${j})&#34;&gt;Book Now&lt;/button&gt;
                        &lt;/div&gt;`;
                }
                
                let gridHTML;
                if (Array.isArray(ticket.numbers) &amp;&amp; ticket.numbers.length &gt; 0) {
                    gridHTML = ticket.numbers.flat().map(n =&gt;
                        `&lt;div class=&#34;ticket-num ${n &gt; 0 ? &#39;&#39; : &#39;empty&#39;}&#34; data-num=&#34;${n}&#34;&gt;${n &gt; 0 ? n : &#39;&#39;}&lt;/div&gt;`
                    ).join(&#39;&#39;);
                } else {
                    gridHTML = &#39;&lt;p style=&#34;text-align:center; padding: 1rem; color: red;&#34;&gt;Visual ticket data missing.&lt;/p&gt;&#39;;
                }

                ticketView.innerHTML = `${headerHTML}&lt;div class=&#34;ticket-grid&#34;&gt;${gridHTML}&lt;/div&gt;`;
            }
            ticketViewWrapper.appendChild(ticketView);
            sheetContent.appendChild(ticketViewWrapper);
        }
        container.appendChild(sheetWrapper);
    }

    updateDisplayedTicketPublic();
}

function showAllWinningTicketsForDividend(dividendName) {
    const winnerArray = knownWinners[dividendName];
    if (!winnerArray || winnerArray.length === 0) {
        return showNotification(&#34;Winner information not found for this dividend.&#34;, &#34;error&#34;);
    }

    const displayArea = document.getElementById(&#39;winningTicketDisplayArea&#39;);
    const title = document.getElementById(&#39;winningTicketPopupTitle&#39;);
    
    title.textContent = `${dividendName} Winner(s)`;
    let allTicketsHTML = &#39;&#39;;

    winnerArray.forEach(winner =&gt; {
        const winningNumber = winner.winningNumber;
        const ticketId = winner.ticketId;
        
        allTicketsHTML += `&lt;h4 style=&#34;color: #01579b; margin-top: 1rem; text-align: center; border-bottom: 1px solid #b3e5fc; padding-bottom: 0.5rem;&#34;&gt;${winner.name} (${typeof ticketId === &#39;number&#39; ? `Tkt ${ticketId}` : ticketId})&lt;/h4&gt;`;
        
        let ticketsToDisplay = [];

        if (typeof ticketId === &#39;string&#39; &amp;&amp; ticketId.toLowerCase().includes(&#39;sheet&#39;)) {
            if (ticketId.toLowerCase().includes(&#39;full sheet&#39;)) {
                const ticketIdsMatch = ticketId.match(/\(([^)]+)\)/);
                if (ticketIdsMatch &amp;&amp; ticketIdsMatch[1]) {
                    const fullSheetTicketIds = ticketIdsMatch[1].split(&#39;,&#39;).map(Number);
                    ticketsToDisplay = allTicketsData.filter(t =&gt; fullSheetTicketIds.includes(t.id));
                }
            } else if (ticketId.toLowerCase().includes(&#39;half sheet&#39;)) {
                const ticketIdsMatch = ticketId.match(/\(([^)]+)\)/);
                if (ticketIdsMatch &amp;&amp; ticketIdsMatch[1]) {
                    const halfSheetTicketIds = ticketIdsMatch[1].split(&#39;,&#39;).map(Number);
                    ticketsToDisplay = allTicketsData.filter(t =&gt; halfSheetTicketIds.includes(t.id));
                }
            }
        } else {
            const singleTicket = allTicketsData.find(t =&gt; t.id == ticketId);
            if (singleTicket) {
                ticketsToDisplay.push(singleTicket);
            }
        }

        if (ticketsToDisplay.length &gt; 0) {
            ticketsToDisplay.sort((a, b) =&gt; a.id - b.id).forEach(ticket =&gt; {
                let gridHTML;
                if (ticket &amp;&amp; Array.isArray(ticket.numbers) &amp;&amp; ticket.numbers.length &gt; 0) {
                    gridHTML = ticket.numbers.flat().map(n =&gt; {
                        const isCalled = n &gt; 0 &amp;&amp; currentCalledNumbers.includes(n);
                        const isWinningStrike = n === winningNumber;
                        const classes = `ticket-num ${n &gt; 0 ? &#39;&#39; : &#39;empty&#39;} ${isCalled ? &#39;ticked&#39; : &#39;&#39;} ${isWinningStrike ? &#39;winning-strike&#39; : &#39;&#39;}`;
                        return `&lt;div class=&#34;${classes}&#34; data-num=&#34;${n}&#34;&gt;${n &gt; 0 ? n : &#39;&#39;}&lt;/div&gt;`;
                    }).join(&#39;&#39;);
                } else {
                     gridHTML = &#39;&lt;p style=&#34;text-align:center; padding: 1rem; color: red;&#34;&gt;Visual ticket data missing.&lt;/p&gt;&#39;;
                }


                allTicketsHTML += `&lt;div class=&#34;ticket-view&#34; data-ticket-id=&#34;${ticket.id}&#34; style=&#34;margin: 1rem 0;&#34;&gt;
                                    &lt;div class=&#34;ticket-header&#34;&gt;Ticket ${ticket.id}&lt;/div&gt;
                                    &lt;div class=&#34;ticket-grid&#34;&gt;${gridHTML}&lt;/div&gt;
                               &lt;/div&gt;`;
            });
        } else {
             allTicketsHTML += `&lt;p style=&#34;text-align:center; color:#e74c3c; padding:1rem;&#34;&gt;Could not find the visual ticket data for this winner.&lt;/p&gt;`;
        }
    });

    displayArea.innerHTML = allTicketsHTML;
    showPopup(&#39;winningTicketViewerPopup&#39;);
}

function toggleDividendAmountInput(checkbox) {
    const amountInput = checkbox.closest(&#39;td&#39;).querySelector(&#39;.dividend-amount&#39;);
    if (amountInput) {
        amountInput.disabled = !checkbox.checked;
        if (!checkbox.checked) {
            amountInput.value = &#39;&#39;;
        }
    }
}

function updateAdminSettingsUI(data) {
    if (currentView !== &#39;adminDashboardView&#39;) return;
    document.getElementById(&#39;dateTimeInp&#39;).value = data.gameDateTime || &#39;&#39;;
    document.getElementById(&#39;totalTicketInp&#39;).value = data.totalTickets || 600;
    document.getElementById(&#39;ticketPriceInp&#39;).value = data.ticketPrice || 0;
    document.getElementById(&#39;agentCommissionInp&#39;).value = data.agentCommission || 0;

    const table = document.getElementById(&#39;dividendSettingsTable&#39;);
    table.innerHTML = `
        &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Dividend Name &amp; Amount&lt;/th&gt;&lt;th&gt;Active&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
        &lt;tbody&gt;
            ${allPossibleDividends.map(name =&gt; {
                const dividendData = (data.dividends || []).find(d =&gt; d.name === name);
                const isChecked = !!dividendData;
                const amount = dividendData ? dividendData.amount || &#39;&#39; : &#39;&#39;;
                return `
                    &lt;tr&gt;
                        &lt;td&gt;
                            &lt;span class=&#34;dividend-name-text&#34;&gt;${name}&lt;/span&gt;
                            &lt;input class=&#34;tableInp dividend-amount&#34; type=&#34;number&#34; placeholder=&#34;Amount&#34; value=&#34;${amount}&#34; ${!isChecked ? &#39;disabled&#39; : &#39;&#39;}&gt;
                            &lt;input class=&#34;tableCheckbox dividend-active&#34; type=&#34;checkbox&#34; data-name=&#34;${name}&#34; ${isChecked ? &#39;checked&#39; : &#39;&#39;} onchange=&#34;toggleDividendAmountInput(this)&#34;&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
            }).join(&#39;&#39;)}
        &lt;/tbody&gt;`;
}

function updateAdminInfoUI() {
    if (currentView !== &#39;adminDashboardView&#39; || !currentUser) return;
    const adminData = allUsersData.find(u =&gt; u.uid === currentUser.uid);
    if(adminData){
        document.getElementById(&#39;adminNameInp&#39;).value = adminData.name || &#39;&#39;;
        document.getElementById(&#39;adminPhoneInp&#39;).value = adminData.phone || &#39;&#39;;
    }
    document.getElementById(&#39;adminWpLinkInp&#39;).value = gameSettingsData.whatsappLink || &#39;&#39;;
}

async function saveGameSetting() {
    const oldTotalTickets = gameSettingsData.totalTickets || 0;
    const newTotalTickets = parseInt(document.getElementById(&#39;totalTicketInp&#39;).value, 10);

    const settingsToSave = {
        gameDateTime: document.getElementById(&#39;dateTimeInp&#39;).value,
        totalTickets: newTotalTickets,
        ticketPrice: parseInt(document.getElementById(&#39;ticketPriceInp&#39;).value, 10),
        agentCommission: parseInt(document.getElementById(&#39;agentCommissionInp&#39;).value, 10),
    };

    if (oldTotalTickets !== newTotalTickets &amp;&amp; newTotalTickets &gt; 0) {
        const confirmText = document.getElementById(&#39;ticketResetConfirmText&#39;);
        confirmText.innerHTML = `You are changing the ticket count from &lt;b&gt;${oldTotalTickets}&lt;/b&gt; to &lt;b&gt;${newTotalTickets}&lt;/b&gt;. &lt;br/&gt;&lt;br/&gt; &#39;Adjust&#39; will add/remove tickets without affecting existing bookings. &lt;br/&gt; &#39;Reset&#39; will delete all tickets and generate new ones.`;

        document.getElementById(&#39;confirmResetBtn&#39;).onclick = async () =&gt; {
            closePopups();
            await db.ref(&#39;settings/gameConfig&#39;).update(settingsToSave);
            await generateHousieTickets(true);
            showNotification(&#39;Settings saved and all tickets regenerated.&#39;, &#39;success&#39;);
        };

        document.getElementById(&#39;confirmNoResetBtn&#39;).onclick = async () =&gt; {
            closePopups();
            await db.ref(&#39;settings/gameConfig&#39;).update(settingsToSave);
            await updateTicketCountWithoutReset(newTotalTickets, oldTotalTickets);
            showNotification(&#39;Settings saved and ticket count adjusted.&#39;, &#39;success&#39;);
        };

        showPopup(&#39;ticketResetConfirmPopup&#39;);
    } else {
        try {
            await db.ref(&#39;settings/gameConfig&#39;).update(settingsToSave);
            showNotification(&#39;Game settings saved successfully!&#39;, &#39;success&#39;);
            await triggerGlobalNotification(&#39;Admin has updated the game settings.&#39;, &#39;info&#39;);
        } catch (e) {
            showNotification(&#39;Error saving settings: &#39; + e.message, &#39;error&#39;);
        }
    }
}

async function updateTicketCountWithoutReset(newCount, oldCount) {
    if (newCount &gt; oldCount) {
        showNotification(`Adding ${newCount - oldCount} new tickets...`, &#39;info&#39;);
        await appendNewTickets(newCount, oldCount);
    } else if (newCount &lt; oldCount) {
        const soldTicketsInRange = allTicketsData.filter(t =&gt; t.id &gt; newCount &amp;&amp; t.is_sold);
        if (soldTicketsInRange.length &gt; 0) {
            showNotification(`Cannot decrease count. ${soldTicketsInRange.length} ticket(s) are already sold in the range you are removing. Please reset tickets instead.`, &#39;error&#39;);
            await db.ref(&#39;settings/gameConfig/totalTickets&#39;).set(oldCount);
            return;
        }
        showNotification(`Removing ${oldCount - newCount} tickets from the end.`, &#39;info&#39;);
        const updates = {};
        for (let i = newCount + 1; i &lt;= oldCount; i++) {
            updates[`/tickets/${i}`] = null;
        }
        await db.ref().update(updates);
    }
}

async function appendNewTickets(newCount, oldCount) {
    const numSetsToAdd = Math.ceil((newCount - oldCount) / 6);
    if (numSetsToAdd &lt;= 0) return;

    showNotification(`Generating ${numSetsToAdd * 6} new tickets...`, &#39;info&#39;);
    try {
        const updates = {};
        for (let i = 0; i &lt; numSetsToAdd; i++) {
            const currentSet = createTambolaSetOf6();
            for (let j = 0; j &lt; 6; j++) {
                const ticketId = oldCount + (i * 6) + j + 1;
                if (ticketId &gt; newCount) continue;
                updates[ticketId] = {
                    id: ticketId,
                    numbers: currentSet[j],
                    is_sold: false,
                    owner_name: null, owner_name_lower: null, owner_phone: null, agent_uid: null
                };
            }
        }
        await db.ref(&#39;/tickets&#39;).update(updates);
        showNotification(&#39;New tickets added successfully!&#39;, &#39;success&#39;);
    } catch (e) {
        showNotification(&#39;Error appending new tickets: &#39; + e.message, &#39;error&#39;);
    }
}

async function saveDividendSettings() {
    const activeDividends = [];
    let hasError = false;
    document.querySelectorAll(&#39;#dividendSettingsTable tbody tr&#39;).forEach(row =&gt; {
        const checkbox = row.querySelector(&#39;.dividend-active&#39;);
        if (checkbox.checked) {
            const name = checkbox.dataset.name;
            const amountInput = row.querySelector(&#39;.dividend-amount&#39;);
            const amount = parseInt(amountInput.value, 10);

            if (isNaN(amount) || amount &lt;= 0) {
                showNotification(`Please enter a valid, positive amount for &#39;${name}&#39;.`, &#39;error&#39;);
                amountInput.style.border = &#39;2px solid red&#39;;
                hasError = true;
            } else {
                 amountInput.style.border = &#39;1px solid var(--secondary-bg-dash)&#39;;
                 activeDividends.push({
                    name: name,
                    amount: amount
                });
            }
        }
    });

    if (hasError) {
        return; 
    }

    try {
        await db.ref(&#39;settings/gameConfig/dividends&#39;).set(activeDividends);
        showNotification(&#39;Dividend settings saved!&#39;, &#39;success&#39;);
        await triggerGlobalNotification(&#39;Admin has updated the dividend settings.&#39;, &#39;info&#39;);
    } catch (e) { showNotification(&#39;Error saving dividends: &#39; + e.message, &#39;error&#39;); }
}

async function saveAdminInfo() {
    if(!currentUser) return;
    try {
        const newPass = document.getElementById(&#39;adminPassInp&#39;).value;
        if(newPass &amp;&amp; newPass.length &lt; 6) return showNotification(&#34;Password must be at least 6 characters.&#34;, &#39;error&#39;);

        const updates = {};
        updates[`users/${currentUser.uid}/name`] = document.getElementById(&#39;adminNameInp&#39;).value;
        updates[`users/${currentUser.uid}/phone`] = document.getElementById(&#39;adminPhoneInp&#39;).value;
        updates[&#39;settings/gameConfig/whatsappLink&#39;] = document.getElementById(&#39;adminWpLinkInp&#39;).value;

        await db.ref().update(updates);

        if(newPass){
            await currentUser.updatePassword(newPass);
            showNotification(&#34;Admin info and password updated!&#34;, &#39;success&#39;);
        } else {
            showNotification(&#39;Admin info updated!&#39;, &#39;success&#39;);
        }
        await triggerGlobalNotification(&#39;Admin info has been updated.&#39;, &#39;info&#39;);
        document.getElementById(&#39;adminPassInp&#39;).value = &#39;&#39;;
    } catch(e) {
        showNotification(&#34;Error updating info: &#34; + e.message, &#39;error&#39;);
    }
}

async function createAgentByAdmin() {
    if (currentUserRole !== &#39;admin&#39;) return showNotification(&#34;Only admins can create agents.&#34;, &#39;error&#39;);

    const name = document.getElementById(&#39;createAgentNameInp&#39;).value.trim();
    const email = document.getElementById(&#39;createAgentEmailInp&#39;).value.trim();
    const phone = document.getElementById(&#39;createAgentPhoneInp&#39;).value.trim();
    const pass = document.getElementById(&#39;createAgentPassInp&#39;).value;

    if (!name || !email || !phone || !pass) return showNotification(&#39;Please fill all fields for the new agent.&#39;, &#39;error&#39;);
    if (pass.length &lt; 6) return showNotification(&#34;Password must be at least 6 characters.&#34;, &#39;error&#39;);

    const secondaryApp = firebase.initializeApp(firebaseConfig, &#39;agent-creator-&#39; + Date.now());
    try {
        const secondaryAuth = secondaryApp.auth();
        const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, pass);
        const newUser = userCredential.user;

        await db.ref(&#39;users/&#39; + newUser.uid).set({
            name, email, phone, role: &#39;agent&#39;,
            createdBy: currentUser.uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        await secondaryAuth.signOut();
        const successMsg = `Agent &#39;${name}&#39; created successfully!`;
        showNotification(successMsg, &#39;success&#39;);
        await triggerGlobalNotification(successMsg, &#39;success&#39;);

        document.getElementById(&#39;createAgentNameInp&#39;).value = &#39;&#39;;
        document.getElementById(&#39;createAgentEmailInp&#39;).value = &#39;&#39;;
        document.getElementById(&#39;createAgentPhoneInp&#39;).value = &#39;&#39;;
        document.getElementById(&#39;createAgentPassInp&#39;).value = &#39;&#39;;

    } catch (error) {
        showNotification(`Error creating agent: ${error.message}`, &#39;error&#39;);
    } finally {
        await secondaryApp.delete();
    }
}

async function resetCallNum() {
    if(!confirm(&#39;Are you sure? This will reset all called numbers, winners, and the game timer.&#39;)) return;
    try {
        await db.ref(&#39;gameState/currentState&#39;).update({
            calledNumbers: null,
            winners: null,
            isGameRunning: false,
            gameStartedAt: null 
        });
        showNotification(&#39;Game state has been reset.&#39;, &#39;success&#39;);
        await triggerGlobalNotification(&#39;Admin has reset the game board.&#39;, &#39;info&#39;);
    } catch (e) { showNotification(&#39;Error resetting game state: &#39; + e.message, &#39;error&#39;); }
}
async function resetTicket() {
    if(!confirm(&#39;Are you sure? This will mark all sold tickets as UNSOLD.&#39;)) return;
    try {
        const updates = {};
        allTicketsData.forEach(ticket =&gt; {
            if (ticket.is_sold) {
                updates[`/tickets/${ticket.id}/is_sold`] = false;
                updates[`/tickets/${ticket.id}/owner_name`] = null;
                updates[`/tickets/${ticket.id}/owner_name_lower`] = null;
                updates[`/tickets/${ticket.id}/owner_phone`] = null;
                updates[`/tickets/${ticket.id}/agent_uid`] = null;
                updates[`/tickets/${ticket.id}/sold_at`] = null;
            }
        });
        if (Object.keys(updates).length &gt; 0) {
           await db.ref().update(updates);
        }
        showNotification(&#39;All sold tickets have been reset.&#39;, &#39;success&#39;);
        await triggerGlobalNotification(&#39;Admin has reset all sold tickets.&#39;, &#39;info&#39;);
    } catch (e) { showNotification(&#39;Error resetting tickets: &#39; + e.message, &#39;error&#39;); }
}

async function resetAgent() {
    if(!confirm(&#39;Are you sure? This will DELETE all users with the &#34;agent&#34; role. This cannot be undone!&#39;)) return;
    try {
        const updates = {};
        const agents = allUsersData.filter(u =&gt; u.role === &#39;agent&#39;);
        if (agents.length === 0) return showNotification(&#34;No agents to delete.&#34;, &#34;info&#34;);

        agents.forEach(agent =&gt; {
            updates[`/users/${agent.uid}`] = null;
        });
        await db.ref().update(updates);

        const msg = `${agents.length} agent account(s) deleted.`;
        showNotification(msg, &#39;success&#39;);
        await triggerGlobalNotification(msg, &#39;info&#39;);
    } catch (e) { showNotification(&#39;Error deleting agents: &#39; + e.message, &#39;error&#39;); }
}

function showLastSoldTicket() {
    const soldTickets = allTicketsData
        .filter(t =&gt; t.is_sold &amp;&amp; t.sold_at)
        .sort((a, b) =&gt; b.sold_at - a.sold_at);

    if (soldTickets.length &gt; 0) {
        const lastTicket = soldTickets[0];
        const agent = allUsersData.find(u =&gt; u.uid === lastTicket.agent_uid);
        const agentName = agent ? agent.name : &#39;Admin/Direct&#39;;
        showNotification(`Last ticket sold: ${lastTicket.id} to ${lastTicket.owner_name} by ${agentName}.`, &#39;info&#39;);
    } else {
        showNotification(&#39;No tickets have been sold yet.&#39;, &#39;info&#39;);
    }
}

async function showPreviousGameWinners() {
    try {
        const snapshot = await db.ref(&#39;lastGame/winners&#39;).once(&#39;value&#39;);
        const prevWinners = snapshot.val();

        if (!prevWinners || Object.keys(prevWinners).length === 0) {
            return showNotification(&#39;No archived winner data found.&#39;, &#39;info&#39;);
        }

        const titleEl = document.getElementById(&#39;genericInfoPopupTitle&#39;);
        const contentEl = document.getElementById(&#39;genericInfoPopupContent&#39;);

        titleEl.textContent = &#39;Previous Game Winners&#39;;

        let contentHTML = &#39;&lt;ul&gt;&#39;;
        for (const dividend in prevWinners) {
            const winnerArray = prevWinners[dividend];
            if(Array.isArray(winnerArray)){
                const winnerDetails = winnerArray.map(w =&gt; `${w.name} (Ticket: ${w.ticketId})`).join(&#39;&lt;br&gt;&#39;);
                contentHTML += `&lt;li&gt;
                    &lt;div class=&#34;winner-dividend&#34;&gt;${dividend}&lt;/div&gt;
                    &lt;div class=&#34;winner-details&#34;&gt;${winnerDetails}&lt;/div&gt;
                &lt;/li&gt;`;
            }
        }
        contentHTML += &#39;&lt;/ul&gt;&#39;;

        contentEl.innerHTML = contentHTML;
        showPopup(&#39;genericInfoPopup&#39;);

    } catch (e) {
        showNotification(&#39;Error fetching previous winners: &#39; + e.message, &#39;error&#39;);
    }
}

function updateBusinessInfo() {
    const soldTickets = allTicketsData.filter(t =&gt; t.is_sold);
    const soldCount = soldTickets.length;
    const totalTickets = gameSettingsData.totalTickets || 0;
    const ticketsLeft = totalTickets - soldCount;
    const price = gameSettingsData.ticketPrice || 0;
    const commission = gameSettingsData.agentCommission || 0;
    
    const agentUids = new Set(allUsersData.filter(u =&gt; u.role === &#39;agent&#39;).map(u =&gt; u.uid));
    const agentSoldCount = soldTickets.filter(t =&gt; t.agent_uid &amp;&amp; agentUids.has(t.agent_uid)).length;
    const totalCommission = agentSoldCount * commission;

    const totalRevenue = soldCount * price;
    const activeDividends = gameSettingsData.dividends || [];
    const totalPrizeMoney = activeDividends.reduce((sum, dividend) =&gt; sum + (parseInt(dividend.amount, 10) || 0), 0);
    const netProfit = totalRevenue - totalCommission - totalPrizeMoney;

    const adminTable = document.getElementById(&#39;businessInfoTable&#39;);
    if(adminTable &amp;&amp; currentView === &#39;adminDashboardView&#39;) {
        adminTable.innerHTML = `&lt;tbody&gt;
            &lt;tr&gt;&lt;td&gt;Total Tickets&lt;/td&gt;&lt;td&gt;${totalTickets}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Tickets Sold&lt;/td&gt;&lt;td&gt;${soldCount}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Tickets Left&lt;/td&gt;&lt;td&gt;${ticketsLeft}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Total Revenue&lt;/td&gt;&lt;td&gt; ${totalRevenue.toLocaleString()}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Total Agent Commission&lt;/td&gt;&lt;td&gt; ${totalCommission.toLocaleString()}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Total Prize Money&lt;/td&gt;&lt;td&gt; ${totalPrizeMoney.toLocaleString()}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Net Profit&lt;/td&gt;&lt;td&gt; ${netProfit.toLocaleString()}&lt;/td&gt;&lt;/tr&gt;
        &lt;/tbody&gt;`;
    }
}

function toggleAdminList(state) {
    adminListState = state;
    document.getElementById(&#39;showTicketBtn&#39;).style.backgroundColor = state === &#39;tickets&#39; ? &#39;var(--accent-color-dash)&#39; : &#39;var(--secondary-bg-dash)&#39;;
    document.getElementById(&#39;showAgentBtn&#39;).style.backgroundColor = state === &#39;agents&#39; ? &#39;var(--accent-color-dash)&#39; : &#39;var(--secondary-bg-dash)&#39;;
    updateAdminList();
}

function updateAdminList() {
    if (currentView !== &#39;adminDashboardView&#39;) return;
    const searchTerm = document.getElementById(&#39;adminSearchKeyInp&#39;).value.toLowerCase();
    const table = document.getElementById(&#39;adminGameSettingTable&#39;);

    if (adminListState === &#39;tickets&#39;) {
        table.className = &#39;gameSettingTable1&#39;;
        const tickets = allTicketsData.filter(t =&gt; !searchTerm || t.id.toString().includes(searchTerm) || (t.owner_name_lower||&#39;&#39;).includes(searchTerm) || (t.owner_phone||&#39;&#39;).includes(searchTerm));
        table.innerHTML = `&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Ticket Details&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;` +
            tickets.sort((a,b) =&gt; a.id - b.id).map(t =&gt; {
                if (t.is_sold) {
                    const agent = allUsersData.find(u =&gt; u.uid === t.agent_uid);
                    const name = t.owner_name ? t.owner_name.replace(/&#39;/g, &#34;\\&#39;&#34;) : &#39;&#39;;
                    const phone = t.owner_phone || &#39;&#39;;
                    return `&lt;tr class=&#34;admin-ticket-row&#34;&gt;
                        &lt;td&gt;
                           &lt;div class=&#34;booked-ticket-line-1&#34;&gt;
                                &lt;span&gt;${t.id}: ${t.owner_name}&lt;/span&gt;
                                &lt;div&gt;
                                    &lt;i class=&#34;fas fa-edit&#34; onclick=&#34;showEditTicketPopup(${t.id}, &#39;${name}&#39;, &#39;${phone}&#39;)&#34;&gt;&lt;/i&gt;
                                    &lt;i class=&#34;fas fa-trash-alt&#34; onclick=&#34;promptDeleteTicket(${t.id}, &#39;${name}&#39;, &#39;${phone}&#39;)&#34;&gt;&lt;/i&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                            &lt;div class=&#34;booked-ticket-line-2&#34;&gt;
                                &lt;span&gt;Mobile: ${t.owner_phone || &#39;-&#39;}&lt;/span&gt; | &lt;span&gt;Agent: ${agent?.name || (t.is_sold ? &#39;Admin/Direct&#39; : &#39;-&#39;)}&lt;/span&gt;
                            &lt;/div&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;`;
                } else {
                     return `&lt;tr class=&#34;admin-ticket-row available-ticket&#34;&gt;
                        &lt;td data-label=&#34;ID&#34;&gt;${t.id}&lt;/td&gt;
                        &lt;td data-label=&#34;Status&#34;&gt;Available&lt;/td&gt;
                        &lt;td data-label=&#34;Owner&#34;&gt;-&lt;/td&gt;
                        &lt;td data-label=&#34;Actions&#34;&gt;-&lt;/td&gt;
                    &lt;/tr&gt;`;
                }
            }).join(&#39;&#39;) + `&lt;/tbody&gt;`;
    } else {
        table.className = &#39;gameSettingTable1 agent-list-view&#39;;
        const commissionPerTicket = gameSettingsData.agentCommission || 0;
        const users = allUsersData.filter(u =&gt; !searchTerm || (u.name||&#39;&#39;).toLowerCase().includes(searchTerm) || (u.email||&#39;&#39;).toLowerCase().includes(searchTerm) || (u.phone||&#39;&#39;).toLowerCase().includes(searchTerm));
        
        const tableHTML = users.map(u =&gt; {
            const soldCount = allTicketsData.filter(t =&gt; t.agent_uid === u.uid).length;
            const commission = soldCount * commissionPerTicket;
            const safeName = u.name ? u.name.replace(/&#39;/g, &#34;\\&#39;&#34;) : &#39;N/A&#39;;
            
            const actionButtonHTML = u.role === &#39;agent&#39; 
                ? `&lt;i class=&#34;fas fa-trash-alt&#34; title=&#34;Delete Agent&#34; onclick=&#34;event.stopPropagation(); deleteUser(&#39;${u.uid}&#39;, &#39;${safeName}&#39;)&#34;&gt;&lt;/i&gt;` 
                : &#39;&lt;span&gt;-&lt;/span&gt;&#39;;

            return `&lt;tr class=&#34;agent-row-card&#34; onclick=&#34;showAgentBookings(&#39;${u.uid}&#39;, &#39;${safeName}&#39;)&#34; title=&#34;Click to see tickets sold by ${safeName}&#34;&gt;
                &lt;td colspan=&#34;5&#34;&gt;
                    &lt;div class=&#34;agent-card-container&#34;&gt;
                        &lt;div class=&#34;agent-card-info&#34;&gt;
                            &lt;div class=&#34;agent-card-name&#34;&gt;${u.name || &#39;N/A&#39;} &lt;small&gt;(${u.role})&lt;/small&gt;&lt;/div&gt;
                            &lt;div class=&#34;agent-card-phone&#34;&gt;&lt;i class=&#34;fas fa-phone-alt&#34;&gt;&lt;/i&gt; ${u.phone || &#39;N/A&#39;}&lt;/div&gt;
                        &lt;/div&gt;
                        &lt;div class=&#34;agent-card-stats&#34;&gt;
                            &lt;div class=&#34;agent-stat-item&#34;&gt;
                                &lt;span&gt;${soldCount}&lt;/span&gt;
                                &lt;label&gt;Tickets Sold&lt;/label&gt;
                            &lt;/div&gt;
                            &lt;div class=&#34;agent-stat-item&#34;&gt;
                                &lt;span&gt;${commission.toLocaleString()}&lt;/span&gt;
                                &lt;label&gt;Commission&lt;/label&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        &lt;div class=&#34;agent-card-actions&#34;&gt;
                            ${actionButtonHTML}
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/td&gt;
            &lt;/tr&gt;`;
        }).join(&#39;&#39;);

        table.innerHTML = `&lt;tbody&gt;${tableHTML}&lt;/tbody&gt;`;
    }
}

function showAgentBookings(agentUid, agentName) {
    if (!agentUid) return;

    const agentBookings = allTicketsData
        .filter(t =&gt; t.agent_uid === agentUid)
        .sort((a, b) =&gt; a.id - b.id);

    const titleEl = document.getElementById(&#39;genericInfoPopupTitle&#39;);
    const contentEl = document.getElementById(&#39;genericInfoPopupContent&#39;);

    titleEl.textContent = `Tickets Sold by ${agentName}`;

    if (agentBookings.length === 0) {
        contentEl.innerHTML = &#39;&lt;p style=&#34;padding: 1rem; text-align: center;&#34;&gt;This user has not sold any tickets yet.&lt;/p&gt;&#39;;
    } else {
        let contentHTML = &#39;&lt;ul&gt;&#39;;
        agentBookings.forEach(ticket =&gt; {
            contentHTML += `&lt;li&gt;
                &lt;strong&gt;Ticket ${ticket.id}&lt;/strong&gt;&lt;br&gt;
                &lt;span style=&#34;font-size: 0.9em;&#34;&gt;Owner: ${ticket.owner_name} | Phone: ${ticket.owner_phone || &#39;N/A&#39;}&lt;/span&gt;
            &lt;/li&gt;`;
        });
        contentHTML += &#39;&lt;/ul&gt;&#39;;
        contentEl.innerHTML = contentHTML;
    }
    
    showPopup(&#39;genericInfoPopup&#39;);
}


function showEditTicketPopup(ticketId, currentName, currentPhone) {
    ticketIdToEdit = ticketId; 
    originalOwnerInfo = { name: currentName, phone: currentPhone }; 
    document.getElementById(&#39;editOwnerInfoText&#39;).innerHTML = `Editing details for Ticket &lt;b&gt;${ticketId}&lt;/b&gt;.`;
    document.getElementById(&#39;editOwnerNameInp&#39;).value = currentName;
    document.getElementById(&#39;editOwnerPhoneInp&#39;).value = currentPhone;
    showPopup(&#39;editOwnerPopup&#39;);
}

async function saveTicketOwnerChanges() {
    if (!ticketIdToEdit || !originalOwnerInfo.phone) return;

    const newName = document.getElementById(&#39;editOwnerNameInp&#39;).value.trim();
    const newPhone = document.getElementById(&#39;editOwnerPhoneInp&#39;).value.trim();

    if (!newName || !newPhone) {
        return showNotification(&#39;Name and Phone cannot be empty.&#39;, &#39;error&#39;);
    }

    const ownedTickets = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp; t.owner_phone === originalOwnerInfo.phone);

    if (ownedTickets.length &gt; 1) {
        const confirmText = document.getElementById(&#39;applyToAllConfirmText&#39;);
        confirmText.innerHTML = `&lt;b&gt;${originalOwnerInfo.name}&lt;/b&gt; owns &lt;b&gt;${ownedTickets.length}&lt;/b&gt; tickets. &lt;br/&gt;&lt;br/&gt; Do you want to apply the new details to all of them?`;

        document.getElementById(&#39;confirmApplyToAllBtn&#39;).onclick = () =&gt; applyOwnerChanges(true, newName, newPhone);
        document.getElementById(&#39;confirmApplyToSingleBtn&#39;).onclick = () =&gt; applyOwnerChanges(false, newName, newPhone);

        showPopup(&#39;applyToAllConfirmPopup&#39;);
    } else {
        applyOwnerChanges(false, newName, newPhone);
    }
}

async function applyOwnerChanges(applyToAll, newName, newPhone) {
    try {
        const updates = {};
        let ticketsToUpdate = [];
        let successMessage = &#39;&#39;;

        if (applyToAll) {
            ticketsToUpdate = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp; t.owner_phone === originalOwnerInfo.phone);
            successMessage = `Details updated for all ${ticketsToUpdate.length} tickets owned by ${originalOwnerInfo.name}.`;
        } else {
            const singleTicket = allTicketsData.find(t =&gt; t.id === ticketIdToEdit);
            if (singleTicket) ticketsToUpdate.push(singleTicket);
            successMessage = `Ticket ${ticketIdToEdit} updated successfully!`;
        }

        if (ticketsToUpdate.length === 0) {
            closePopups();
            return showNotification(&#39;Could not find the specified ticket(s) to update.&#39;, &#39;error&#39;);
        }

        ticketsToUpdate.forEach(ticket =&gt; {
            updates[`/tickets/${ticket.id}/owner_name`] = newName;
            updates[`/tickets/${ticket.id}/owner_name_lower`] = newName.toLowerCase();
            updates[`/tickets/${ticket.id}/owner_phone`] = newPhone;
        });

        await db.ref().update(updates);
        showNotification(successMessage, &#39;success&#39;);

    } catch (e) {
        showNotification(&#39;Error updating ticket(s): &#39; + e.message, &#39;error&#39;);
    } finally {
        closePopups();
        ticketIdToEdit = null;
        originalOwnerInfo = { name: &#39;&#39;, phone: &#39;&#39; };
    }
}

function promptDeleteTicket(ticketId, ownerName, ownerPhone) {
    if (!ownerPhone) {
        if (confirm(`This ticket has no owner info. Are you sure you want to mark Ticket ${ticketId} as available?`)) {
            performDelete(ticketId, false);
        }
        return;
    }

    const ownedTickets = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp; t.owner_phone === ownerPhone);

    if (ownedTickets.length &gt; 1) {
        ticketToDeleteInfo = { ticketId, ownerName, ownerPhone };
        const confirmText = document.getElementById(&#39;deleteConfirmText&#39;);
        confirmText.innerHTML = `&lt;b&gt;${ownerName}&lt;/b&gt; owns &lt;b&gt;${ownedTickets.length}&lt;/b&gt; tickets. &lt;br/&gt;&lt;br/&gt; Do you want to delete all of them, or just this one (&lt;b&gt;${ticketId}&lt;/b&gt;)?`;

        document.getElementById(&#39;confirmDeleteAllBtn&#39;).onclick = () =&gt; performDelete(ownerPhone, true);
        document.getElementById(&#39;confirmDeleteSingleBtn&#39;).onclick = () =&gt; performDelete(ticketId, false);

        showPopup(&#39;deleteConfirmPopup&#39;);
    } else {
        if (confirm(`Are you sure you want to delete Ticket ${ticketId} for ${ownerName}? This will mark it as available.`)) {
            performDelete(ticketId, false);
        }
    }
}

async function performDelete(identifier, deleteAll) {
    try {
        const updates = {};
        let ticketsToReset = [];
        let successMessage = &#39;&#39;;

        if (deleteAll) {
            ticketsToReset = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp; t.owner_phone === identifier);
            successMessage = `Deleted all ${ticketsToReset.length} tickets for the owner.`;
        } else {
            const singleTicket = allTicketsData.find(t =&gt; t.id === identifier);
            if (singleTicket) ticketsToReset.push(singleTicket);
            successMessage = `Ticket ${identifier} has been deleted and is now available.`;
        }

        if (ticketsToReset.length === 0) {
            closePopups();
            return showNotification(&#39;Could not find ticket(s) to delete.&#39;, &#39;error&#39;);
        }

        ticketsToReset.forEach(ticket =&gt; {
            updates[`/tickets/${ticket.id}/is_sold`] = false;
            updates[`/tickets/${ticket.id}/owner_name`] = null;
            updates[`/tickets/${ticket.id}/owner_name_lower`] = null;
            updates[`/tickets/${ticket.id}/owner_phone`] = null;
            updates[`/tickets/${ticket.id}/agent_uid`] = null;
            updates[`/tickets/${ticket.id}/sold_at`] = null;
        });

        await db.ref().update(updates);
        showNotification(successMessage, &#39;success&#39;);
        triggerGlobalNotification(`Admin made ${ticketsToReset.length} ticket(s) available again.`, &#39;info&#39;);

    } catch (e) {
        showNotification(&#39;Error deleting ticket(s): &#39; + e.message, &#39;error&#39;);
    } finally {
        closePopups();
        ticketToDeleteInfo = {};
    }
}


async function deleteUser(uid, name) {
    if (uid === currentUser.uid) {
        return showNotification(&#34;You cannot delete your own account.&#34;, &#34;error&#34;);
    }
    const userToDelete = allUsersData.find(u =&gt; u.uid === uid);
    if (userToDelete &amp;&amp; userToDelete.role === &#39;admin&#39;) {
        return showNotification(&#34;Admins cannot be deleted from this panel.&#34;, &#34;error&#34;);
    }

    if (!confirm(`Are you sure you want to PERMANENTLY DELETE the agent &#39;${name}&#39;? This action cannot be undone.`)) return;

    try {
        await db.ref(`users/${uid}`).remove();
        const msg = `Agent &#39;${name}&#39; has been deleted.`;
        showNotification(msg, &#39;success&#39;);
        await triggerGlobalNotification(msg, &#39;info&#39;);
    } catch (e) {
        showNotification(&#39;Error deleting user: &#39; + e.message, &#39;error&#39;);
    }
}

function changePosterBackground(buttonElement, source) {
    const bgButtons = document.querySelectorAll(&#39;#poster-bg-controls .actionBtn&#39;);
    bgButtons.forEach(btn =&gt; btn.classList.remove(&#39;active&#39;));

    if (buttonElement) {
        buttonElement.classList.add(&#39;active&#39;);
    }
    
    const posterContent = document.getElementById(&#39;posterContent&#39;);
    if (posterContent) {
        let newImageUrl;
        if (source.startsWith(&#39;http&#39;) || source.startsWith(&#39;data:image&#39;)) {
            newImageUrl = source;
        } else {
            newImageUrl = `https://source.unsplash.com/random/600x800/?${source}&amp;t=${new Date().getTime()}`;
        }
        posterContent.style.backgroundImage = `url(&#39;${newImageUrl}&#39;)`;
    }
}

function handlePosterBgUpload(event) {
    const file = event.target.files[0];
    if (file &amp;&amp; file.type.startsWith(&#39;image/&#39;)) {
        const reader = new FileReader();
        reader.onload = function(e) {
            changePosterBackground(null, e.target.result);
        };
        reader.readAsDataURL(file);
    } else if (file) {
        showNotification(&#39;Please select a valid image file (e.g., JPG, PNG, GIF).&#39;, &#39;error&#39;);
    }
}

function showPosterModal() {
    const title = &#34;LUCKY HOUSIE BUMPER&#34;;
    const gameDateTime = gameSettingsData.gameDateTime;
    const ticketPrice = gameSettingsData.ticketPrice || &#39;N/A&#39;;
    const totalTickets = gameSettingsData.totalTickets || &#39;N/A&#39;;
    const activeDividends = gameSettingsData.dividends || [];
    const adminUser = allUsersData.find(u =&gt; u.role === &#39;admin&#39;);
    const adminPhone = adminUser ? adminUser.phone : (document.getElementById(&#39;adminPhoneInp&#39;).value || &#39;N/A&#39;);
    const websiteLink = window.location.href.split(&#39;#&#39;)[0];

    let gameTimeFormatted = &#34;DATE &amp; TIME NOT SET&#34;;
    if (gameDateTime) {
        const date = new Date(gameDateTime);
        gameTimeFormatted = date.toLocaleString(&#39;en-US&#39;, { weekday: &#39;long&#39;, month: &#39;short&#39;, day: &#39;numeric&#39;, hour: &#39;2-digit&#39;, minute: &#39;2-digit&#39; });
    }

    const dividendNamesHTML = activeDividends.map(d =&gt; `&lt;p&gt;${d.name}&lt;/p&gt;`).join(&#39;&#39;);
    const dividendAmountsHTML = activeDividends.map(d =&gt; `&lt;p&gt;Rs ${d.amount.toLocaleString()}&lt;/p&gt;`).join(&#39;&#39;);

    const posterHTML = `
        &lt;h1 class=&#34;poster-title&#34; contenteditable=&#34;true&#34;&gt;${title}&lt;/h1&gt;
        &lt;p class=&#34;poster-datetime&#34; contenteditable=&#34;true&#34;&gt;${gameTimeFormatted}&lt;/p&gt;
        &lt;p class=&#34;poster-tagline&#34; contenteditable=&#34;true&#34;&gt;Grab Your Tickets &amp; Get Ready to Win!&lt;/p&gt;

        &lt;div class=&#34;prize-section&#34;&gt;
            &lt;h3&gt;PRIZES&lt;/h3&gt;
            &lt;div class=&#34;prize-list&#34;&gt;
                &lt;div class=&#34;prize-column&#34; id=&#34;prize-names&#34;&gt;
                    ${dividendNamesHTML}
                &lt;/div&gt;
                &lt;div class=&#34;prize-column&#34; id=&#34;prize-amounts&#34;&gt;
                    ${dividendAmountsHTML}
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;p class=&#34;ticket-details&#34; contenteditable=&#34;true&#34;&gt;Get ticket @ Rs ${ticketPrice}. Total tickets only (${totalTickets})&lt;/p&gt;

        &lt;div class=&#34;contact-section&#34;&gt;
            &lt;p contenteditable=&#34;true&#34;&gt;visit: &lt;a href=&#34;${websiteLink}&#34; target=&#34;_blank&#34;&gt;${websiteLink.replace(/^https?:\/\//, &#39;&#39;)}&lt;/a&gt;&lt;/p&gt;
            &lt;p contenteditable=&#34;true&#34;&gt;Whatsapp: &lt;span&gt;${adminPhone}&lt;/span&gt;&lt;/p&gt;
        &lt;/div&gt;
    `;

    document.getElementById(&#39;posterContent&#39;).innerHTML = posterHTML;
    
    const firstBgButton = document.querySelector(&#39;#poster-bg-controls .actionBtn[onclick]&#39;);
    if (firstBgButton) {
      firstBgButton.click();
    } else {
      changePosterBackground(null, &#39;https://raw.githubusercontent.com/Anandkhuman/housie/main/bg1.jpeg&#39;);
    }
    
    showPopup(&#39;posterMakerPopup&#39;);
}


function savePosterAsImage() {
    const posterElement = document.getElementById(&#39;posterContent&#39;);
    if (!posterElement) return showNotification(&#39;Poster element not found.&#39;, &#39;error&#39;);

    showNotification(&#39;Generating poster image...&#39;, &#39;info&#39;);

    html2canvas(posterElement, {
        useCORS: true, 
        allowTaint: true,
        logging: false,
    }).then(canvas =&gt; {
        const link = document.createElement(&#39;a&#39;);
        link.download = &#39;sintha-housie-poster.png&#39;;
        link.href = canvas.toDataURL(&#39;image/png&#39;);
        link.click();
        showNotification(&#39;Poster download started!&#39;, &#39;success&#39;);
    }).catch(err =&gt; {
        console.error(&#34;html2canvas error:&#34;, err);
        showNotification(&#39;Could not generate poster image. Check console for errors.&#39;, &#39;error&#39;);
    });
}

async function sharePoster() {
    const posterElement = document.getElementById(&#39;posterContent&#39;);
    if (!posterElement) return showNotification(&#39;Poster element not found.&#39;, &#39;error&#39;);

    showNotification(&#39;Preparing poster for sharing...&#39;, &#39;info&#39;);

    try {
        const canvas = await html2canvas(posterElement, { useCORS: true, allowTaint: true });
        const blob = await new Promise(resolve =&gt; canvas.toBlob(resolve, &#39;image/png&#39;));
        const file = new File([blob], &#39;housie-poster.png&#39;, { type: &#39;image/png&#39; });
        const filesArray = [file];

        const websiteName = &#34;LUCKY HOUSIE BUMPER Game!&#34;;
        const websiteLink = window.location.href.split(&#39;#&#39;)[0];
        
        if (navigator.canShare &amp;&amp; navigator.canShare({ files: filesArray })) {
            await navigator.share({
                files: filesArray,
                title: websiteName,
                text: `Join the ${websiteName}. Check out the poster!`,
                url: websiteLink
            });
            showNotification(&#39;Poster shared successfully!&#39;, &#39;success&#39;);
        } else {
            showNotification(&#39;Image sharing not supported. Saving image instead.&#39;, &#39;info&#39;, 6000);
            savePosterAsImage();
        }
    } catch (error) {
        if (error.name !== &#39;AbortError&#39;) {
             console.error(&#39;Error sharing poster:&#39;, error);
             showNotification(`Could not share poster: ${error.message}`, &#39;error&#39;);
             savePosterAsImage();
        }
    }
}

function updateAgentInfoUI() {
    if (!currentUser || currentView !== &#39;agentDashboardView&#39;) return;
    
    const agentData = allUsersData.find(u =&gt; u.uid === currentUser.uid);
    if (agentData) {
        document.getElementById(&#39;agentNameInp&#39;).value = agentData.name;
        document.getElementById(&#39;agentPhoneInp&#39;).value = agentData.phone;
    }
    
    const mySoldTickets = allTicketsData.filter(t =&gt; t.agent_uid === currentUser.uid);
    const mySoldCount = mySoldTickets.length;
    const myEarnings = mySoldCount * (gameSettingsData.agentCommission || 0);
    document.getElementById(&#39;earningBtn&#39;).textContent = ` ${myEarnings.toLocaleString()}`;

    const soldCount = allTicketsData.filter(t =&gt; t.is_sold).length;
    const totalTickets = gameSettingsData.totalTickets || 0;
    const ticketsLeft = totalTickets - soldCount;

    const agentBusinessInfoTable = document.getElementById(&#39;agentBusinessInfoTable&#39;);
    if (agentBusinessInfoTable) {
        agentBusinessInfoTable.innerHTML = `&lt;tbody&gt;
            &lt;tr&gt;&lt;td&gt;Ticket Price&lt;/td&gt;&lt;td&gt; ${(gameSettingsData.ticketPrice || 0).toLocaleString()}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;My Commission/Tkt&lt;/td&gt;&lt;td&gt; ${(gameSettingsData.agentCommission || 0).toLocaleString()}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td style=&#34;color:var(--accent-color-dash);&#34;&gt;My Tickets Sold&lt;/td&gt;&lt;td style=&#34;color:var(--accent-color-dash); font-weight: bold;&#34;&gt;${mySoldCount}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td colspan=&#34;2&#34; style=&#34;height: 10px;&#34;&gt;&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Total Tickets in Game&lt;/td&gt;&lt;td&gt;${totalTickets}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Total Sold&lt;/td&gt;&lt;td&gt;${soldCount}&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td&gt;Tickets Left&lt;/td&gt;&lt;td&gt;${ticketsLeft}&lt;/td&gt;&lt;/tr&gt;
        &lt;/tbody&gt;`;
    }
}

function showAgentSoldTickets() {
    if (!currentUser || currentView !== &#39;agentDashboardView&#39;) return;
    const searchTerm = document.getElementById(&#39;agentSearchKeyInp&#39;).value.toLowerCase();
    const table = document.getElementById(&#39;agentSoldTicketsTable&#39;);
    const myTickets = allTicketsData.filter(t =&gt; t.agent_uid === currentUser.uid &amp;&amp; (!searchTerm || (t.owner_name_lower||&#39;&#39;).includes(searchTerm) || (t.owner_phone||&#39;&#39;).includes(searchTerm)));

    table.innerHTML = `&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Ticket ID&lt;/th&gt;&lt;th&gt;Owner Name&lt;/th&gt;&lt;th&gt;Owner Phone&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;` +
        myTickets.sort((a,b) =&gt; a.id - b.id).map(t =&gt; `&lt;tr&gt;&lt;td data-label=&#34;ID&#34;&gt;${t.id}&lt;/td&gt;&lt;td data-label=&#34;Name&#34;&gt;${t.owner_name}&lt;/td&gt;&lt;td data-label=&#34;Phone&#34;&gt;${t.owner_phone}&lt;/td&gt;&lt;/tr&gt;`).join(&#39;&#39;) + `&lt;/tbody&gt;`;
}

function updateDashboardBookingPopup() {
    const container = document.getElementById(&#39;dashTicketBlockDiv&#39;);
    if (!container) return;
    container.innerHTML = &#39;&#39;;
    const indicator = document.getElementById(&#39;dashboardSelectionIndicator&#39;);
    if (indicator) indicator.textContent = &#39;&#39;;

    const totalTickets = gameSettingsData.totalTickets || 0;
    if (allTicketsData.length === 0 || totalTickets === 0) {
        container.innerHTML = &#39;&lt;p style=&#34;text-align: center; color: var(--light-text-dash);&#34;&gt;Tickets have not been generated.&lt;/p&gt;&#39;;
        return;
    }

    const ticketsMap = new Map(allTicketsData.map(t =&gt; [t.id, t]));
    const numSheets = Math.ceil(totalTickets / 6);

    for (let i = 0; i &lt; numSheets; i++) {
        const startTicket = i * 6 + 1;
        const endTicket = startTicket + 5;

        const sheetRow = document.createElement(&#39;div&#39;);
        sheetRow.className = &#39;compact-sheet-row&#39;;

        const checkbox = document.createElement(&#39;input&#39;);
        checkbox.type = &#39;checkbox&#39;;
        checkbox.className = &#39;sheet-tick-box&#39;;
        checkbox.onchange = () =&gt; selectFullSheetDashboard(checkbox, startTicket, endTicket);
        sheetRow.appendChild(checkbox);

        const buttonGroup = document.createElement(&#39;div&#39;);
        buttonGroup.className = &#39;ticket-buttons-group&#39;;

        for (let j = startTicket; j &lt;= endTicket; j++) {
            const ticket = ticketsMap.get(j);
            const btn = document.createElement(&#39;button&#39;);
            btn.className = &#39;ticketBlockBtn&#39;;
            btn.textContent = j;
            btn.id = `dash-ticket-btn-${j}`;
            if (ticket &amp;&amp; ticket.is_sold) {
                btn.disabled = true;
            } else {
                btn.onclick = () =&gt; {
                    btn.classList.toggle(&#39;selected&#39;);
                    updateDashboardSelectionIndicator();
                };
            }
            buttonGroup.appendChild(btn);
        }
        
        sheetRow.appendChild(buttonGroup);
        container.appendChild(sheetRow);
    }
}

function selectFullSheetDashboard(checkbox, startId, endId) {
    for (let id = startId; id &lt;= endId; id++) {
        const btn = document.getElementById(`dash-ticket-btn-${id}`);
        if (btn &amp;&amp; !btn.disabled) {
            const isSelected = btn.classList.contains(&#39;selected&#39;);
            if (checkbox.checked &amp;&amp; !isSelected) {
                btn.click();
            } else if (!checkbox.checked &amp;&amp; isSelected) {
                btn.click();
            }
        }
    }
}

function updateDashboardSelectionIndicator() {
    const selectedNodes = document.querySelectorAll(&#39;#dashTicketBlockDiv .selected&#39;);
    const selectedIds = Array.from(selectedNodes).map(node =&gt; parseInt(node.textContent, 10));
    const indicator = document.getElementById(&#39;dashboardSelectionIndicator&#39;);
    if (indicator) {
        const result = checkSheetSelection(selectedIds);
        indicator.textContent = result.message;
        indicator.style.borderColor = result.valid ? &#39;var(--accent-color-dash)&#39; : &#39;#e74c3c&#39;;
    }
}

async function handleDashboardBooking() {
    if (!currentUser) return showNotification(&#34;You must be logged in.&#34;, &#39;error&#39;);
    const name = document.getElementById(&#39;dashBookerNameInp&#39;).value.trim();
    const phone = document.getElementById(&#39;dashBookerPhoneInp&#39;).value.trim();
    const selectedNodes = document.querySelectorAll(&#39;#dashTicketBlockDiv .selected&#39;);
    if (!name || !phone) return showNotification(&#39;Please enter name and phone.&#39;, &#39;error&#39;);
    if (selectedNodes.length === 0) return showNotification(&#39;Please select tickets.&#39;, &#39;error&#39;);
    const ticketIdsToBook = Array.from(selectedNodes).map(node =&gt; parseInt(node.textContent, 10));
    try {
        const updates = {};
        const timestamp = firebase.database.ServerValue.TIMESTAMP;
        ticketIdsToBook.forEach(id =&gt; {
            updates[`/tickets/${id}/is_sold`] = true;
            updates[`/tickets/${id}/owner_name`] = name;
            updates[`/tickets/${id}/owner_name_lower`] = name.toLowerCase();
            updates[`/tickets/${id}/owner_phone`] = phone;
            updates[`/tickets/${id}/agent_uid`] = currentUser.uid;
            updates[`/tickets/${id}/sold_at`] = timestamp;
        });
        await db.ref().update(updates);
        showNotification(`${ticketIdsToBook.length} tickets booked for ${name}.`, &#39;success&#39;);
        document.getElementById(&#39;dashBookerNameInp&#39;).value = &#39;&#39;;
        document.getElementById(&#39;dashBookerPhoneInp&#39;).value = &#39;&#39;;
        closePopups();
    } catch(e) { showNotification(&#39;Error booking tickets: &#39; + e.message, &#39;error&#39;); }
}

function renderPublicBookingGrid() {
    const container = document.getElementById(&#39;publicBookingGrid&#39;);
    if (!container) return;
    container.innerHTML = &#39;&#39;;
    publicPopupSelectedTickets = [];
    updatePublicBookingIndicator();

    const totalTickets = gameSettingsData.totalTickets || 0;
    if (allTicketsData.length === 0 || totalTickets === 0) {
        container.innerHTML = &#39;&lt;p style=&#34;text-align: center; color: var(--light-text-dash);&#34;&gt;Tickets are not available yet.&lt;/p&gt;&#39;;
        return;
    }

    const ticketsMap = new Map(allTicketsData.map(t =&gt; [t.id, t]));
    const numSheets = Math.ceil(totalTickets / 6);

    for (let i = 0; i &lt; numSheets; i++) {
        const startTicket = i * 6 + 1;
        const endTicket = startTicket + 5;
        
        const sheetRow = document.createElement(&#39;div&#39;);
        sheetRow.className = &#39;compact-sheet-row&#39;;
        
        const checkbox = document.createElement(&#39;input&#39;);
        checkbox.type = &#39;checkbox&#39;;
        checkbox.className = &#39;sheet-tick-box&#39;;
        checkbox.onchange = () =&gt; selectFullSheetPublic(checkbox, startTicket, endTicket);
        sheetRow.appendChild(checkbox);
        
        const buttonGroup = document.createElement(&#39;div&#39;);
        buttonGroup.className = &#39;ticket-buttons-group&#39;;

        for (let j = startTicket; j &lt;= endTicket; j++) {
            const ticket = ticketsMap.get(j);
            const btn = document.createElement(&#39;button&#39;);
            btn.className = &#39;ticketBlockBtn&#39;;
            btn.textContent = j;
            btn.id = `public-ticket-btn-${j}`;
            if (ticket &amp;&amp; ticket.is_sold) {
                btn.disabled = true;
            } else {
                btn.onclick = () =&gt; togglePublicPopupTicketSelection(j);
            }
            buttonGroup.appendChild(btn);
        }

        sheetRow.appendChild(buttonGroup);
        container.appendChild(sheetRow);
    }
}

function togglePublicPopupTicketSelection(ticketId) {
    const btn = document.getElementById(`public-ticket-btn-${ticketId}`);
    if (!btn || btn.disabled) return;

    const index = publicPopupSelectedTickets.indexOf(ticketId);
    if (index &gt; -1) {
        publicPopupSelectedTickets.splice(index, 1);
        btn.classList.remove(&#39;selected&#39;);
    } else {
        publicPopupSelectedTickets.push(ticketId);
        btn.classList.add(&#39;selected&#39;);
    }
    updatePublicBookingIndicator();
}

function selectFullSheetPublic(checkbox, startId, endId) {
    for (let id = startId; id &lt;= endId; id++) {
        const btn = document.getElementById(`public-ticket-btn-${id}`);
        if (btn &amp;&amp; !btn.disabled) {
            const isSelected = publicPopupSelectedTickets.includes(id);
            if (checkbox.checked &amp;&amp; !isSelected) {
                togglePublicPopupTicketSelection(id);
            } else if (!checkbox.checked &amp;&amp; isSelected) {
                togglePublicPopupTicketSelection(id);
            }
        }
    }
}

function updatePublicBookingIndicator() {
    const indicator = document.getElementById(&#39;publicBookingIndicator&#39;);
    if (indicator) {
        const result = checkSheetSelection(publicPopupSelectedTickets);
        indicator.textContent = result.message;
        indicator.style.color = result.valid ? &#39;var(--accent-color-dash)&#39; : &#39;#e74c3c&#39;;
        indicator.style.borderColor = result.valid ? &#39;var(--accent-color-dash)&#39; : &#39;#e74c3c&#39;;
    }
}

function handlePublicPopupBookingRequest() {
    const name = document.getElementById(&#39;publicBookerNameInp&#39;).value.trim();
    const phone = document.getElementById(&#39;publicBookerPhoneInp&#39;).value.trim();

    if (!name || !phone) return showNotification(&#39;Please enter your name and phone number.&#39;, &#39;error&#39;);
    if (publicPopupSelectedTickets.length === 0) return showNotification(&#39;Please select tickets to book.&#39;, &#39;error&#39;);
    openAgentSelectorForWhatsApp(name, phone, publicPopupSelectedTickets);
}

async function toggleGameRunner() {
    const gameStateRef = db.ref(&#39;gameState/currentState&#39;);
    const isRunning = document.getElementById(&#39;callStatusInp&#39;).value === &#39;on&#39;;
    if (gameRunnerInterval) clearInterval(gameRunnerInterval);

    try {
        if (isRunning) {
            await gameStateRef.child(&#39;isGameRunning&#39;).set(true);
            await gameStateRef.transaction(currentData =&gt; {
                if (currentData) {
                    if (!currentData.gameStartedAt) {
                        currentData.gameStartedAt = firebase.database.ServerValue.TIMESTAMP;
                    }
                }
                return currentData;
            });
            
            playSound(audioBaseUrl + &#34;gamehasstarted.mp3&#34;);

            await triggerGlobalNotification(&#39;The game has started! Good luck!&#39;, &#39;success&#39;);
            const intervalSeconds = parseInt(document.getElementById(&#39;callIntervalInp&#39;).value, 10);
            if (isNaN(intervalSeconds) || intervalSeconds &lt; 1) {
                showNotification(&#34;Set a valid call interval (&gt;= 1 second).&#34;, &#39;error&#39;);
                document.getElementById(&#39;callStatusInp&#39;).value = &#39;off&#39;;
                await gameStateRef.child(&#39;isGameRunning&#39;).set(false);
                return;
            }
            gameRunnerInterval = setInterval(callNextNumber, intervalSeconds * 1000);
            callNextNumber(); 
        } else {
            await gameStateRef.child(&#39;isGameRunning&#39;).set(false);
        }
        showNotification(`Game runner is now ${isRunning ? &#39;ON&#39; : &#39;OFF&#39;}.`, &#39;info&#39;);
    } catch (e) {
        showNotification(&#34;Error starting/stopping game: &#34; + e.message, &#39;error&#39;);
    }
}

async function setNextCallNumber() {
    const inputEl = document.getElementById(&#39;nextCallInp&#39;);
    const numberToSet = parseInt(inputEl.value, 10);

    if (isNaN(numberToSet) || numberToSet &lt; 1 || numberToSet &gt; 90) {
        showNotification(&#39;Please enter a valid number between 1 and 90.&#39;, &#39;error&#39;);
        return;
    }

    if (currentCalledNumbers.includes(numberToSet)) {
        showNotification(`Number ${numberToSet} has already been called.`, &#39;error&#39;);
        return;
    }
    
    try {
        await db.ref(&#39;gameState/currentState/nextManualCall&#39;).set(numberToSet);
        showNotification(`Next number is set to ${numberToSet}. It will be called on the next interval.`, &#39;success&#39;);
        inputEl.value = &#39;&#39;;
    } catch (error) {
        showNotification(`Error setting next number: ${error.message}`, &#39;error&#39;);
        console.error(&#34;Error in setNextCallNumber:&#34;, error);
    }
}

function callNextNumber() {
    const gameStateRef = db.ref(&#39;gameState/currentState&#39;);
    gameStateRef.transaction(gameState =&gt; {
        if (!gameState) return { isGameRunning: false, calledNumbers: [], winners: {} };
        if (!gameState.isGameRunning) {
            if (gameRunnerInterval) clearInterval(gameRunnerInterval);
            return;
        }

        const called = gameState.calledNumbers || [];
        const activeDividends = gameSettingsData.dividends || [];
        const currentWinners = gameState.winners || {};
        const areAllDividendsClaimed = activeDividends.every(div =&gt; currentWinners[div.name]);

        if (called.length &gt;= 90 || areAllDividendsClaimed) {
            if (gameRunnerInterval) clearInterval(gameRunnerInterval);
            gameState.isGameRunning = false;
            return gameState;
        }

        let newNumber;
        const availableNumbers = Array.from({length: 90}, (_, i) =&gt; i + 1).filter(n =&gt; !called.includes(n));
        
        const manualCallNum = gameState.nextManualCall;
        
        if (manualCallNum &amp;&amp; availableNumbers.includes(manualCallNum)) {
            newNumber = manualCallNum;
            delete gameState.nextManualCall; 
        } else {
            if (gameState.nextManualCall) {
                delete gameState.nextManualCall;
            }
            if (availableNumbers.length === 0) {
                 if (gameRunnerInterval) clearInterval(gameRunnerInterval);
                 gameState.isGameRunning = false;
                 return gameState;
            }
            newNumber = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
        }

        gameState.calledNumbers = [...called, newNumber];
        gameState.winners = checkAllWinners(gameState.calledNumbers, gameState.winners || {});

        const newWinners = gameState.winners;
        const nowAllDividendsClaimed = activeDividends.every(div =&gt; newWinners[div.name]);
        if(nowAllDividendsClaimed){
            gameState.isGameRunning = false;
        }

        return gameState;
    }, (error, committed, snapshot) =&gt; {
        if (error) {
            console.error(&#34;Game call transaction failed: &#34;, error);
            showNotification(&#39;Game runner failed. Turning off.&#39;, &#39;error&#39;);
            if (gameRunnerInterval) clearInterval(gameRunnerInterval);
            gameStateRef.child(&#39;isGameRunning&#39;).set(false);
        } else if (committed &amp;&amp; snapshot.exists()) {
             const finalState = snapshot.val();
            if (!finalState.isGameRunning) {
                if (gameRunnerInterval) clearInterval(gameRunnerInterval);
                const activeDividends = gameSettingsData.dividends || [];
                const allClaimed = activeDividends.every(div =&gt; finalState.winners &amp;&amp; finalState.winners[div.name]);

                if (allClaimed) {
                    showNotification(&#34;All dividends won! Game over.&#34;, &#39;info&#39;);
                    triggerGlobalNotification(&#34;All dividends have been won! The game has ended!&#34;, &#39;info&#39;);
                } else if (finalState.calledNumbers?.length &gt;= 90) {
                    showNotification(&#34;All 90 numbers called! Game over.&#34;, &#39;info&#39;);
                    triggerGlobalNotification(&#34;All 90 numbers called! The game has ended!&#34;, &#39;info&#39;);
                }
            }
        }
    });
}


function checkAllWinners(calledNumbers, currentWinners) {
    let updatedWinners = JSON.parse(JSON.stringify(currentWinners));
    const activeDividends = gameSettingsData.dividends || [];
    const soldTickets = allTicketsData.filter(t =&gt; t.is_sold);
    const lastCalledNumber = calledNumbers[calledNumbers.length - 1];
    
    const check = (numbers) =&gt; numbers.every(n =&gt; calledNumbers.includes(n));
    const countMarked = (ticket) =&gt; (ticket.numbers || []).flat().filter(n =&gt; n &gt; 0 &amp;&amp; calledNumbers.includes(n)).length;

    const ticketsByOwner = soldTickets.reduce((acc, ticket) =&gt; {
        if (ticket.owner_phone) {
            if (!acc[ticket.owner_phone]) acc[ticket.owner_phone] = [];
            acc[ticket.owner_phone].push(ticket);
        }
        return acc;
    }, {});

    for (const dividend of activeDividends) {
        if (updatedWinners[dividend.name]) continue;

        let winnersThisTurn = [];
        
        for (const ticket of soldTickets) {
            if (!ticket.numbers || !Array.isArray(ticket.numbers) || ticket.numbers.length &lt; 3) continue;
            
            let isWinner = false;
            let winningPatternNumbers = [];
            const checkPattern = (numbers) =&gt; {
                winningPatternNumbers = numbers;
                return check(numbers);
            };
            
            const [r1, r2, r3] = ticket.numbers.map(row =&gt; row.filter(n =&gt; n &gt; 0));

            switch (dividend.name) {
                case &#34;Top Line&#34;:
                    if (r1.length &gt; 0 &amp;&amp; checkPattern(r1)) isWinner = true;
                    break;
                case &#34;Middle Line&#34;:
                    if (r2.length &gt; 0 &amp;&amp; checkPattern(r2)) isWinner = true;
                    break;
                case &#34;Bottom Line&#34;:
                    if (r3.length &gt; 0 &amp;&amp; checkPattern(r3)) isWinner = true;
                    break;
                case &#34;Corners (4)&#34;:
                    const corners = [r1[0], r1[r1.length - 1], r3[0], r3[r3.length - 1]].filter(Boolean);
                    if (corners.length === 4 &amp;&amp; checkPattern(corners)) isWinner = true;
                    break;
                case &#34;Star&#34;:
                    const midNumR2 = r2.length === 5 ? r2[2] : null;
                    if (r1.length === 5 &amp;&amp; midNumR2 &amp;&amp; r3.length === 5) {
                        const starNumbers = [r1[0], r1[4], midNumR2, r3[0], r3[4]].filter(Boolean);
                        if(starNumbers.length === 5 &amp;&amp; checkPattern(starNumbers)) isWinner = true;
                    }
                    break;
                case &#34;First Full House&#34;:
                case &#34;Second Full House&#34;:
                case &#34;Third Full House&#34;:
                    const housefullWinnersData = Object.values(updatedWinners).flat().filter(w =&gt; w.dividendName?.includes(&#34;Full House&#34;));
                    const housefullWinnerTicketIds = housefullWinnersData.map(w =&gt; w.ticketId);
                    const allTicketNumbers = r1.concat(r2, r3);

                    if (checkPattern(allTicketNumbers) &amp;&amp; !housefullWinnerTicketIds.includes(ticket.id)) {
                        const claimedPrizesCount = Object.keys(updatedWinners).filter(key =&gt; key.includes(&#34;Full House&#34;)).length;
                        
                        if ((dividend.name === &#34;First Full House&#34; &amp;&amp; claimedPrizesCount === 0) ||
                            (dividend.name === &#34;Second Full House&#34; &amp;&amp; claimedPrizesCount === 1) ||
                            (dividend.name === &#34;Third Full House&#34; &amp;&amp; claimedPrizesCount === 2)) {
                            isWinner = true;
                        }
                    }
                    break;
                default:
                    if (dividend.name.startsWith(&#34;Early&#34;) || dividend.name.startsWith(&#34;Quick&#34;)) {
                        const count = parseInt(dividend.name.match(/\d+/)[0], 10);
                        if (countMarked(ticket) === count) {
                            isWinner = true;
                            winningPatternNumbers = (ticket.numbers || []).flat().filter(n =&gt; n &gt; 0 &amp;&amp; calledNumbers.includes(n)).slice(0, count);
                        }
                    }
                    break;
            }
            if (isWinner &amp;&amp; winningPatternNumbers.includes(lastCalledNumber)) {
                winnersThisTurn.push({ name: ticket.owner_name, phone: ticket.owner_phone, ticketId: ticket.id, winningNumber: lastCalledNumber, won_at: firebase.database.ServerValue.TIMESTAMP, dividendName: dividend.name });
            }
        }

        if (dividend.name === &#39;Full Sheet Bonus&#39; || dividend.name === &#39;Half Sheet Bonus&#39;) {
            for (const ownerPhone in ticketsByOwner) {
                const ownerTickets = ticketsByOwner[ownerPhone];
                const ticketsBySheet = ownerTickets.reduce((acc, ticket) =&gt; {
                    const sheetNum = Math.floor((ticket.id - 1) / 6);
                    if (!acc[sheetNum]) acc[sheetNum] = [];
                    acc[sheetNum].push(ticket);
                    return acc;
                }, {});

                for (const sheetNum in ticketsBySheet) {
                    const sheetTickets = ticketsBySheet[sheetNum];
                    if (dividend.name === &#39;Full Sheet Bonus&#39; &amp;&amp; sheetTickets.length === 6) {
                        if (sheetTickets.every(t =&gt; countMarked(t) &gt;= 2) &amp;&amp; sheetTickets.some(t =&gt; (t.numbers || []).flat().includes(lastCalledNumber))) {
                            const fullSheetTicketIds = sheetTickets.map(t =&gt; t.id).sort((a,b)=&gt;a-b);
                            winnersThisTurn.push({ 
                                name: sheetTickets[0].owner_name, 
                                phone: ownerPhone, 
                                ticketId: `Full Sheet (${fullSheetTicketIds.join(&#39;,&#39;)})`, 
                                winningNumber: lastCalledNumber, 
                                won_at: firebase.database.ServerValue.TIMESTAMP, 
                                dividendName: dividend.name 
                            });
                        }
                    } else if (dividend.name === &#39;Half Sheet Bonus&#39;) {
                        const sheetTicketIds = new Set(sheetTickets.map(t =&gt; t.id));
                        const sheetStartId = parseInt(sheetNum) * 6 + 1;
                        
                        const firstHalfIds = [sheetStartId, sheetStartId + 1, sheetStartId + 2];
                        const secondHalfIds = [sheetStartId + 3, sheetStartId + 4, sheetStartId + 5];

                        let winnerFoundInSheet = false;

                        if (firstHalfIds.every(id =&gt; sheetTicketIds.has(id))) {
                            const halfSheetTickets = sheetTickets.filter(t =&gt; firstHalfIds.includes(t.id));
                            if (halfSheetTickets.every(t =&gt; countMarked(t) &gt;= 2) &amp;&amp; halfSheetTickets.some(t =&gt; (t.numbers || []).flat().includes(lastCalledNumber))) {
                                winnersThisTurn.push({
                                    name: halfSheetTickets[0].owner_name,
                                    phone: ownerPhone,
                                    ticketId: `Half Sheet (${firstHalfIds.join(&#39;,&#39;)})`,
                                    winningNumber: lastCalledNumber,
                                    won_at: firebase.database.ServerValue.TIMESTAMP,
                                    dividendName: dividend.name
                                });
                                winnerFoundInSheet = true;
                            }
                        }

                        if (!winnerFoundInSheet &amp;&amp; secondHalfIds.every(id =&gt; sheetTicketIds.has(id))) {
                            const halfSheetTickets = sheetTickets.filter(t =&gt; secondHalfIds.includes(t.id));
                            if (halfSheetTickets.every(t =&gt; countMarked(t) &gt;= 2) &amp;&amp; halfSheetTickets.some(t =&gt; (t.numbers || []).flat().includes(lastCalledNumber))) {
                                winnersThisTurn.push({
                                    name: halfSheetTickets[0].owner_name,
                                    phone: ownerPhone,
                                    ticketId: `Half Sheet (${secondHalfIds.join(&#39;,&#39;)})`,
                                    winningNumber: lastCalledNumber,
                                    won_at: firebase.database.ServerValue.TIMESTAMP,
                                    dividendName: dividend.name
                                });
                            }
                        }
                    }
                }
            }
        }


        if (winnersThisTurn.length &gt; 0) {
            updatedWinners[dividend.name] = winnersThisTurn;
        }
    }
    return updatedWinners;
}

async function generateHousieTickets(bypassConfirm = false) {
    const totalTicketsStr = document.getElementById(&#39;totalTicketInp&#39;).value;
    if (!totalTicketsStr) return showNotification(&#34;Please enter the total number of tickets.&#34;, &#39;error&#39;);
    const totalTickets = parseInt(totalTicketsStr, 10);
    if (isNaN(totalTickets) || totalTickets &lt;= 0) return showNotification(&#34;Please enter a valid number of tickets.&#34;, &#39;error&#39;);
    if (totalTickets % 6 !== 0) return showNotification(&#39;Total tickets must be a multiple of 6.&#39;, &#39;error&#39;);
    if (!bypassConfirm &amp;&amp; !confirm(`This will DELETE ALL existing tickets and generate ${totalTickets} new ones. Are you sure?`)) return;

    showNotification(`Generating ${totalTickets} new tickets... This may take a moment.`, &#39;info&#39;);
    await triggerGlobalNotification(&#39;Admin is generating new tickets...&#39;, &#39;info&#39;);

    try {
        await db.ref(&#39;/tickets&#39;).set(null); 
        setTimeout(async () =&gt; {
            const newTicketsObject = {};
            const numSets = totalTickets / 6;

            for (let i = 0; i &lt; numSets; i++) {
                const currentSet = createTambolaSetOf6();
                for (let j = 0; j &lt; 6; j++) {
                    const ticketId = i * 6 + j + 1;
                    newTicketsObject[ticketId] = {
                        id: ticketId,
                        numbers: currentSet[j],
                        is_sold: false,
                        owner_name: null, owner_name_lower: null, owner_phone: null, agent_uid: null
                    };
                }
            }
            await db.ref(&#39;/tickets&#39;).set(newTicketsObject);
            const successMsg = `${totalTickets} new tickets generated successfully!`;
            showNotification(successMsg, &#39;success&#39;);
            await triggerGlobalNotification(successMsg, &#39;success&#39;);
        }, 50);

    } catch (e) {
        showNotification(&#34;Error generating tickets: &#34; + e.message, &#39;error&#39;);
    }
}

const shuffleArray = (arr) =&gt; {
    for (let i = arr.length - 1; i &gt; 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
};

function createTambolaSetOf6() {
    const columnCellCountsPerTicket = [
        [1, 2, 1, 2, 1, 2, 2, 2, 2], [1, 1, 2, 1, 2, 2, 2, 2, 2],
        [1, 1, 2, 2, 2, 1, 2, 3, 1], [2, 2, 1, 2, 1, 2, 1, 1, 3],
        [2, 2, 2, 1, 2, 1, 2, 1, 2], [2, 2, 2, 2, 2, 2, 1, 1, 1]
    ];

    const ticketLayouts = [];
    for (let ticketIndex = 0; ticketIndex &lt; 6; ticketIndex++) {
        const layout = Array(3).fill(0).map(() =&gt; Array(9).fill(0));
        const ticketColumnCount = columnCellCountsPerTicket[ticketIndex];
        for (let colIndex = 0; colIndex &lt; 9; colIndex++) {
            const numCellsInCol = ticketColumnCount[colIndex];
            const rowsToPlaceIn = shuffleArray([0, 1, 2]).slice(0, numCellsInCol);
            for (const rowIndex of rowsToPlaceIn) {
                layout[rowIndex][colIndex] = 1;
            }
        }
        let isBalanced = false;
        while (!isBalanced) {
            const rowCounts = layout.map(row =&gt; row.reduce((sum, cell) =&gt; sum + cell, 0));
            if (rowCounts.every(count =&gt; count === 5)) {
                isBalanced = true;
                continue;
            }
            const overfullRowIndex = rowCounts.findIndex(count =&gt; count &gt; 5);
            const underfullRowIndex = rowCounts.findIndex(count =&gt; count &lt; 5);
            const swappableCols = [];
            for (let colIndex = 0; colIndex &lt; 9; colIndex++) {
                if (layout[overfullRowIndex][colIndex] === 1 &amp;&amp; layout[underfullRowIndex][colIndex] === 0) {
                    swappableCols.push(colIndex);
                }
            }
            if (swappableCols.length &gt; 0) {
                const colToSwap = swappableCols[Math.floor(Math.random() * swappableCols.length)];
                layout[overfullRowIndex][colToSwap] = 0;
                layout[underfullRowIndex][colToSwap] = 1;
            }
        }
        ticketLayouts.push(layout);
    }

    const numberPools = [
        shuffleArray(Array.from({ length: 9 }, (_, i) =&gt; i + 1)),
        shuffleArray(Array.from({ length: 10 }, (_, i) =&gt; i + 10)),
        shuffleArray(Array.from({ length: 10 }, (_, i) =&gt; i + 20)),
        shuffleArray(Array.from({ length: 10 }, (_, i) =&gt; i + 30)),
        shuffleArray(Array.from({ length: 10 }, (_, i) =&gt; i + 40)),
        shuffleArray(Array.from({ length: 10 }, (_, i) =&gt; i + 50)),
        shuffleArray(Array.from({ length: 10 }, (_, i) =&gt; i + 60)),
        shuffleArray(Array.from({ length: 10 }, (_, i) =&gt; i + 70)),
        shuffleArray(Array.from({ length: 11 }, (_, i) =&gt; i + 80))
    ];

    const finalTickets = Array(6).fill(0).map(() =&gt; Array(3).fill(0).map(() =&gt; Array(9).fill(0)));
    for (let colIndex = 0; colIndex &lt; 9; colIndex++) {
        for (let ticketIndex = 0; ticketIndex &lt; 6; ticketIndex++) {
            for (let rowIndex = 0; rowIndex &lt; 3; rowIndex++) {
                if (ticketLayouts[ticketIndex][rowIndex][colIndex] === 1) {
                    finalTickets[ticketIndex][rowIndex][colIndex] = numberPools[colIndex].pop();
                }
            }
        }
    }

    for (let ticketIndex = 0; ticketIndex &lt; 6; ticketIndex++) {
        for (let colIndex = 0; colIndex &lt; 9; colIndex++) {
            const columnValues = [];
            for (let rowIndex = 0; rowIndex &lt; 3; rowIndex++) {
                if (finalTickets[ticketIndex][rowIndex][colIndex] !== 0) {
                    columnValues.push(finalTickets[ticketIndex][rowIndex][colIndex]);
                }
            }
            columnValues.sort((a, b) =&gt; a - b);
            
            let valueIndex = 0;
            for (let rowIndex = 0; rowIndex &lt; 3; rowIndex++) {
                if (finalTickets[ticketIndex][rowIndex][colIndex] !== 0) {
                    finalTickets[ticketIndex][rowIndex][colIndex] = columnValues[valueIndex++];
                }
            }
        }
    }

    
    return finalTickets;
}

function createListPDF(title, headers, dataRows, filename) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text(title, 105, 15, { align: &#39;center&#39; });
    doc.setFontSize(10);
    doc.text(new Date().toLocaleString(), 105, 22, { align: &#39;center&#39; });

    const startY = 35;
    const colPositions = [15, 40, 120]; 

    doc.setFontSize(12);
    doc.setFont(undefined, &#39;bold&#39;);
    headers.forEach((header, i) =&gt; {
        doc.text(header, colPositions[i], startY);
    });

    doc.setFontSize(10);
    doc.setFont(undefined, &#39;normal&#39;);
    let y = startY + 7;

    dataRows.forEach(row =&gt; {
        if (y &gt; 280) { 
            doc.addPage();
            y = 15;
        }
        row.forEach((cell, i) =&gt; {
            doc.text(String(cell), colPositions[i], y);
        });
        y += 7;
    });

    doc.save(filename);
}

async function downloadPreviousGameTicketList() {
    try {
        const snapshot = await db.ref(&#39;lastGame/tickets&#39;).once(&#39;value&#39;);
        const prevTicketsObject = snapshot.val();
        
        if (!prevTicketsObject || Object.keys(prevTicketsObject).length === 0) {
            return showNotification(&#39;No archived ticket data found.&#39;, &#39;info&#39;);
        }

        const prevTickets = Object.values(prevTicketsObject);
        const usersSnapshot = await db.ref(&#39;users&#39;).once(&#39;value&#39;);
        const users = usersSnapshot.val();
        const userMap = new Map(Object.entries(users || {}).map(([uid, data]) =&gt; [uid, data]));

        const dataRows = prevTickets.map(ticket =&gt; {
            const agent = ticket.agent_uid ? userMap.get(ticket.agent_uid) : null;
            const agentName = agent ? agent.name : &#39;Direct/Admin&#39;;
            return [ticket.id, ticket.owner_name, agentName];
        });

        createListPDF(
            &#39;Previous Game - Sold Tickets&#39;,
            [&#39;Ticket ID&#39;, &#39;Owner Name&#39;, &#39;Booked By&#39;],
            dataRows,
            &#39;Previous-Game-Tickets.pdf&#39;
        );

    } catch (e) {
        showNotification(&#39;Error downloading previous ticket list: &#39; + e.message, &#39;error&#39;);
    }
}

function downloadCurrentSoldTickets() {
    const soldTickets = allTicketsData.filter(t =&gt; t.is_sold);
    if (soldTickets.length === 0) {
        return showNotification(&#39;No tickets have been sold in the current game yet.&#39;, &#39;info&#39;);
    }

    const userMap = new Map(allUsersData.map(u =&gt; [u.uid, u]));

    const dataRows = soldTickets.map(ticket =&gt; {
        const agent = ticket.agent_uid ? userMap.get(ticket.agent_uid) : null;
        const agentName = agent ? agent.name : &#39;Direct/Admin&#39;;
        return [ticket.id, ticket.owner_name, agentName];
    });

    createListPDF(
        &#39;Current Game - Sold Tickets&#39;,
        [&#39;Ticket ID&#39;, &#39;Owner Name&#39;, &#39;Booked By&#39;],
        dataRows,
        &#39;Current-Sold-Tickets.pdf&#39;
    );
}

async function downloadTicketAsPDF(ticketId) {
    const { jsPDF } = window.jspdf;
    const ticketData = allTicketsData.find(t =&gt; t.id === ticketId);
    if (!ticketData) return showNotification(&#39;Ticket data not found.&#39;, &#39;error&#39;);

    const doc = new jsPDF();
    const cellWidth = 20;
    const cellHeight = 15;
    const startX = 15;
    const startY = 20;

    doc.setFontSize(16);
    doc.text(`Housie Ticket ${ticketData.id}`, startX, startY);
    if(ticketData.is_sold){
        doc.setFontSize(10);
        doc.text(`Owner: ${ticketData.owner_name} (${ticketData.owner_phone})`, startX, startY + 7);
    }

    doc.setFontSize(14);
    for (let row = 0; row &lt; 3; row++) {
        for (let col = 0; col &lt; 9; col++) {
            const x = startX + col * cellWidth;
            const y = startY + 15 + row * cellHeight;
            doc.rect(x, y, cellWidth, cellHeight);
            const num = ticketData.numbers[row][col];
            if (num &gt; 0) {
                doc.text(String(num), x + cellWidth / 2, y + cellHeight / 2, { align: &#39;center&#39;, baseline: &#39;middle&#39; });
            }
        }
    }

    doc.save(`Housie-Ticket-${ticketId}.pdf`);
    showNotification(`Downloading PDF for ticket ${ticketId}.`, &#39;success&#39;);
}

async function downloadWinnersPDF() {
    if (Object.keys(knownWinners).length === 0) {
        showNotification(&#34;No winners to download yet.&#34;, &#34;info&#34;);
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text(&#34;Housie Game - Winners List&#34;, 105, 15, { align: &#39;center&#39; });
    doc.setFontSize(10);
    doc.text(new Date().toLocaleString(), 105, 20, { align: &#39;center&#39; });

    const tableData = Object.entries(knownWinners).flatMap(([dividend, winnerArray]) =&gt; 
        winnerArray.map(winner =&gt; [
            dividend,
            winner.name,
            String(winner.ticketId)
        ])
    );
    
    let y = 35;
    doc.setFontSize(12);
    doc.setFont(undefined, &#39;bold&#39;);
    doc.text(&#34;Dividend&#34;, 15, y);
    doc.text(&#34;Winner Name&#34;, 80, y);
    doc.text(&#34;Ticket ID&#34;, 150, y);
    doc.setFont(undefined, &#39;normal&#39;);
    y += 7;

    tableData.forEach(row =&gt; {
        doc.text(row[0], 15, y);
        doc.text(row[1], 80, y);
        doc.text(row[2], 150, y);
        y += 7;
        if (y &gt; 280) {
            doc.addPage();
            y = 15;
        }
    });

    doc.save(&#34;Housie-Winners.pdf&#34;);
}

function updateRunGameUI(gameState) {
    if(document.getElementById(&#39;runGameWindowDiv&#39;).classList.contains(&#39;active&#39;)){
        const isRunning = gameState.isGameRunning || false;
        document.getElementById(&#39;callStatusInp&#39;).value = isRunning ? &#39;on&#39; : &#39;off&#39;;
    }
}

function searchTicketAdmin() {
    const searchTerm = document.getElementById(&#39;adminTicketSearchInp&#39;).value.trim();
    if (!searchTerm) return;
    
    let ticketsToDisplay = [];
    const searchNumber = parseInt(searchTerm, 10);

    if (!isNaN(searchNumber) &amp;&amp; searchTerm.toString().match(/^\d+$/)) {
        const initialTicket = allTicketsData.find(t =&gt; t.id === searchNumber &amp;&amp; t.is_sold);
        if (initialTicket) {
            ticketsToDisplay = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp; t.owner_phone === initialTicket.owner_phone);
        }
    } else {
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        ticketsToDisplay = allTicketsData.filter(t =&gt; t.is_sold &amp;&amp;
            ((t.owner_name_lower || &#39;&#39;).includes(lowerCaseSearchTerm) || (t.owner_phone || &#39;&#39;).includes(lowerCaseSearchTerm))
        );
    }
    
    if (ticketsToDisplay.length &gt; 0) {
        const ownerPhone = ticketsToDisplay[0].owner_phone;
        const ownerName = ticketsToDisplay[0].owner_name;

        if (adminDisplayedSearchPhones.has(ownerPhone)) {
            showNotification(`${ownerName}&#39;s tickets are already displayed.`, &#39;info&#39;);
            return;
        }
        adminDisplayedSearchPhones.add(ownerPhone);

        const groupWrapper = document.createElement(&#39;div&#39;);
        groupWrapper.className = &#39;sheet-view&#39;;
        groupWrapper.dataset.phone = ownerPhone;
        
        let ticketsHTML = &#39;&#39;;
        ticketsToDisplay.sort((a, b) =&gt; a.id - b.id).forEach(ticket =&gt; {
       
        
            let gridHTML;
            if (ticket &amp;&amp; Array.isArray(ticket.numbers) &amp;&amp; ticket.numbers.length &gt; 0) {
                 gridHTML = ticket.numbers.flat().map(n =&gt;
                    `&lt;div class=&#34;ticket-num ${n &gt; 0 ? &#39;&#39; : &#39;empty&#39;}&#34; data-num=&#34;${n}&#34;&gt;${n &gt; 0 ? n : &#39;&#39;}&lt;/div&gt;`
                ).join(&#39;&#39;);
            } else {
                gridHTML = &#39;&lt;p style=&#34;text-align:center; padding: 1rem; color: red;&#34;&gt;Visual data missing.&lt;/p&gt;&#39;;
            }
            
            ticketsHTML += `&lt;div class=&#34;ticket-view&#34; data-ticket-id=&#34;${ticket.id}&#34;&gt;
                        &lt;div class=&#34;ticket-header&#34;&gt;Ticket ${ticket.id}&lt;/div&gt;
                        &lt;div class=&#34;ticket-grid&#34;&gt;${gridHTML}&lt;/div&gt;
                    &lt;/div&gt;`;
        });
        
        groupWrapper.innerHTML = `
            &lt;div class=&#34;sheet-header&#34; style=&#34;position: relative; padding-right: 30px;&#34;&gt;
                &lt;span&gt;${ownerName} - ${ownerPhone}&lt;/span&gt;
                &lt;button class=&#34;clear-search-btn&#34; style=&#34;background: #e74c3c;&#34; onclick=&#34;clearAdminSearchResult(&#39;${ownerPhone}&#39;)&#34; title=&#34;Clear this result&#34;&gt;&amp;times;&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class=&#34;sheet-content&#34;&gt;${ticketsHTML}&lt;/div&gt;`;
            
        document.getElementById(&#39;adminTicketDisplayArea&#39;).prepend(groupWrapper);
        updateAdminDisplayedTickets();
    } else {
        showNotification(&#39;No tickets found for that search term.&#39;, &#39;error&#39;);
    }
}

function clearAdminSearchResult(phone) {
    const group = document.querySelector(`#adminTicketDisplayArea .sheet-view[data-phone=&#34;${phone}&#34;]`);
    if (group) group.remove();
    adminDisplayedSearchPhones.delete(phone);
}

function updateAdminDisplayedTickets() {
    document.querySelectorAll(&#39;#adminTicketDisplayArea .ticket-view&#39;).forEach(ticketView =&gt; {
        ticketView.querySelectorAll(&#39;.ticket-num[data-num]&#39;).forEach(cell =&gt; {
            const num = parseInt(cell.dataset.num, 10);
            if (num &gt; 0) {
                const isCalled = currentCalledNumbers.includes(num);
                cell.classList.toggle(&#39;ticked&#39;, isCalled);
                cell.classList.remove(&#39;last-called-highlight&#39;);
                if (num === lastAnnouncedNumber) {
                    cell.classList.add(&#39;last-called-highlight&#39;);
                }
            }
        });
    });
}

// --- NEW: Audio Control Functions ---
async function handleMusicUpload() {
    const fileInput = document.getElementById(&#39;bgMusicUpload&#39;);
    const file = fileInput.files[0];
    if (!file) return showNotification(&#39;Please select an MP3 file first.&#39;, &#39;error&#39;);
    if (file.type !== &#34;audio/mpeg&#34;) return showNotification(&#39;Only MP3 files are allowed.&#39;, &#39;error&#39;);

    showNotification(`Uploading &#39;${file.name}&#39;...`, &#39;info&#39;, 10000);
    const reader = new FileReader();
    reader.onload = async (event) =&gt; {
        const base64String = event.target.result;
        try {
            const newTrackRef = db.ref(&#39;settings/audio/musicLibrary&#39;).push();
            await newTrackRef.set({
                id: newTrackRef.key,
                type: &#39;mp3&#39;,
                name: file.name,
                url: base64String
            });
            showNotification(`&#39;${file.name}&#39; uploaded successfully.`, &#39;success&#39;);
            fileInput.value = &#39;&#39;; // Reset file input
        } catch (e) {
            showNotification(&#39;Error uploading music: &#39; + e.message, &#39;error&#39;);
        }
    };
    reader.onerror = () =&gt; showNotification(&#39;Error reading file.&#39;, &#39;error&#39;);
    reader.readAsDataURL(file);
}

async function handleStreamingUrl() {
    const urlInput = document.getElementById(&#39;streamingUrlInp&#39;);
    const url = urlInput.value.trim();
    if (!url) return showNotification(&#39;Please enter a streaming URL.&#39;, &#39;error&#39;);
    try {
        new URL(url); // Basic validation
    } catch (_) {
        return showNotification(&#39;Invalid URL format.&#39;, &#39;error&#39;);
    }
    
    try {
        const newTrackRef = db.ref(&#39;settings/audio/musicLibrary&#39;).push();
        await newTrackRef.set({
            id: newTrackRef.key,
            type: &#39;stream&#39;,
            name: url.substring(url.lastIndexOf(&#39;/&#39;) + 1) || &#39;Streaming Link&#39;,
            url: url
        });
        showNotification(&#39;Streaming URL added to playlist.&#39;, &#39;success&#39;);
        urlInput.value = &#39;&#39;;
    } catch(e) {
        showNotification(&#39;Error adding URL: &#39; + e.message, &#39;error&#39;);
    }
}

async function playTrack(trackId) {
    if (!trackId || !audioLibrary[trackId]) return;
    try {
        // When a new track is played, reset the start time for synchronization
        const updates = {
            currentTrackId: trackId,
            playbackStartTime: firebase.database.ServerValue.TIMESTAMP
        };
        await db.ref(&#39;settings/audio&#39;).update(updates);
        showNotification(`Now playing: ${audioLibrary[trackId].name}`, &#39;info&#39;);
    } catch(e) {
        showNotification(&#39;Error setting track: &#39; + e.message, &#39;error&#39;);
    }
}

async function deleteTrack(trackId) {
    if (!trackId || !audioLibrary[trackId]) return;
    if (!confirm(`Are you sure you want to delete &#34;${audioLibrary[trackId].name}&#34;?`)) return;
    try {
        const updates = {
            [`musicLibrary/${trackId}`]: null
        };
        if (currentTrackId === trackId) {
            updates.currentTrackId = null;
            updates.musicState = &#39;off&#39;; // Turn off music if the current track is deleted
            updates.playbackStartTime = null;
        }
        await db.ref(&#39;settings/audio&#39;).update(updates);
        showNotification(&#39;Track deleted.&#39;, &#39;success&#39;);
    } catch (e) {
        showNotification(&#39;Error deleting track: &#39; + e.message, &#39;error&#39;);
    }
}

function renderMusicPlaylist() {
    const dashboardContainer = document.getElementById(&#39;musicPlaylist&#39;);
    const popupContainer = document.getElementById(&#39;popupMusicPlaylist&#39;);

    const renderTo = (container) =&gt; {
        if (!container) return;
        if (Object.keys(audioLibrary).length === 0) {
            container.innerHTML = `&lt;p style=&#34;text-align: center; color: var(--muted-color-dash); padding: 1rem;&#34;&gt;No music uploaded. Use the controls to add songs.&lt;/p&gt;`;
            return;
        }
        
        container.innerHTML = Object.values(audioLibrary).map(track =&gt; `
            &lt;div class=&#34;playlist-item ${track.id === currentTrackId ? &#39;playing&#39; : &#39;&#39;}&#34;&gt;
                &lt;div class=&#34;playlist-item-name&#34;&gt;${track.name}&lt;/div&gt;
                &lt;div class=&#34;playlist-item-actions&#34;&gt;
                    &lt;button title=&#34;Play this track for everyone&#34; onclick=&#34;playTrack(&#39;${track.id}&#39;)&#34;&gt;&lt;i class=&#34;fas fa-play-circle&#34;&gt;&lt;/i&gt;&lt;/button&gt;
                    &lt;button title=&#34;Delete this track&#34; onclick=&#34;deleteTrack(&#39;${track.id}&#39;)&#34;&gt;&lt;i class=&#34;fas fa-trash-alt&#34;&gt;&lt;/i&gt;&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        `).join(&#39;&#39;);
    };

    renderTo(dashboardContainer);
    renderTo(popupContainer);
}


function toggleBgMusic() {
    const state = document.getElementById(&#39;bgMusicState&#39;).value;
    const updates = {
        musicState: state
    };
    if (state === &#39;on&#39; &amp;&amp; !currentTrackId &amp;&amp; Object.keys(audioLibrary).length &gt; 0) {
        // If turning on and no track is selected, play the first one
        const firstTrackId = Object.keys(audioLibrary)[0];
        updates.currentTrackId = firstTrackId;
        updates.playbackStartTime = firebase.database.ServerValue.TIMESTAMP;
    } else if (state === &#39;on&#39;) {
        updates.playbackStartTime = firebase.database.ServerValue.TIMESTAMP;
    }
    else {
        updates.playbackStartTime = null;
    }
    db.ref(&#39;settings/audio&#39;).update(updates)
        .then(() =&gt; showNotification(`Background music turned ${state.toUpperCase()}.`, &#39;info&#39;))
        .catch(e =&gt; showNotification(&#39;Error updating music state: &#39; + e.message, &#39;error&#39;));
}

function togglePlaylistMode() {
    const state = document.getElementById(&#39;playlistModeState&#39;).value;
    db.ref(&#39;settings/audio/playlistMode&#39;).set(state)
        .then(() =&gt; showNotification(`Playlist mode is now ${state.toUpperCase()}.`, &#39;info&#39;))
        .catch(e =&gt; showNotification(&#39;Error updating playlist mode: &#39; + e.message, &#39;error&#39;));
}

async function toggleMic() {
    if (isMicOn) {
        if (mediaRecorder &amp;&amp; mediaRecorder.state === &#34;recording&#34;) mediaRecorder.stop();
        if (localStream) localStream.getTracks().forEach(track =&gt; track.stop());
        document.getElementById(&#39;micToggleBtn&#39;).classList.remove(&#39;live&#39;);
        document.getElementById(&#39;micToggleBtn&#39;).innerHTML = &#39;&lt;i class=&#34;fas fa-microphone-slash&#34;&gt;&lt;/i&gt; Toggle Mic&#39;;
        isMicOn = false;
        await db.ref(&#39;settings/audio/liveAnnouncement&#39;).set({ isLive: false });
        showNotification(&#39;Live announcement stopped.&#39;, &#39;info&#39;);
    } else {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const options = { mimeType: &#39;audio/webm;codecs=opus&#39; };
            mediaRecorder = new MediaRecorder(localStream, options);

            mediaRecorder.ondataavailable = event =&gt; {
                if (event.data.size &gt; 0) {
                    const reader = new FileReader();
                    reader.onload = () =&gt; {
                        db.ref(&#39;settings/audio/liveAnnouncement&#39;).update({
                           audioChunk: reader.result,
                           timestamp: firebase.database.ServerValue.TIMESTAMP 
                        });
                    };
                    reader.readAsDataURL(event.data);
                }
            };
            
            mediaRecorder.onstart = () =&gt; db.ref(&#39;settings/audio/liveAnnouncement&#39;).set({ isLive: true, isNewStream: true, timestamp: firebase.database.ServerValue.TIMESTAMP });
            mediaRecorder.start(1500); // Chunk every 1.5 seconds

            document.getElementById(&#39;micToggleBtn&#39;).classList.add(&#39;live&#39;);
            document.getElementById(&#39;micToggleBtn&#39;).innerHTML = &#39;&lt;i class=&#34;fas fa-microphone&#34;&gt;&lt;/i&gt; Mic is LIVE&#39;;
            isMicOn = true;
            showNotification(&#39;Live announcement started!&#39;, &#39;success&#39;);
        } catch (err) {
            showNotification(&#39;Could not access microphone: &#39; + err.message, &#39;error&#39;);
            console.error(err);
        }
    }
}

function handleBackgroundMusicState(audioData) {
    const musicState = audioData.musicState || &#39;off&#39;;
    const playlistMode = audioData.playlistMode || &#39;off&#39;;
    const trackId = audioData.currentTrackId;
    const track = trackId ? audioData.musicLibrary?.[trackId] : null;
    const playbackStartTime = audioData.playbackStartTime || 0;

    if (document.getElementById(&#39;bgMusicState&#39;)) {
        document.getElementById(&#39;bgMusicState&#39;).value = musicState;
    }
    if (document.getElementById(&#39;playlistModeState&#39;)) {
        document.getElementById(&#39;playlistModeState&#39;).value = playlistMode;
    }

    backgroundMusicPlayer.loop = (playlistMode === &#39;off&#39;);

    if (musicState === &#39;on&#39; &amp;&amp; track &amp;&amp; track.url &amp;&amp; playbackStartTime &gt; 0) {
        const hasSourceChanged = backgroundMusicPlayer.src !== track.url;
        if (hasSourceChanged) {
            backgroundMusicPlayer.src = track.url;
        }

        const serverTime = getEstimatedServerTime();
        const elapsedTime = (serverTime - playbackStartTime) / 1000;
        
        const seekAndPlay = () =&gt; {
            if (Math.abs(backgroundMusicPlayer.currentTime - elapsedTime) &gt; 1.5) { 
                 backgroundMusicPlayer.currentTime = elapsedTime % backgroundMusicPlayer.duration;
            }
             if (backgroundMusicPlayer.paused) {
                 backgroundMusicPlayer.play().catch(e =&gt; {});
             }
        };

        if(backgroundMusicPlayer.readyState &gt;= 2) { // HAVE_CURRENT_DATA
            seekAndPlay();
        } else {
            backgroundMusicPlayer.addEventListener(&#39;canplay&#39;, seekAndPlay, { once: true });
        }

    } else {
        if (!backgroundMusicPlayer.paused) {
            backgroundMusicPlayer.pause();
        }
    }
}


function handleLiveAudioStream(audioData) {
    const liveInfo = audioData.liveAnnouncement;
    if (liveInfo &amp;&amp; liveInfo.isLive &amp;&amp; liveInfo.audioChunk &amp;&amp; liveInfo.timestamp &gt; lastProcessedTimestamp) {
        
        if (liveInfo.isNewStream &amp;&amp; mediaSource &amp;&amp; mediaSource.readyState === &#39;open&#39;) {
             console.log(&#34;New live stream detected, resetting buffer.&#34;);
             audioQueue = [];
             if (sourceBuffer &amp;&amp; !sourceBuffer.updating) {
                try {
                    sourceBuffer.remove(0, sourceBuffer.buffered.length &gt; 0 ? sourceBuffer.buffered.end(0) : 0);
                } catch(e) { console.warn(&#34;Buffer clear failed, might be empty&#34;, e); }
             }
             db.ref(&#39;settings/audio/liveAnnouncement/isNewStream&#39;).set(null); // Mark as processed
        }

        lastProcessedTimestamp = liveInfo.timestamp;
        
        if (liveAudioPlayer.paused) {
            liveAudioPlayer.play().catch(e =&gt; {});
        }
        
        audioQueue.push(liveInfo.audioChunk);
        processAudioQueue();
    } else if (liveInfo &amp;&amp; !liveInfo.isLive) {
        // If live stream is off, fade out the audio
        let vol = liveAudioPlayer.volume;
        if (vol &gt; 0) {
            const fadeOutInterval = setInterval(() =&gt; {
                vol -= 0.1;
                if (vol &lt;= 0) {
                    liveAudioPlayer.volume = 0;
                    liveAudioPlayer.pause();
                    liveAudioPlayer.volume = 1; // Reset for next time
                    clearInterval(fadeOutInterval);
                } else {
                    liveAudioPlayer.volume = vol;
                }
            }, 50);
        }
    }
}

async function processAudioQueue() {
    if (isAppending || audioQueue.length === 0 || !sourceBuffer || sourceBuffer.updating) {
        return;
    }
    isAppending = true;
    
    const dataUrl = audioQueue.shift();
    try {
        const response = await fetch(dataUrl);
        const arrayBuffer = await response.arrayBuffer();
        sourceBuffer.appendBuffer(arrayBuffer);
    } catch (error) {
        console.error(&#39;Error processing audio chunk:&#39;, error);
        isAppending = false; 
    }
}

function initializeMediaSource() {
    if (&#39;MediaSource&#39; in window) {
        mediaSource = new MediaSource();
        liveAudioPlayer.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener(&#39;sourceopen&#39;, () =&gt; {
            try {
                const mimeCodec = &#39;audio/webm; codecs=&#34;opus&#34;&#39;;
                if (MediaSource.isTypeSupported(mimeCodec)) {
                    sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
                    sourceBuffer.addEventListener(&#39;updateend&#39;, () =&gt; {
                        isAppending = false;
                        processAudioQueue(); 
                    });
                    isMediaSourceOpen = true;
                } else {
                    console.error(&#39;Unsupported MIME type:&#39;, mimeCodec);
                }
            } catch (e) {
                console.error(&#39;Exception while creating SourceBuffer:&#39;, e);
            }
        });
    } else {
        console.error(&#39;MediaSource API not supported in this browser.&#39;);
        showNotification(&#39;Live audio streaming may not work on this browser.&#39;, &#39;error&#39;);
    }
}

function playNextInPlaylist() {
    if (!currentTrackId || Object.keys(audioLibrary).length &lt; 2) return;
    
    const trackIds = Object.keys(audioLibrary);
    const currentIndex = trackIds.indexOf(currentTrackId);
    
    if (currentIndex !== -1) {
        const nextIndex = (currentIndex + 1) % trackIds.length;
        const nextTrackId = trackIds[nextIndex];
        playTrack(nextTrackId);
    }
}

document.addEventListener(&#39;DOMContentLoaded&#39;, () =&gt; {
    backgroundMusicPlayer = document.getElementById(&#39;backgroundMusicPlayer&#39;);
    liveAudioPlayer = document.getElementById(&#39;liveAudioPlayer&#39;);
    
    initializeMediaSource();

    document.getElementById(&#39;micToggleBtn&#39;).addEventListener(&#39;click&#39;, toggleMic);
    document.getElementById(&#39;musicUploadBtn&#39;).addEventListener(&#39;click&#39;, handleMusicUpload);
    document.getElementById(&#39;setStreamingUrlBtn&#39;).addEventListener(&#39;click&#39;, handleStreamingUrl);

    backgroundMusicPlayer.addEventListener(&#39;ended&#39;, () =&gt; {
        const playlistMode = document.getElementById(&#39;playlistModeState&#39;)?.value || &#39;off&#39;;
        if (playlistMode === &#39;on&#39; &amp;&amp; currentUserRole === &#39;admin&#39;) {
            playNextInPlaylist();
        }
    });

    generateNumberBoard();
    bindEventListeners();
    gsap.to(&#39;.top-header, .bottom-nav, .panel&#39;, { y: 0, opacity: 1, duration: 1.2, stagger: 0.1, ease: &#34;expo.out&#34; });

    setTimeout(() =&gt; {
        showPopup(&#39;firstVisitPopup&#39;);
    }, 1500);
});
    </script>
    <script>
      (function(){
    function _0x1a3c(_0x12, _0x34){return _0x1a3c=_0x34?function(_0x56){return _0x56.toString(36)}:function(_0x56){return _0x56};return _0x1a3c(_0x12,_0x34);}
    document[&#39;addEventListener&#39;](&#39;contextmenu&#39;,function(_0x1){_0x1[&#39;preventDefault&#39;]();});
    document[&#39;addEventListener&#39;](&#39;keydown&#39;,function(_0x2){
        if(_0x2[&#39;key&#39;]===&#39;F12&#39;){_0x2[&#39;preventDefault&#39;]();}
        if((_0x2[&#39;ctrlKey&#39;]&amp;&amp;_0x2[&#39;shiftKey&#39;]&amp;&amp;[&#39;I&#39;,&#39;J&#39;,&#39;C&#39;][&#39;includes&#39;](_0x2[&#39;key&#39;][&#39;toUpperCase&#39;]()))||
           (_0x2[&#39;ctrlKey&#39;]&amp;&amp;[&#39;U&#39;,&#39;S&#39;][&#39;includes&#39;](_0x2[&#39;key&#39;][&#39;toUpperCase&#39;]()))){
            _0x2[&#39;preventDefault&#39;]();
        }
    });
})();
    </script>
  </body>
</html>
